<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Console MJ Pro - Presta'Puce</title>
    <link rel="icon" id="page-favicon" type="image/png" href="https://static.wixstatic.com/media/eda9e4_e7ab6af2d5a7428f9bc7e4af454e20ef~mv2.png">
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-storage-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root { --mj-color: #2ecc71; --bg-color: #1a1a1a; --card-bg: #2c3e50; --text-color: #ffffff; --danger: #e74c3c; --accent: #f1c40f; --blue: #3498db; --gold: #f39c12; }
        body { background: var(--bg-color); color: white; font-family: 'Segoe UI', sans-serif; margin: 0; padding: 20px; }
        .box { max-width: 400px; margin: 80px auto 40px auto; background: var(--card-bg); padding: 30px; border-radius: 15px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
        input, select { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1); box-sizing: border-box; background: #1a1a1a; color: white; font-size: 1rem; outline: none; margin-bottom: 15px; }
        input:disabled { opacity: 0.5; cursor: not-allowed; }
        button { background: var(--mj-color); color: white; padding: 14px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; width: 100%; transition: 0.1s; text-transform: uppercase; margin-bottom: 10px; position: relative; top: 0; box-shadow: 0 4px rgba(0,0,0,0.3); }
        button:hover:not(:disabled) { opacity: 0.9; }
        button:active:not(:disabled) { top: 2px; box-shadow: 0 2px rgba(0,0,0,0.3); }
        button:disabled { background: #7f8c8d !important; cursor: not-allowed; top: 0; box-shadow: none; opacity: 0.6; }
        .dashboard { display: none; max-width: 800px; margin: 80px auto 40px auto; }
        .room-info { background: var(--accent); color: black; padding: 10px; border-radius: 10px; font-weight: bold; text-align: center; margin-bottom: 10px; font-size: 1.2rem; }
        .crest-picker { display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px; margin: 10px 0; background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px; max-height: 150px; overflow-y: auto; }
        .crest-wrapper { background: white; padding: 4px; border-radius: 6px; display: flex; align-items: center; justify-content: center; cursor: pointer; border: 3px solid transparent; }
        .crest-selected { border-color: var(--accent) !important; background: var(--accent) !important; transform: scale(1.1); }
        .crest-opt { width: 30px; height: 30px; object-fit: contain; }
        .current-player { background: var(--card-bg); padding: 20px; border-radius: 15px; border: 4px solid var(--accent); margin: 20px 0; text-align: center; display: none; }
        .action-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        .team-item { display: flex; align-items: center; background: rgba(255,255,255,0.1); padding: 10px; border-radius: 8px; margin-bottom: 8px; justify-content: space-between; }
        .score-row { display: flex; align-items: center; justify-content: space-between; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px; margin-bottom: 5px; }
        .crest-mini-bg { background: white; padding: 2px; border-radius: 4px; display: inline-flex; margin: 0 5px; vertical-align: middle; }
        .crest-mini { width: 22px; height: 22px; object-fit: contain; }
        .btn-icon { cursor: pointer; font-weight: bold; font-size: 1.1rem; margin-left: 10px; transition: 0.2s; }
        .btn-edit { color: var(--blue); }
        .btn-del { color: var(--danger); }
        .player-controls { display: flex; align-items: center; gap: 5px; }
        .mini-select { width: auto; padding: 5px; font-size: 0.8rem; background: #34495e; color: white; border: 1px solid rgba(255,255,255,0.2); border-radius: 4px; margin-bottom: 0; }
        .lobby-btn { width: 30px; height: 30px; padding: 0; margin: 0; font-size: 1rem; line-height: 30px; display: inline-flex; align-items: center; justify-content: center; box-shadow: 0 2px rgba(0,0,0,0.3); border:none; border-radius:4px; color:white; }
        .lobby-btn:active { top: 1px; box-shadow: 0 1px rgba(0,0,0,0.3); }
        .show-pass-container { display: flex; align-items: center; gap: 10px; margin-bottom: 20px; font-size: 0.9rem; cursor: pointer; text-align: left; width: 100%; padding-left: 5px; }
        .show-pass-container input { width: 18px; height: 18px; margin: 0; cursor: pointer; flex-shrink: 0; }
        .upload-zone { margin: 10px 0; padding: 10px; border: 2px dashed var(--mj-color); border-radius: 8px; text-align: center; background: rgba(0,0,0,0.2); transition: 0.2s; }
        .upload-zone:hover { background: rgba(46, 204, 113, 0.1); }
    </style>
</head>
<body>

    <div id="global-mj-logo-container" style="display:none; position: fixed; top: 20px; left: 20px; z-index: 9999;">
        <img id="global-mj-logo" src="https://static.wixstatic.com/media/eda9e4_e7ab6af2d5a7428f9bc7e4af454e20ef~mv2.png" onclick="toggleProfile()" style="width:60px; height:60px; object-fit:contain; cursor:pointer; border-radius:10px; box-shadow: 0 4px 10px rgba(0,0,0,0.5); background:var(--card-bg); transition: transform 0.2s;" title="Ouvrir / Fermer Mon Profil">
    </div>

    <div id="screen-login" class="box">
        <img id="login-mj-logo" src="https://static.wixstatic.com/media/eda9e4_e7ab6af2d5a7428f9bc7e4af454e20ef~mv2.png" style="width:70px; margin-bottom:15px; border-radius: 10px;">
        <h2>Acc√®s MJ S√©curis√©</h2>
        <input type="email" id="mj-email" placeholder="Email MJ">
        <input type="password" id="mj-pass" placeholder="Mot de passe">
        <label class="show-pass-container">
            <input type="checkbox" onchange="document.getElementById('mj-pass').type = this.checked ? 'text' : 'password'"> Afficher le mot de passe
        </label>
        <button id="btn-login-submit" onclick="login()">Se Connecter</button>
        <p onclick="forgotPassword()" style="color:var(--accent); cursor:pointer; font-size:0.8rem; text-decoration: underline; margin-top: 10px;">Mot de passe oubli√© ?</p>
    </div>

    <div id="screen-profile" class="box" style="display:none;">
        <h2 style="margin-bottom:20px;">Param√®tres MJ</h2>
        <input type="text" id="prof-nom" placeholder="Nom">
        <input type="text" id="prof-prenom" placeholder="Pr√©nom">
        <input type="email" id="prof-email" placeholder="Email" disabled style="color:#aaa;">
        <hr style="border:0; border-top:1px solid rgba(255,255,255,0.2); margin:15px 0;">
        <p style="margin:0 0 10px 0; font-size:0.8rem; color:var(--accent); text-align:left;">PERSONNALISATION</p>
        <div style="display:flex; gap:10px; margin-bottom:15px; align-items:center;">
            <img id="prof-logo-preview" src="" style="width:40px; height:40px; object-fit:contain; border-radius:5px; display:none; background:var(--card-bg); padding:2px;">
            <input type="text" id="prof-logo" placeholder="URL de votre Logo" style="margin-bottom:0; flex-grow:1;" oninput="updateLogoPreview(this.value)">
            <label for="prof-logo-upload" id="label-logo-upload" style="background:var(--mj-color); padding:10px 15px; border-radius:8px; cursor:pointer; display:flex; align-items:center; justify-content:center; font-size:1.2rem; box-shadow: 0 4px rgba(0,0,0,0.3); transition:0.2s; margin-bottom:0;" title="Uploader une image locale">üìÅ</label>
            <input type="file" id="prof-logo-upload" accept="image/*" style="display:none;" onchange="uploadProfileLogo(this)">
        </div>
        <input type="text" id="prof-link" placeholder="Lien de redirection au clic">
        <hr style="border:0; border-top:1px solid rgba(255,255,255,0.2); margin:15px 0;">
        <p style="margin:0 0 10px 0; font-size:0.8rem; color:var(--accent); text-align:left;">MOT DE PASSE (Optionnel)</p>
        <input type="password" id="prof-pass" placeholder="Nouveau mot de passe">
        <input type="password" id="prof-pass-conf" placeholder="Confirmer mot de passe">
        <label class="show-pass-container">
            <input type="checkbox" onchange="const t = this.checked ? 'text' : 'password'; document.getElementById('prof-pass').type = t; document.getElementById('prof-pass-conf').type = t;"> Afficher le mot de passe
        </label>
        <button id="btn-save-profile" onclick="saveProfile()" style="background:var(--mj-color); margin-top:10px;">üíæ ENREGISTRER</button>
        <button onclick="closeProfile()" style="background:var(--danger);">Retour</button>
    </div>

    <div id="screen-choice" class="box" style="display:none;">
        <h2>Bonjour <span id="mj-display-name" style="color:var(--accent);">MJ</span> !</h2>
        <button onclick="createNewRoom()" style="margin-top:15px;">üÜï Cr√©er une nouvelle salle</button>
        <button id="btn-resume" onclick="resumeRoom()" style="display:none; background:var(--blue)">üîÑ Reprendre la salle <span id="last-room-id"></span></button>
        <button onclick="auth.signOut().then(()=>location.reload())" style="background:none; border:1px solid rgba(255,255,255,0.3); font-size:0.8rem; margin-top:15px; width:auto; padding:8px 15px;">D√©connexion</button>
    </div>

    <div id="screen-dashboard" class="dashboard">
        <div class="room-info">SALLE : <span id="display-room">----</span></div>
        
        <div style="display:flex; justify-content:flex-end; gap:10px; margin-bottom: 15px;">
            <button onclick="openScoreBoard()" style="width: auto; background: #d35400; padding: 8px 15px; font-size: 0.8rem; box-shadow: 0 2px 5px rgba(0,0,0,0.5);">üì∫ Ouvrir √âcran</button>
            <button onclick="showRemoteQR()" style="width: auto; background: #8e44ad; padding: 8px 15px; font-size: 0.8rem; box-shadow: 0 2px 5px rgba(0,0,0,0.5);">üì± QR T√©l√©commande</button>
        </div>

        <div style="display:flex; gap:10px; margin-bottom:20px;">
            <button style="background:var(--blue); flex:1;" onclick="statusUpdate('ready')">Ouvrir Buzzers</button>
            <button style="background:var(--danger); flex:1;" onclick="fullReset()">RESET TITRE</button>
        </div>
        
        <div id="player-box" class="current-player">
            <div id="p-avatar" style="font-size:3.5rem; display:flex; justify-content:center; align-items:center;"></div>
            <h2 id="p-name" style="margin:5px 0;"></h2>
            <div id="p-team" style="display: flex; align-items: center; justify-content: center; gap: 5px; font-weight: bold; margin-bottom: 10px;"></div>
            <div class="action-grid">
                <button style="background:var(--gold)" onclick="handleReward(3, 'finish')">+3 (Termin√©)</button>
                <button style="background:var(--mj-color)" onclick="handleReward(1, 'finish')">+1 (Termin√©)</button>
                <button style="background:var(--blue)" onclick="handleReward(1, 'partial')">+1 (On continue)</button>
                <button style="background:var(--danger)" onclick="handleError()">Erreur</button>
            </div>
        </div>
        <div style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 12px; margin-top: 20px;">
            <h3>Gestion √âquipes</h3>
            <input type="text" id="t-name" placeholder="Nom de l'√©quipe..." oninput="checkTeamForm()">
            <div class="upload-zone">
                <label for="upload-logo" style="cursor:pointer; font-weight:bold; color:var(--mj-color); font-size:0.8rem;">
                    ‚ûï AJOUTER UN FICHIER IMAGE (BLASON)
                </label>
                <input type="file" id="upload-logo" accept="image/*" style="display:none;" onchange="uploadCustomTeamLogo(this)">
            </div>
            <div class="crest-picker" id="crest-grid"></div>
            <button id="btn-add-team" disabled onclick="addTeam()">Cr√©er l'√âquipe</button>
            <div id="mj-team-list-display"></div>
        </div>
        <h3>Lobby Joueurs</h3>
        <div id="score-list"></div>
        <div id="banned-section" style="display:none; margin-top:20px; padding: 15px; background: rgba(231, 76, 60, 0.1); border: 1px solid var(--danger); border-radius: 12px;">
            <h3 style="color:var(--danger); margin-top:0;">Joueurs Expuls√©s</h3>
            <div id="banned-list"></div>
        </div>
        <div style="margin-top:20px; padding: 15px; border: 2px solid var(--gold); border-radius: 12px; background: rgba(243, 156, 18, 0.1); text-align: center;">
            <h3 style="color:var(--gold); margin-top:0;">PODIUM & R√âSULTATS</h3>
            <button style="background: linear-gradient(to bottom, #f1c40f, #f39c12); color: black; font-size: 1.1rem;" onclick="triggerEndGame()">üèÅ Fin de partie</button>
        </div>
        <div style="margin-top:40px; border: 1px solid rgba(255,255,255,0.1); padding: 20px; border-radius: 12px;">
            <h3 style="color:var(--danger); margin-top:0;">Cl√¥turer la partie</h3>
            <button style="background:var(--blue);" onclick="quitRoom()">üö™ Quitter la salle (Conserver donn√©es)</button>
            <button style="background:var(--danger);" onclick="resetFullGame()">‚ö†Ô∏è SUPPRIMER LA SALLE (Effacer tout)</button>
        </div>
    </div>

    <div id="overlay-remote-qr" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:20000; flex-direction:column; align-items:center; justify-content:center;">
        <h2 style="color:white; margin-bottom:20px; text-transform:uppercase; color: #8e44ad;">T√©l√©commande Animateur</h2>
        <div id="qrcode-remote" style="background:white; padding:20px; border-radius:15px; box-shadow: 0 0 30px rgba(142, 68, 173, 0.5);"></div>
        <p style="color:#ccc; margin-top:15px; font-style:italic;">Scannez pour piloter depuis un mobile</p>
        <button onclick="document.getElementById('overlay-remote-qr').style.display='none'" style="margin-top:30px; width:auto; background:var(--danger); padding:10px 30px;">FERMER</button>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAf1Vl_O8SHJeFjHavKBJgUFGGy73I8t-o",
            authDomain: "prestapuce-buzz.firebaseapp.com",
            databaseURL: "https://prestapuce-buzz-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "prestapuce-buzz",
            storageBucket: "prestapuce-buzz.firebasestorage.app",
            messagingSenderId: "907270883505",
            appId: "1:907270883505:web:197efec0b99db28180ba90"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();
        const storage = firebase.storage();

        let roomID = "", roomRef = null, currentPlayer = null, selCrest = "", globalTeams = {}, lastSavedRoom = "";
        let allPlayersData = {}, currentBlocked = {}, editingTeamKey = null, mjProfileData = {};
        const defaultCrests = ["https://cdn-icons-png.flaticon.com/512/1165/1165187.png", "https://cdn-icons-png.flaticon.com/512/1165/1165220.png", "https://cdn-icons-png.flaticon.com/512/1165/1165191.png", "https://cdn-icons-png.flaticon.com/512/1165/1165207.png", "https://cdn-icons-png.flaticon.com/512/1065/1065545.png", "https://cdn-icons-png.flaticon.com/512/1065/1065549.png", "https://cdn-icons-png.flaticon.com/512/1065/1065553.png"];

        document.getElementById('mj-pass').addEventListener('keypress', (e) => { if (e.key === 'Enter') login(); });

        function login() {
            const email = document.getElementById('mj-email').value.trim();
            const pass = document.getElementById('mj-pass').value;
            if(!email || !pass) return;
            auth.signInWithEmailAndPassword(email, pass).then(res => { loadMjData(res.user); }).catch(e => { alert("Erreur connexion"); });
        }

        function forgotPassword() {
            const email = document.getElementById('mj-email').value.trim();
            if(!email) return alert("Veuillez saisir votre email pour r√©initialiser le mot de passe.");
            auth.sendPasswordResetEmail(email).then(() => { alert("Email de r√©initialisation envoy√© !"); }).catch(e => alert("Erreur : " + e.message));
        }

        function loadMjData(user) {
            db.ref('users/' + user.uid).once('value').then(snap => {
                const data = snap.val() || {};
                mjProfileData = data;
                if(mjProfileData.isGuest === true) { cleanGuestData(user.uid); }
                else {
                    document.getElementById('mj-display-name').innerText = data.prenom || "MJ";
                    updateLogos(data.customLogo);
                    checkUserRoom(user.uid);
                }
            });
        }

        function cleanGuestData(uid) {
            const updates = {};
            updates[`users/${uid}/lastRoom`] = null;
            updates[`users/${uid}/customLogos`] = null;
            db.ref().update(updates).then(() => {
                mjProfileData.lastRoom = "";
                mjProfileData.customLogos = {};
                document.getElementById('mj-display-name').innerText = mjProfileData.prenom || "MJ";
                updateLogos(mjProfileData.customLogo);
                checkUserRoom(uid);
            });
        }

        function checkUserRoom(uid) {
            db.ref('users/' + uid + '/lastRoom').once('value', snap => {
                document.getElementById('screen-login').style.display = "none";
                document.getElementById('screen-profile').style.display = "none";
                document.getElementById('screen-dashboard').style.display = "none";
                document.getElementById('screen-choice').style.display = "block";
                document.getElementById('global-mj-logo-container').style.display = "block";
                if(snap.exists() && snap.val() !== "") { 
                    lastSavedRoom = snap.val(); 
                    document.getElementById('btn-resume').style.display = "block"; 
                    document.getElementById('last-room-id').innerText = lastSavedRoom; 
                } else {
                    document.getElementById('btn-resume').style.display = "none";
                }
            });
        }

        let previousScreen = "screen-choice";
        function toggleProfile() {
            const profScreen = document.getElementById('screen-profile');
            if(profScreen.style.display === "block") closeProfile();
            else showProfile();
        }

        function updateLogoPreview(url) {
            const preview = document.getElementById('prof-logo-preview');
            if(url) { preview.src = url; preview.style.display = 'block'; }
            else { preview.style.display = 'none'; }
        }

        function showProfile() {
            if(document.getElementById('screen-choice').style.display === "block") previousScreen = "screen-choice";
            if(document.getElementById('screen-dashboard').style.display === "block") previousScreen = "screen-dashboard";
            document.getElementById('screen-choice').style.display = "none";
            document.getElementById('screen-dashboard').style.display = "none";
            document.getElementById('screen-profile').style.display = "block";
            const user = auth.currentUser;
            if(user) {
                document.getElementById('prof-email').value = user.email;
                document.getElementById('prof-nom').value = mjProfileData.nom || "";
                document.getElementById('prof-prenom').value = mjProfileData.prenom || "";
                const currentLogo = mjProfileData.customLogo || "";
                document.getElementById('prof-logo').value = currentLogo;
                updateLogoPreview(currentLogo);
                document.getElementById('prof-link').value = mjProfileData.customLink || "";
                document.getElementById('prof-pass').value = "";
                document.getElementById('prof-pass-conf').value = "";
                const isGuest = mjProfileData.isGuest === true;
                document.getElementById('prof-nom').disabled = isGuest;
                document.getElementById('prof-prenom').disabled = isGuest;
                document.getElementById('prof-logo').disabled = isGuest;
                document.getElementById('prof-link').disabled = isGuest;
                document.getElementById('prof-pass').disabled = isGuest; 
                document.getElementById('prof-pass-conf').disabled = isGuest; 
                document.getElementById('btn-save-profile').disabled = isGuest; 
                document.getElementById('label-logo-upload').style.display = isGuest ? 'none' : 'flex';
                let warnMsg = document.getElementById('guest-warning');
                if(isGuest) {
                    if(!warnMsg) {
                        warnMsg = document.createElement('div');
                        warnMsg.id = 'guest-warning';
                        warnMsg.style.background = 'rgba(241, 196, 15, 0.2)';
                        warnMsg.style.border = '1px solid var(--accent)';
                        warnMsg.style.padding = '10px';
                        warnMsg.style.borderRadius = '8px';
                        warnMsg.style.color = 'var(--accent)';
                        warnMsg.style.marginBottom = '15px';
                        warnMsg.innerHTML = "<b>üîí Mode D√©couverte</b><br><small>Personnalisation et changement de mot de passe d√©sactiv√©s.</small>";
                        document.getElementById('prof-nom').parentNode.insertBefore(warnMsg, document.getElementById('prof-nom'));
                    }
                } else if(warnMsg) warnMsg.remove();
            }
        }

        function closeProfile() {
            document.getElementById('screen-profile').style.display = "none";
            document.getElementById(previousScreen).style.display = "block";
        }

        function uploadProfileLogo(input) {
            if (!input.files || !input.files[0]) return;
            const file = input.files[0];
            const reader = new FileReader();
            const btnLabel = document.getElementById('label-logo-upload');
            const oldText = btnLabel.innerText;
            btnLabel.innerText = "‚è≥";
            reader.onloadend = function() {
                const base64String = reader.result;
                document.getElementById('prof-logo').value = base64String;
                updateLogoPreview(base64String);
                btnLabel.innerText = "‚úÖ";
                setTimeout(() => btnLabel.innerText = oldText, 2000);
            };
            reader.readAsDataURL(file);
        }

        function saveProfile() {
            if(mjProfileData.isGuest === true) { alert("Action impossible en Mode D√©couverte."); return; }
            const user = auth.currentUser;
            if(!user) return;
            const pass1 = document.getElementById('prof-pass').value;
            const pass2 = document.getElementById('prof-pass-conf').value;
            if(pass1 || pass2) {
                if(pass1 !== pass2) return alert("Les mots de passe ne correspondent pas.");
                user.updatePassword(pass1).then(() => {
                    alert("Mot de passe mis √† jour !");
                    document.getElementById('prof-pass').value = "";
                    document.getElementById('prof-pass-conf').value = "";
                }).catch(e => alert("Erreur de mot de passe : " + e.message));
            }
            const updates = {
                nom: document.getElementById('prof-nom').value.trim(),
                prenom: document.getElementById('prof-prenom').value.trim(),
                customLogo: document.getElementById('prof-logo').value.trim(),
                customLink: document.getElementById('prof-link').value.trim()
            };
            db.ref('users/' + user.uid).update(updates).then(() => {
                alert("Profil mis √† jour !");
                mjProfileData = { ...mjProfileData, ...updates }; 
                document.getElementById('mj-display-name').innerText = updates.prenom || "MJ";
                updateLogos(updates.customLogo);
                closeProfile();
            }).catch(e => alert("Erreur : " + e.message));
        }

        function updateLogos(url) {
            const finalUrl = url || "https://static.wixstatic.com/media/eda9e4_e7ab6af2d5a7428f9bc7e4af454e20ef~mv2.png";
            document.getElementById('global-mj-logo').src = finalUrl;
            document.getElementById('login-mj-logo').src = finalUrl;
            document.getElementById('page-favicon').href = finalUrl;
            if(roomRef && roomID) {
                roomRef.child('mjLogo').set(finalUrl);
                if(mjProfileData.customLink) roomRef.child('mjLink').set(mjProfileData.customLink);
            }
        }

        function createNewRoom() { 
            roomID = Math.floor(1000 + Math.random() * 9000).toString(); 
            db.ref('users/' + auth.currentUser.uid + '/lastRoom').set(roomID); 
            launchDashboard(roomID); 
        }

        function resumeRoom() { launchDashboard(lastSavedRoom); }

        function launchDashboard(id) {
            roomID = id; 
            document.getElementById('screen-choice').style.display = "none"; 
            document.getElementById('screen-dashboard').style.display = "block";
            document.getElementById('display-room').innerText = roomID;
            db.ref('activeRooms/' + roomID).set({ status: 'open' });
            roomRef = db.ref('roomsData/' + id);
            const currentLogo = mjProfileData.customLogo || "https://static.wixstatic.com/media/eda9e4_e7ab6af2d5a7428f9bc7e4af454e20ef~mv2.png";
            roomRef.child('mjLogo').set(currentLogo);
            if(mjProfileData.customLink) roomRef.child('mjLink').set(mjProfileData.customLink);
            roomRef.child('isGuestRoom').set(mjProfileData.isGuest === true);
            initMJLogic(); 
            loadCrestGrid();
            openScoreBoard(); // Ouvre automatiquement au lancement
        }

        // --- FONCTIONS OUTILS (ECRAN & REMOTE) ---
        
        function openScoreBoard() {
            if(!roomID) return;
            // Ouvre scores.html avec le roomID
            const currentUrl = window.location.href.split('?')[0];
            let basePath = currentUrl.substring(0, currentUrl.lastIndexOf('/'));
            const scoreUrl = basePath + "/scores.html?room=" + roomID;
            window.open(scoreUrl, '_blank');
        }

        function showRemoteQR() {
            const overlay = document.getElementById('overlay-remote-qr');
            const qrContainer = document.getElementById('qrcode-remote');
            
            // Construit lien Remote
            const currentUrl = window.location.href.split('?')[0];
            let basePath = currentUrl.substring(0, currentUrl.lastIndexOf('/'));
            let remoteUrl = basePath + "/remote.html?room=" + roomID;
            
            console.log("Lien Remote : ", remoteUrl);

            qrContainer.innerHTML = "";
            new QRCode(qrContainer, {
                text: remoteUrl,
                width: 250,
                height: 250
            });
            
            overlay.style.display = 'flex';
        }

        function uploadCustomTeamLogo(input) {
            if (!input.files || !input.files[0]) return;
            const file = input.files[0];
            const uid = auth.currentUser.uid;
            const storageRef = storage.ref(`mj_icons/${uid}/${Date.now()}_${file.name}`);
            storageRef.put(file).then(snapshot => snapshot.ref.getDownloadURL()).then(url => {
                db.ref(`users/${uid}/customLogos`).push(url);
                loadCrestGrid();
            }).catch(err => alert("Erreur upload blason"));
        }

        function loadCrestGrid() {
            const grid = document.getElementById('crest-grid');
            grid.innerHTML = "";
            const uid = auth.currentUser.uid;
            db.ref(`users/${uid}/customLogos`).once('value', snap => {
                snap.forEach(child => createCrestItem(child.val(), grid));
                defaultCrests.forEach(url => createCrestItem(url, grid));
            });
        }

        function createCrestItem(url, container) {
            const wrap = document.createElement('div'); 
            wrap.className = 'crest-wrapper';
            if (selCrest === url) wrap.classList.add('crest-selected');
            const img = document.createElement('img'); 
            img.src = url; img.className = 'crest-opt';
            wrap.onclick = () => { 
                document.querySelectorAll('.crest-wrapper').forEach(i=>i.classList.remove('crest-selected')); 
                wrap.classList.add('crest-selected'); 
                selCrest = url; checkTeamForm(); 
            };
            wrap.appendChild(img); container.appendChild(wrap);
        }

        function checkTeamForm() { 
            const name = document.getElementById('t-name').value.trim(); 
            document.getElementById('btn-add-team').disabled = !(name.length > 0 && selCrest !== ""); 
        }

        function editTeam(n) {
            const team = globalTeams[n];
            editingTeamKey = n;
            document.getElementById('t-name').value = n;
            selCrest = team.icon;
            document.getElementById('btn-add-team').innerText = "Modifier l'√âquipe";
            loadCrestGrid(); checkTeamForm();
        }

        function addTeam() { 
            const n = document.getElementById('t-name').value.trim(); 
            if(n && selCrest) { 
                if(mjProfileData.isGuest === true && !editingTeamKey && Object.keys(globalTeams).length >= 2) {
                    alert("üîí Limit√© √† 2 √©quipes en D√©couverte."); return;
                }
                if(editingTeamKey && editingTeamKey !== n) deleteTeam(editingTeamKey);
                roomRef.child('teams/' + n).set({ icon: selCrest }); 
                document.getElementById('t-name').value = ""; 
                selCrest = ""; editingTeamKey = null;
                document.getElementById('btn-add-team').innerText = "Cr√©er l'√âquipe";
                loadCrestGrid(); checkTeamForm(); 
            } 
        }
        
        function initMJLogic() {
            roomRef.child('buzzers').on('value', snap => {
                const buzzerData = snap.val(); const box = document.getElementById('player-box');
                if(buzzerData) { 
                    const pseudo = buzzerData.pseudo;
                    const realData = allPlayersData[pseudo] || buzzerData;
                    currentPlayer = realData; currentPlayer.pseudo = pseudo;
                    const avatarContainer = document.getElementById('p-avatar');
                    if(realData.avatar && realData.avatar.length > 20) avatarContainer.innerHTML = `<img src="${realData.avatar}" style="width:70px; height:70px; border-radius:50%; object-fit:cover;">`;
                    else avatarContainer.innerHTML = realData.avatar || 'üë§'; 
                    document.getElementById('p-name').innerText = pseudo; box.style.display = "block";
                    if(realData.teamName && realData.teamName !== "Solo") {
                        const iconUrl = globalTeams[realData.teamName] ? globalTeams[realData.teamName].icon : realData.teamIcon;
                        document.getElementById('p-team').innerHTML = `<div class="crest-mini-bg"><img src="${iconUrl}" class="crest-mini"></div><span>${realData.teamName}</span>`;
                    } else document.getElementById('p-team').innerHTML = "Solo"; 
                } else box.style.display = "none"; 
            });
            roomRef.child('teams').on('value', snap => { globalTeams = snap.val() || {}; renderLobby(); });
            roomRef.child('scores').on('value', snap => { allPlayersData = snap.val() || {}; renderLobby(); });
            roomRef.child('blockedPlayers').on('value', snap => { currentBlocked = snap.val() || {}; renderLobby(); });
        }

        function renderLobby() {
            const l = document.getElementById('score-list'); l.innerHTML = "";
            const tList = document.getElementById('mj-team-list-display'); tList.innerHTML = "";
            const bSection = document.getElementById('banned-section');
            const bList = document.getElementById('banned-list'); bList.innerHTML = "";
            let hasBanned = false;
            Object.keys(globalTeams).forEach(tKey => {
                tList.innerHTML += `<div class="team-item"><span><div class="crest-mini-bg"><img src="${globalTeams[tKey].icon}" class="crest-mini"></div> <b>${tKey}</b></span><div><span class="btn-icon btn-edit" onclick="editTeam('${tKey}')">‚úé</span><span class="btn-icon btn-del" onclick="deleteTeam('${tKey}')">‚úñ</span></div></div>`;
            });
            Object.keys(allPlayersData).forEach(pseudo => {
                const d = allPlayersData[pseudo]; 
                if(d.kicked === true) {
                    hasBanned = true;
                    bList.innerHTML += `<div class="team-item" style="border: 1px solid var(--danger); justify-content: space-between;"><span style="color:var(--danger)"><b>${pseudo}</b></span><button style="background:var(--mj-color); width:auto; padding:5px 15px; margin:0; font-size:0.8rem;" onclick="unkickPlayer('${pseudo}')">R√©habiliter</button></div>`;
                    return; 
                }
                if(d.active === false) return; 
                let teamOptions = `<option value="Solo" ${d.teamName === "Solo" ? "selected" : ""}>Solo</option>`;
                Object.keys(globalTeams).forEach(t => { teamOptions += `<option value="${t}" ${d.teamName === t ? "selected" : ""}>${t}</option>`; });
                const isBlocked = currentBlocked[pseudo];
                const blockBtnStyle = isBlocked ? "background:var(--danger); color:white; border:none;" : "background:transparent; border:1px solid var(--danger); opacity:0.6;";
                let avHtml = (d.avatar && d.avatar.length > 20) ? `<img src="${d.avatar}" style="width:30px; height:30px; border-radius:50%; object-fit:cover; margin-right:8px;">` : `<span style="font-size:1.2rem; margin-right:8px;">${d.avatar || 'üë§'}</span>`;
                l.innerHTML += `<div class="score-row"><div style="display:flex; align-items:center; flex:1; overflow:hidden;">${avHtml}<b style="margin-right:10px;">${pseudo}</b><select class="mini-select" onchange="togglePlayerTeam('${pseudo}', this.value)">${teamOptions}</select></div><div class="player-controls"><span>(${d.pts || 0} pts)</span><button class="lobby-btn" style="background:var(--accent); color:black; border:none; margin:0 2px;" onclick="forceBuzzer('${pseudo}')">‚ö°</button><button class="lobby-btn" style="${blockBtnStyle} margin:0 2px;" onclick="toggleBlockPlayer('${pseudo}')">üõë</button><button class="lobby-btn" style="background:var(--blue); margin-left: 5px;" onclick="adj('${pseudo}',-1)">-</button><button class="lobby-btn" style="background:var(--mj-color)" onclick="adj('${pseudo}',1)">+</button><button class="lobby-btn" style="background:var(--danger)" onclick="kickPlayer('${pseudo}')">‚úñ</button></div></div>`;
            });
            bSection.style.display = hasBanned ? "block" : "none";
        }

        function forceBuzzer(pseudo) {
            const pData = allPlayersData[pseudo];
            if(!pData) return;
            roomRef.child('gameState').update({ status: 'taken' });
            roomRef.child('buzzers').set({ pseudo: pseudo, avatar: pData.avatar || "", teamName: pData.teamName || "Solo", teamIcon: pData.teamIcon || "" });
        }

        function toggleBlockPlayer(pseudo) {
            if(currentBlocked[pseudo]) roomRef.child('blockedPlayers/' + pseudo).remove(); 
            else roomRef.child('blockedPlayers/' + pseudo).set(true); 
        }

        function triggerEndGame() {
            if(mjProfileData.isGuest === true) {
                if(confirm("Fin de partie ? Les scores vont √™tre fig√©s sur l'√©cran d'affichage.")) {
                    roomRef.child('gameState').set({ status: 'endGame', timestamp: Date.now() });
                    roomRef.child('buzzers').remove();
                }
            } else {
                if(confirm("Voulez-vous figer les scores et enregistrer l'historique ?")) {
                    const uid = auth.currentUser.uid;
                    const historyData = { date: new Date().toLocaleString('fr-FR'), roomID: roomID, scores: allPlayersData, teams: globalTeams };
                    db.ref(`users/${uid}/history`).push(historyData).then(() => {
                        roomRef.child('gameState').set({ status: 'endGame', timestamp: Date.now() });
                        roomRef.child('buzzers').remove(); alert("Partie archiv√©e !");
                    });
                }
            }
        }

        function statusUpdate(st) { if(roomRef) { roomRef.child('gameState').set({ status: st }); if(st === 'ready') roomRef.child('buzzers').remove(); } }
        function fullReset() { roomRef.child('blockedPlayers').remove(); roomRef.child('buzzers').remove(); statusUpdate('waiting'); }
        function adj(p, v) { roomRef.child('scores/'+p+'/pts').transaction(x => (x||0)+v); }
        function deleteTeam(n) { roomRef.child('teams/' + n).remove(); }
        function kickPlayer(p) { 
            if(confirm("Expulser " + p + " ?")) {
                roomRef.child('scores/' + p).update({ kicked: true }).then(() => {
                    setTimeout(() => { roomRef.child('scores/' + p).update({ active: false }); }, 1500);
                });
            }
        }
        function unkickPlayer(p) { roomRef.child('scores/' + p).update({ kicked: false, active: false }); }
        function togglePlayerTeam(pseudo, choice) {
            const icon = (choice === "Solo") ? "" : (globalTeams[choice] ? globalTeams[choice].icon : "");
            roomRef.child('scores/' + pseudo).update({ teamName: choice, teamIcon: icon, active: true });
        }
        function handleError() { if(currentPlayer && currentPlayer.pseudo) { roomRef.child('blockedPlayers/' + currentPlayer.pseudo).set(true); statusUpdate('ready'); } }
        function handleReward(pts, mode) {
            roomRef.child('scores/' + currentPlayer.pseudo).transaction(c => { return { pts: (c ? c.pts : 0) + pts, avatar: c.avatar, teamName: c.teamName, teamIcon: c.teamIcon, active: true }; });
            if(mode === 'partial') { roomRef.child('blockedPlayers/' + currentPlayer.pseudo).set(true); statusUpdate('ready'); } else { fullReset(); }
        }

        function quitRoom() {
            if(mjProfileData.isGuest === true) resetFullGame(); 
            else {
                if(roomRef) roomRef.child('buzzers').off();
                checkUserRoom(auth.currentUser.uid);
            }
        }

        function resetFullGame() {
            if(confirm("‚ö†Ô∏è Supprimer la salle et ses donn√©es ?")) {
                roomRef.remove();
                db.ref('activeRooms/' + roomID).remove();
                db.ref('users/' + auth.currentUser.uid + '/lastRoom').remove().then(() => {
                    lastSavedRoom = ""; checkUserRoom(auth.currentUser.uid); 
                });
            }
        }
    </script>
</body>
</html>
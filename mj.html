<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Console MJ Pro - Presta'Puce</title>
    <link rel="icon" type="image/png" href="https://static.wixstatic.com/media/eda9e4_e7ab6af2d5a7428f9bc7e4af454e20ef~mv2.png">
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-storage-compat.js"></script>
    <style>
        :root { --mj-color: #2ecc71; --bg-color: #1a1a1a; --card-bg: #2c3e50; --text-color: #ffffff; --danger: #e74c3c; --accent: #f1c40f; --blue: #3498db; --gold: #f39c12; }
        body { background: var(--bg-color); color: white; font-family: 'Segoe UI', sans-serif; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; box-sizing: border-box; }
        .screen { display: none; width: 100%; max-width: 600px; text-align: center; }
        .active { display: block; }
        .card { background: var(--card-bg); padding: 20px; border-radius: 15px; box-shadow: 0 10px 20px rgba(0,0,0,0.3); margin-bottom: 20px; }
        h1 { color: var(--mj-color); margin-bottom: 30px; }
        input { width: 100%; padding: 12px; margin: 10px 0; border-radius: 8px; border: none; font-size: 1rem; box-sizing: border-box; }
        button { width: 100%; padding: 15px; margin: 10px 0; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; transition: 0.2s; font-size: 1rem; }
        .btn-mj { background: var(--mj-color); color: white; }
        .btn-blue { background: var(--blue); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .player-item { display: flex; align-items: center; justify-content: space-between; background: rgba(255,255,255,0.1); padding: 10px 15px; border-radius: 8px; margin-bottom: 8px; }
        .buzzer-alert { background: var(--danger); padding: 20px; border-radius: 15px; margin-top: 20px; animation: blink 0.5s infinite alternate; }
        @keyframes blink { from { opacity: 1; } to { opacity: 0.7; } }
        .team-btn { padding: 5px 10px; margin: 2px; font-size: 0.8rem; border-radius: 5px; border: none; cursor: pointer; }
    </style>
</head>
<body>

    <div id="screen-login" class="screen active">
        <h1>Admin Blind Test</h1>
        <div class="card">
            <input type="email" id="email" placeholder="Email">
            <input type="password" id="password" placeholder="Mot de passe">
            <button class="btn-mj" onclick="login()">CONNEXION</button>
        </div>
    </div>

    <div id="screen-choice" class="screen">
        <h1>Gestion Salle</h1>
        <div class="card">
            <button class="btn-mj" onclick="createNewRoom()">CRÃ‰ER NOUVELLE SALLE</button>
            <div id="btn-resume" style="display:none; margin-top:20px; border-top:1px solid rgba(255,255,255,0.1); padding-top:20px;">
                <p>Ancienne salle dÃ©tectÃ©e : <b id="last-room-id"></b></p>
                <button class="btn-blue" onclick="resumeRoom()">REPRENDRE LA SALLE</button>
            </div>
        </div>
    </div>

    <div id="screen-dashboard" class="screen">
        <div class="card" style="display:flex; justify-content: space-between; align-items: center;">
            <h2 style="margin:0;">SALLE : <span id="display-room-id" style="color:var(--accent)">-</span></h2>
            <button class="btn-danger" style="width:auto; padding:8px 15px; margin:0;" onclick="quitRoom()">QUITTER</button>
        </div>

        <div id="buzzer-zone" class="buzzer-alert" style="display:none;">
            <h2 id="buzzer-name">JOUEUR !!</h2>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <button style="background:white; color:black;" onclick="handleReward(1, 'full')">VRAI (+1)</button>
                <button style="background:black; color:white;" onclick="handleReward(0, 'partial')">FAUX (Bloquer)</button>
            </div>
        </div>

        <div class="card" style="margin-top:20px;">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <button id="btn-status" class="btn-mj" onclick="toggleStatus()">OUVRIR BUZZERS</button>
                <button class="btn-danger" onclick="fullReset()">RESET BUZZERS</button>
            </div>
            <button class="btn-blue" onclick="statusUpdate('endGame')">FIN DE PARTIE / PODIUM</button>
        </div>

        <div class="card">
            <h3>Joueurs ConnectÃ©s</h3>
            <div id="player-list"></div>
        </div>

        <button class="btn-danger" style="opacity:0.5; font-size:0.8rem;" onclick="resetFullGame()">SUPPRIMER LA SALLE DÃ‰FINITIVEMENT</button>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAf1Vl_O8SHJeFjHavKBJgUFGGy73I8t-o",
            authDomain: "prestapuce-buzz.firebaseapp.com",
            databaseURL: "https://prestapuce-buzz-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "prestapuce-buzz",
            storageBucket: "prestapuce-buzz.firebasestorage.app",
            messagingSenderId: "907270883505",
            appId: "1:907270883505:web:197efec0b99db28180ba90"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();

        let roomID = null, roomRef = null, lastSavedRoom = "", currentPlayer = null, gameState = 'waiting';
        const globalTeams = { "Team A": { icon: "ðŸ”´" }, "Team B": { icon: "ðŸ”µ" }, "Team C": { icon: "ðŸŸ¢" } };

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function login() {
            const e = document.getElementById('email').value;
            const p = document.getElementById('password').value;
            auth.signInWithEmailAndPassword(e, p)
                .then(user => checkUserRoom(user.user.uid))
                .catch(err => alert("Erreur : " + err.message));
        }

        function checkUserRoom(uid) {
            db.ref('users/' + uid + '/lastRoom').once('value', snap => {
                showScreen('screen-choice');
                if(snap.exists() && snap.val() !== "") { 
                    lastSavedRoom = snap.val(); 
                    document.getElementById('btn-resume').style.display = "block"; 
                    document.getElementById('last-room-id').innerText = lastSavedRoom; 
                } else {
                    document.getElementById('btn-resume').style.display = "none";
                }
            });
        }

        function createNewRoom() { 
            roomID = Math.floor(1000 + Math.random() * 9000).toString(); 
            db.ref('users/' + auth.currentUser.uid + '/lastRoom').set(roomID); 
            launchDashboard(roomID); 
        }

        function resumeRoom() { launchDashboard(lastSavedRoom); }

        function launchDashboard(id) {
            roomID = id;
            roomRef = db.ref('roomsData/' + id);
            db.ref('activeRooms/' + id).set(true);

            // Construction propre de l'URL pour l'onglet des scores
            const loc = window.location;
            const path = loc.pathname.substring(0, loc.pathname.lastIndexOf('/'));
            const scoreURL = loc.origin + path + "/scores.html?room=" + id;
            
            // Ouverture de l'onglet (Autoriser les pop-ups si nÃ©cessaire)
            window.open(scoreURL, '_blank');

            // Mise Ã  jour visuelle du MJ
            document.getElementById('display-room-id').innerText = id;
            showScreen('screen-dashboard');
            
            setupRoomListeners();
        }

        function setupRoomListeners() {
            roomRef.child('gameState').on('value', snap => {
                gameState = snap.val() ? snap.val().status : 'waiting';
                const btn = document.getElementById('btn-status');
                if(gameState === 'ready') { btn.innerText = "BLOQUER BUZZERS"; btn.style.background = "var(--danger)"; }
                else { btn.innerText = "OUVRIR BUZZERS"; btn.style.background = "var(--mj-color)"; }
            });

            roomRef.child('buzzers').on('value', snap => {
                const b = document.getElementById('buzzer-zone');
                if(snap.exists()) {
                    currentPlayer = snap.val();
                    document.getElementById('buzzer-name').innerText = (currentPlayer.teamIcon || "") + " " + currentPlayer.pseudo;
                    b.style.display = "block";
                } else { b.style.display = "none"; currentPlayer = null; }
            });

            roomRef.child('scores').on('value', snap => {
                const list = document.getElementById('player-list');
                list.innerHTML = "";
                const scores = snap.val() || {};
                Object.entries(scores).forEach(([pseudo, data]) => {
                    if(data.active === false) return;
                    const div = document.createElement('div');
                    div.className = "player-item";
                    div.innerHTML = `
                        <span>${data.avatar || "ðŸ‘¤"} <b>${pseudo}</b> (${data.pts || 0} pts)</span>
                        <div>
                            <button class="team-btn" onclick="setPlayerTeam('${pseudo}', 'Solo')">Solo</button>
                            <button class="team-btn" style="background:red; color:white;" onclick="setPlayerTeam('${pseudo}', 'Team A')">A</button>
                            <button class="team-btn" style="background:blue; color:white;" onclick="setPlayerTeam('${pseudo}', 'Team B')">B</button>
                            <button class="team-btn" style="background:green; color:white;" onclick="setPlayerTeam('${pseudo}', 'Team C')">C</button>
                        </div>
                    `;
                    list.appendChild(div);
                });
            });
        }

        function toggleStatus() {
            const next = (gameState === 'ready') ? 'waiting' : 'ready';
            statusUpdate(next);
        }

        function statusUpdate(s) { roomRef.child('gameState').set({ status: s }); }

        function fullReset() { roomRef.child('buzzers').remove(); roomRef.child('blockedPlayers').remove(); statusUpdate('waiting'); }

        function setPlayerTeam(pseudo, choice) {
            if(choice === "Solo") { roomRef.child('scores/' + pseudo).update({ teamName: "Solo", teamIcon: "" });
            } else { roomRef.child('scores/' + pseudo).update({ teamName: choice, teamIcon: globalTeams[choice].icon }); }
        }

        function handleReward(pts, mode) {
            roomRef.child('scores/' + currentPlayer.pseudo).transaction(c => {
                if(!c) return c;
                return { ...c, pts: (c.pts || 0) + pts };
            });
            if(mode === 'partial') { roomRef.child('blockedPlayers/' + currentPlayer.pseudo).set(true); } 
            else { fullReset(); }
        }

        function quitRoom() {
            if(roomRef) { roomRef.child('buzzers').off(); roomRef.child('scores').off(); roomRef.child('gameState').off(); }
            showScreen('screen-choice');
        }

        function resetFullGame() {
            if(confirm("âš ï¸ SUPPRIMER LA SALLE DEFINITIVEMENT ?")) {
                roomRef.remove();
                db.ref('activeRooms/' + roomID).remove();
                db.ref('users/' + auth.currentUser.uid + '/lastRoom').remove().then(() => location.reload());
            }
        }
    </script>
</body>
</html>
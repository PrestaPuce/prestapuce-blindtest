<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Console MJ Pro - Presta'Puce</title>
    <link rel="icon" type="image/png" href="https://static.wixstatic.com/media/eda9e4_e7ab6af2d5a7428f9bc7e4af454e20ef~mv2.png">
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-storage-compat.js"></script>
    <style>
        :root { --mj-color: #2ecc71; --bg-color: #1a1a1a; --card-bg: #2c3e50; --text-color: #ffffff; --danger: #e74c3c; --accent: #f1c40f; --blue: #3498db; --gold: #f39c12; }
        body { background: var(--bg-color); color: white; font-family: 'Segoe UI', sans-serif; margin: 0; padding: 20px; }
        .box { max-width: 400px; margin: 60px auto; background: var(--card-bg); padding: 30px; border-radius: 15px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
        input, select { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1); box-sizing: border-box; background: #1a1a1a; color: white; font-size: 1rem; outline: none; margin-bottom: 15px; }
        button { background: var(--mj-color); color: white; padding: 14px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; width: 100%; transition: 0.2s; text-transform: uppercase; margin-bottom: 10px; }
        .dashboard, .profil-panel { display: none; max-width: 800px; margin: 0 auto; }
        .room-info { background: var(--accent); color: black; padding: 10px; border-radius: 10px; font-weight: bold; text-align: center; margin-bottom: 20px; font-size: 1.2rem; }
        .crest-picker { display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px; margin: 10px 0; background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px; max-height: 150px; overflow-y: auto; }
        .crest-wrapper { background: white; padding: 4px; border-radius: 6px; display: flex; align-items: center; justify-content: center; cursor: pointer; border: 3px solid transparent; }
        .crest-selected { border-color: var(--accent) !important; background: var(--accent) !important; transform: scale(1.1); }
        .crest-opt { width: 30px; height: 30px; object-fit: contain; }
        .current-player { background: var(--card-bg); padding: 20px; border-radius: 15px; border: 4px solid var(--accent); margin: 20px 0; text-align: center; display: none; }
        .action-grid { display: grid; grid-template-columns: 1fr; gap: 10px; margin-top: 15px; }
        .team-item { display: flex; align-items: center; background: rgba(255,255,255,0.1); padding: 10px; border-radius: 8px; margin-bottom: 8px; justify-content: space-between; }
        .score-row { display: flex; align-items: center; justify-content: space-between; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px; margin-bottom: 5px; }
        .crest-mini-bg { background: white; padding: 2px; border-radius: 4px; display: inline-flex; margin: 0 5px; vertical-align: middle; }
        .crest-mini { width: 22px; height: 22px; object-fit: contain; }
        .btn-icon { cursor: pointer; font-weight: bold; font-size: 1.1rem; margin-left: 10px; transition: 0.2s; }
        .btn-edit { color: var(--accent); }
        .btn-del { color: var(--danger); }
        .player-controls { display: flex; align-items: center; gap: 8px; }
        .mini-select { width: auto; padding: 5px; font-size: 0.75rem; background: #34495e; color: white; border: none; border-radius: 4px; }
    </style>
</head>
<body>
    <div id="screen-login" class="box">
        <img src="https://static.wixstatic.com/media/eda9e4_e7ab6af2d5a7428f9bc7e4af454e20ef~mv2.png" style="width:70px; margin-bottom:15px;">
        <h2>Acc√®s MJ S√©curis√©</h2>
        <input type="email" id="mj-email" placeholder="Email MJ">
        <div style="position: relative; width: 100%;">
            <input type="password" id="mj-pass" placeholder="Mot de passe">
            <span style="position: absolute; right: 10px; top: 12px; cursor: pointer; opacity: 0.5;" onmousedown="document.getElementById('mj-pass').type='text'" onmouseup="document.getElementById('mj-pass').type='password'">üëÅÔ∏è</span>
        </div>
        <button id="btn-login-submit" onclick="login()">Se Connecter</button>
    </div>

    <div id="screen-choice" class="box" style="display:none;">
        <h2>Bonjour <span id="mj-display-name">MJ</span> !</h2>
        <button onclick="createNewRoom()">üÜï Cr√©er une nouvelle salle</button>
        <button id="btn-resume" onclick="resumeRoom()" style="display:none; background:var(--blue)">üîÑ Reprendre la salle <span id="last-room-id"></span></button>
        <button onclick="openProfil()" style="background:var(--gold);">üë§ Mon Profil</button>
        <button onclick="auth.signOut().then(()=>location.reload())" style="background:none; border:1px solid white; font-size:0.7rem;">D√©connexion</button>
    </div>

    <div id="screen-profil" class="profil-panel box">
        <h2>Mon Profil</h2>
        <input type="text" id="profil-prenom" placeholder="Pr√©nom">
        <input type="text" id="profil-nom" placeholder="Nom">
        <button onclick="saveProfil()">Enregistrer</button>
        <button onclick="closeProfil()" style="background:var(--blue)">Retour</button>
    </div>

    <div id="screen-dashboard" class="dashboard">
        <div class="room-info">SALLE : <span id="display-room">----</span></div>
        <div style="display:flex; gap:10px; margin-bottom:20px;">
            <button style="background:var(--blue); flex:1;" onclick="statusUpdate('ready')">Ouvrir Buzzers</button>
            <button style="background:var(--danger); flex:1;" onclick="fullReset()">RESET TITRE</button>
        </div>
        <div id="player-box" class="current-player">
            <div id="p-avatar" style="font-size:3.5rem"></div>
            <h2 id="p-name" style="margin:5px 0;"></h2>
            <div id="p-team"></div>
            <div class="action-grid">
                <button style="background:var(--gold)" onclick="handleReward(3, 'finish')">+3 (TOUT)</button>
                <button style="background:var(--blue)" onclick="handleReward(1, 'partial')">+1 (PARTIEL)</button>
                <button style="background:var(--danger)" onclick="handleError()">ERREUR</button>
            </div>
        </div>
        <div style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 12px; margin-top: 20px;">
            <h3>Gestion √âquipes</h3>
            <input type="file" id="upload-crest" accept="image/*" style="font-size: 0.8rem;">
            <input type="text" id="t-name" placeholder="Nom de l'√©quipe..." oninput="checkTeamForm()">
            <div class="crest-picker" id="crest-grid"></div>
            <button id="btn-add-team" disabled onclick="addTeam()">Cr√©er l'√âquipe</button>
            <div id="mj-team-list-display"></div>
        </div>
        <h3>Lobby Joueurs</h3>
        <div id="score-list"></div>
        <button style="background:black; color:red; margin-top:40px; border:1px solid red; width:100%" onclick="resetFullGame()">‚ö†Ô∏è RESET TOTAL PARTIE ‚ö†Ô∏è</button>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAf1Vl_O8SHJeFjHavKBJgUFGGy73I8t-o",
            authDomain: "prestapuce-buzz.firebaseapp.com",
            databaseURL: "https://prestapuce-buzz-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "prestapuce-buzz",
            storageBucket: "prestapuce-buzz.firebasestorage.app",
            messagingSenderId: "907270883505",
            appId: "1:907270883505:web:197efec0b99db28180ba90"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();
        const storage = firebase.storage();

        let roomID = "", roomRef = null, currentPlayer = null, selCrest = "", globalTeams = {}, lastSavedRoom = "";
        const defaultCrests = ["https://cdn-icons-png.flaticon.com/512/1165/1165187.png", "https://cdn-icons-png.flaticon.com/512/1165/1165220.png", "https://cdn-icons-png.flaticon.com/512/1165/1165191.png", "https://cdn-icons-png.flaticon.com/512/1165/1165207.png", "https://cdn-icons-png.flaticon.com/512/1065/1065545.png", "https://cdn-icons-png.flaticon.com/512/1065/1065549.png", "https://cdn-icons-png.flaticon.com/512/1065/1065553.png", "https://cdn-icons-png.flaticon.com/512/1152/1152912.png"];

        function login() {
            const email = document.getElementById('mj-email').value.trim();
            const pass = document.getElementById('mj-pass').value;
            auth.signInWithEmailAndPassword(email, pass).then(res => { loadMjData(res.user); }).catch(e => { alert("Erreur connexion"); });
        }

        function loadMjData(user) {
            db.ref('mjs/' + user.uid).once('value').then(snap => {
                const data = snap.val() || {};
                document.getElementById('mj-display-name').innerText = data.prenom || "MJ";
                document.getElementById('profil-prenom').value = data.prenom || "";
                document.getElementById('profil-nom').value = data.nom || "";
                checkUserRoom(user.uid);
            });
        }

        function openProfil() { document.getElementById('screen-choice').style.display = "none"; document.getElementById('screen-profil').style.display = "block"; }
        function closeProfil() { document.getElementById('screen-profil').style.display = "none"; document.getElementById('screen-choice').style.display = "block"; }

        async function saveProfil() {
            const user = auth.currentUser;
            const prenom = document.getElementById('profil-prenom').value.trim();
            const nom = document.getElementById('profil-nom').value.trim();
            await db.ref('mjs/' + user.uid).update({ prenom, nom });
            document.getElementById('mj-display-name').innerText = prenom || "MJ";
            closeProfil();
        }

        function checkUserRoom(uid) {
            db.ref('users/' + uid + '/lastRoom').once('value', snap => {
                document.getElementById('screen-login').style.display = "none";
                document.getElementById('screen-choice').style.display = "block";
                if(snap.exists()) { lastSavedRoom = snap.val(); document.getElementById('btn-resume').style.display = "block"; document.getElementById('last-room-id').innerText = lastSavedRoom; }
            });
        }

        function createNewRoom() { roomID = Math.floor(1000 + Math.random() * 9000).toString(); db.ref('users/' + auth.currentUser.uid + '/lastRoom').set(roomID); launchDashboard(roomID); }
        function resumeRoom() { launchDashboard(lastSavedRoom); }

        function launchDashboard(id) {
            roomID = id; document.getElementById('screen-choice').style.display = "none"; document.getElementById('screen-dashboard').style.display = "block";
            document.getElementById('display-room').innerText = roomID;
            db.ref('activeRooms/' + roomID).set({ status: 'open' });
            roomRef = db.ref('roomsData/' + roomID);
            initMJLogic(); loadCrestGrid();
        }

        function loadCrestGrid() {
            const grid = document.getElementById('crest-grid');
            db.ref('mjs/' + auth.currentUser.uid + '/customIcons').on('value', snap => {
                grid.innerHTML = "";
                snap.forEach(child => { createCrestIcon(child.val().url); });
                defaultCrests.forEach(url => { createCrestIcon(url); });
            });
        }

        function createCrestIcon(url) {
            const grid = document.getElementById('crest-grid');
            const wrap = document.createElement('div'); wrap.className = 'crest-wrapper';
            const img = document.createElement('img'); img.src = url; img.className = 'crest-opt';
            wrap.onclick = () => { document.querySelectorAll('.crest-wrapper').forEach(i=>i.classList.remove('crest-selected')); wrap.classList.add('crest-selected'); selCrest = url; checkTeamForm(); };
            wrap.appendChild(img); grid.appendChild(wrap);
        }

        document.getElementById('upload-crest').addEventListener('change', e => {
            const file = e.target.files[0]; if (!file) return;
            const ref = storage.ref(`mj_icons/${auth.currentUser.uid}/${Date.now()}_${file.name}`);
            ref.put(file).then(snap => { snap.ref.getDownloadURL().then(url => { db.ref('mjs/' + auth.currentUser.uid + '/customIcons').push({ url }); }); });
        });

        function checkTeamForm() { const name = document.getElementById('t-name').value.trim(); document.getElementById('btn-add-team').disabled = !(name.length > 0 && selCrest !== ""); }
        function addTeam() { const n = document.getElementById('t-name').value.trim(); if(n && selCrest) { roomRef.child('teams/' + n).set({ icon: selCrest }); document.getElementById('t-name').value = ""; checkTeamForm(); } }
        
        function renameTeam(oldName) {
            const newName = prompt("Nouveau nom :", oldName);
            if (!newName || newName === oldName) return;
            roomRef.child('teams/' + oldName).once('value', snap => {
                roomRef.child('teams/' + newName).set(snap.val()).then(() => {
                    roomRef.child('teams/' + oldName).remove();
                    roomRef.child('scores').once('value', sSnap => { sSnap.forEach(p => { if (p.val().teamName === oldName) roomRef.child('scores/' + p.key).update({ teamName: newName }); }); });
                });
            });
        }

        function deleteTeam(name) { if(confirm("Supprimer l'√©quipe ?")) roomRef.child('teams/' + name).remove(); }
        function togglePlayerTeam(pseudo, choice) {
            if(choice === "Solo") roomRef.child('scores/' + pseudo).update({ teamName: "Solo", teamIcon: "" });
            else roomRef.child('scores/' + pseudo).update({ teamName: choice, teamIcon: globalTeams[choice].icon });
        }

        function kickPlayer(pseudo) {
            if(!confirm("Expulser " + pseudo + " ?")) return;
            roomRef.child('scores/' + pseudo).once('value', snap => {
                const data = snap.val();
                if(!data) return;
                // On passe en active:false. Le script scores.html filtrera selon Solo/Equipe
                roomRef.child('scores/' + pseudo).update({ active: false });
            });
        }

        function initMJLogic() {
            roomRef.child('buzzers').on('value', snap => {
                const p = snap.val(); const box = document.getElementById('player-box');
                if(p) { currentPlayer = p; document.getElementById('p-avatar').innerText = p.avatar; document.getElementById('p-name').innerText = p.pseudo; box.style.display = "block";
                    const teamDisplay = (p.teamName && p.teamName !== "Solo") ? `<div class="crest-mini-bg"><img src="${p.teamIcon}" class="crest-mini"></div> ${p.teamName}` : "Solo";
                    document.getElementById('p-team').innerHTML = teamDisplay;
                } else { box.style.display = "none"; }
            });
            roomRef.child('teams').on('value', snap => { globalTeams = snap.val() || {}; renderLobby(); });
            roomRef.child('scores').on('value', snap => { renderLobby(); });
        }

        function renderLobby() {
            roomRef.child('scores').once('value', snap => {
                const l = document.getElementById('score-list'); l.innerHTML = "";
                const tList = document.getElementById('mj-team-list-display'); tList.innerHTML = "";
                Object.keys(globalTeams).forEach(tKey => {
                    tList.innerHTML += `<div class="team-item"><span><div class="crest-mini-bg"><img src="${globalTeams[tKey].icon}" class="crest-mini"></div> <b>${tKey}</b></span><div><span class="btn-icon btn-edit" onclick="renameTeam('${tKey}')">‚úé</span><span class="btn-icon btn-del" onclick="deleteTeam('${tKey}')">‚úñ</span></div></div>`;
                });
                snap.forEach(c => {
                    const d = c.val(); if(d.active === false) return;
                    let teamOptions = `<option value="Solo" ${d.teamName === "Solo" ? "selected" : ""}>Solo</option>`;
                    Object.keys(globalTeams).forEach(t => { teamOptions += `<option value="${t}" ${d.teamName === t ? "selected" : ""}>${t}</option>`; });
                    l.innerHTML += `<div class="score-row"><span>${d.avatar} <b>${c.key}</b> : ${d.pts} pts</span><div class="player-controls"><select class="mini-select" onchange="togglePlayerTeam('${c.key}', this.value)">${teamOptions}</select><button onclick="adj('${c.key}',-1)">-</button><button onclick="adj('${c.key}',1)">+</button><span class="btn-icon btn-del" onclick="kickPlayer('${c.key}')">‚úñ</span></div></div>`;
                });
            });
        }

        function statusUpdate(st) { roomRef.child('gameState').set({ status: st }); if(st === 'ready') roomRef.child('buzzers').remove(); }
        function fullReset() { roomRef.child('blockedPlayers').remove(); roomRef.child('buzzers').remove(); statusUpdate('waiting'); }
        function handleReward(pts, mode) {
            roomRef.child('scores/' + currentPlayer.pseudo).transaction(c => { return { pts: (c ? c.pts : 0) + pts, avatar: currentPlayer.avatar, teamName: currentPlayer.teamName, teamIcon: currentPlayer.teamIcon, active: true }; });
            if(mode === 'partial') { roomRef.child('blockedPlayers/' + currentPlayer.pseudo).set(true); statusUpdate('ready'); } else { fullReset(); }
        }
        function handleError() { roomRef.child('blockedPlayers/' + currentPlayer.pseudo).set(true); statusUpdate('ready'); }
        function adj(p, v) { roomRef.child('scores/'+p+'/pts').transaction(x => (x||0)+v); }
        function resetFullGame() { if(confirm("RESET TOTAL ?")) { roomRef.remove(); location.reload(); } }
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Console MJ Pro - Presta'Puce</title>
    <link rel="icon" id="page-favicon" type="image/png" href="https://static.wixstatic.com/media/eda9e4_e7ab6af2d5a7428f9bc7e4af454e20ef~mv2.png">
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-storage-compat.js"></script>
    <style>
        :root { --mj-color: #2ecc71; --bg-color: #1a1a1a; --card-bg: #2c3e50; --text-color: #ffffff; --danger: #e74c3c; --accent: #f1c40f; --blue: #3498db; --gold: #f39c12; }
        body { background: var(--bg-color); color: white; font-family: 'Segoe UI', sans-serif; margin: 0; padding: 20px; }
        .box { max-width: 400px; margin: 80px auto 40px auto; background: var(--card-bg); padding: 30px; border-radius: 15px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
        input, select { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1); box-sizing: border-box; background: #1a1a1a; color: white; font-size: 1rem; outline: none; margin-bottom: 15px; }
        button { background: var(--mj-color); color: white; padding: 14px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; width: 100%; transition: 0.1s; text-transform: uppercase; margin-bottom: 10px; position: relative; top: 0; box-shadow: 0 4px rgba(0,0,0,0.3); }
        button:active:not(:disabled) { top: 2px; box-shadow: 0 2px rgba(0,0,0,0.3); }
        button:disabled { background: #7f8c8d !important; cursor: not-allowed; top: 0; box-shadow: none; opacity: 0.6; }
        .dashboard { display: none; max-width: 800px; margin: 80px auto 40px auto; }
        .room-info { background: var(--accent); color: black; padding: 10px; border-radius: 10px; font-weight: bold; text-align: center; margin-bottom: 20px; font-size: 1.2rem; }
        .crest-picker { display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px; margin: 10px 0; background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px; max-height: 150px; overflow-y: auto; }
        .crest-wrapper { background: white; padding: 4px; border-radius: 6px; display: flex; align-items: center; justify-content: center; cursor: pointer; border: 3px solid transparent; }
        .crest-selected { border-color: var(--accent) !important; background: var(--accent) !important; transform: scale(1.1); }
        .crest-opt { width: 30px; height: 30px; object-fit: contain; }
        .current-player { background: var(--card-bg); padding: 20px; border-radius: 15px; border: 4px solid var(--accent); margin: 20px 0; text-align: center; display: none; }
        .action-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        .team-item { display: flex; align-items: center; background: rgba(255,255,255,0.1); padding: 10px; border-radius: 8px; margin-bottom: 8px; justify-content: space-between; }
        .score-row { display: flex; align-items: center; justify-content: space-between; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 8px; margin-bottom: 5px; }
        .crest-mini-bg { background: white; padding: 2px; border-radius: 4px; display: inline-flex; margin: 0 5px; vertical-align: middle; }
        .crest-mini { width: 22px; height: 22px; object-fit: contain; }
        .btn-icon { cursor: pointer; font-weight: bold; font-size: 1.1rem; margin-left: 10px; transition: 0.2s; }
        .lobby-btn { width: 30px; height: 30px; padding: 0; margin: 0; font-size: 1rem; display: inline-flex; align-items: center; justify-content: center; box-shadow: 0 2px rgba(0,0,0,0.3); border: none; border-radius: 4px; color: white; cursor: pointer; }
        .mini-select { width: auto; padding: 5px; font-size: 0.8rem; background: #34495e; color: white; border: 1px solid rgba(255,255,255,0.2); border-radius: 4px; margin-bottom: 0; }
        .upload-zone { margin: 10px 0; padding: 10px; border: 2px dashed var(--mj-color); border-radius: 8px; text-align: center; background: rgba(0,0,0,0.2); }
    </style>
</head>
<body>

    <div id="global-mj-logo-container" style="display:none; position: fixed; top: 20px; left: 20px; z-index: 9999;">
        <img id="global-mj-logo" src="https://static.wixstatic.com/media/eda9e4_e7ab6af2d5a7428f9bc7e4af454e20ef~mv2.png" onclick="toggleProfile()" style="width:60px; height:60px; object-fit:contain; cursor:pointer; border-radius:10px; box-shadow: 0 4px 10px rgba(0,0,0,0.5); background:var(--card-bg); transition: transform 0.2s;">
    </div>

    <div id="screen-login" class="box">
        <img id="login-mj-logo" src="https://static.wixstatic.com/media/eda9e4_e7ab6af2d5a7428f9bc7e4af454e20ef~mv2.png" style="width:70px; margin-bottom:15px; border-radius: 10px;">
        <h2>Acc√®s MJ S√©curis√©</h2>
        <input type="email" id="mj-email" placeholder="Email MJ">
        <input type="password" id="mj-pass" placeholder="Mot de passe">
        <button id="btn-login-submit" onclick="login()">Se Connecter</button>
    </div>

    <div id="screen-choice" class="box" style="display:none;">
        <h2>Bonjour <span id="mj-display-name" style="color:var(--accent);">MJ</span> !</h2>
        <button onclick="createNewRoom()" style="margin-top:15px;">üÜï Cr√©er une nouvelle salle</button>
        <button id="btn-resume" onclick="resumeRoom()" style="display:none; background:var(--blue)">üîÑ Reprendre la salle <span id="last-room-id"></span></button>
        <button onclick="auth.signOut().then(()=>location.reload())" style="background:none; border:1px solid rgba(255,255,255,0.3); font-size:0.8rem; margin-top:15px; width:auto; padding:8px 15px;">D√©connexion</button>
    </div>

    <div id="screen-dashboard" class="dashboard">
        <div class="room-info">SALLE : <span id="display-room">----</span></div>
        <div style="display:flex; gap:10px; margin-bottom:20px;">
            <button style="background:var(--blue); flex:1;" onclick="statusUpdate('ready')">Ouvrir Buzzers</button>
            <button style="background:var(--danger); flex:1;" onclick="fullReset()">RESET TITRE</button>
        </div>

        <div id="player-box" class="current-player">
            <div id="p-avatar" style="font-size:3.5rem; display:flex; justify-content:center; align-items:center;"></div>
            <h2 id="p-name" style="margin:5px 0;"></h2>
            <div id="p-team" style="display: flex; align-items: center; justify-content: center; gap: 5px; font-weight: bold; margin-bottom: 10px;"></div>
            <div class="action-grid">
                <button style="background:var(--gold)" onclick="handleReward(3, 'finish')">+3 (Termin√©)</button>
                <button style="background:var(--mj-color)" onclick="handleReward(1, 'finish')">+1 (Termin√©)</button>
                <button style="background:var(--blue)" onclick="handleReward(1, 'partial')">+1 (On continue)</button>
                <button style="background:var(--danger)" onclick="handleError()">Erreur</button>
            </div>
        </div>

        <div style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 12px; margin-top: 20px;">
            <h3>Gestion √âquipes</h3>
            <input type="text" id="t-name" placeholder="Nom de l'√©quipe..." oninput="checkTeamForm()">
            <div class="upload-zone">
                <label for="upload-logo" style="cursor:pointer; font-weight:bold; color:var(--mj-color); font-size:0.8rem;">‚ûï AJOUTER UN BLASON</label>
                <input type="file" id="upload-logo" accept="image/*" style="display:none;" onchange="uploadCustomTeamLogo(this)">
            </div>
            <div class="crest-picker" id="crest-grid"></div>
            <button id="btn-add-team" disabled onclick="addTeam()">Cr√©er l'√âquipe</button>
            <div id="mj-team-list-display"></div>
        </div>

        <h3>Lobby Joueurs</h3>
        <div id="score-list"></div>

        <div id="banned-section" style="display:none; margin-top:20px; padding: 15px; background: rgba(231, 76, 60, 0.1); border: 1px solid var(--danger); border-radius: 12px;">
            <h3 style="color:var(--danger); margin:0 0 10px 0;">Joueurs Expuls√©s</h3>
            <div id="banned-list"></div>
        </div>

        <div style="margin-top:20px; padding: 15px; border: 2px solid var(--gold); border-radius: 12px; text-align: center;">
            <button style="background: linear-gradient(to bottom, #f1c40f, #f39c12); color: black;" onclick="triggerEndGame()">üèÅ Fin de partie</button>
        </div>
        
        <div style="margin-top:40px; border: 1px solid rgba(255,255,255,0.1); padding: 20px; border-radius: 12px;">
            <button style="background:var(--blue);" onclick="quitRoom()">üö™ Quitter la console</button>
            <button style="background:var(--danger);" onclick="resetFullGame()">‚ö†Ô∏è SUPPRIMER LA SALLE</button>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAf1Vl_O8SHJeFjHavKBJgUFGGy73I8t-o",
            authDomain: "prestapuce-buzz.firebaseapp.com",
            databaseURL: "https://prestapuce-buzz-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "prestapuce-buzz",
            storageBucket: "prestapuce-buzz.firebasestorage.app"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();
        const storage = firebase.storage();

        let roomID = "", roomRef = null, currentPlayer = null, selCrest = "", globalTeams = {}, lastSavedRoom = "";
        let allPlayersData = {}, currentBlocked = {}, mjProfileData = {};

        const defaultCrests = ["https://cdn-icons-png.flaticon.com/512/1165/1165187.png", "https://cdn-icons-png.flaticon.com/512/1165/1165220.png", "https://cdn-icons-png.flaticon.com/512/1165/1165191.png"];

        function login() {
            const email = document.getElementById('mj-email').value.trim();
            const pass = document.getElementById('mj-pass').value;
            auth.signInWithEmailAndPassword(email, pass).then(res => {
                db.ref('users/' + res.user.uid).once('value', snap => {
                    mjProfileData = snap.val() || {};
                    document.getElementById('mj-display-name').innerText = mjProfileData.prenom || "MJ";
                    checkUserRoom(res.user.uid);
                });
            }).catch(() => alert("Erreur connexion"));
        }

        function checkUserRoom(uid) {
            db.ref('users/' + uid + '/lastRoom').once('value', snap => {
                document.getElementById('screen-login').style.display = "none";
                document.getElementById('screen-choice').style.display = "block";
                document.getElementById('global-mj-logo-container').style.display = "block";
                if(snap.exists() && snap.val() !== "") {
                    lastSavedRoom = snap.val();
                    document.getElementById('btn-resume').style.display = "block";
                    document.getElementById('last-room-id').innerText = lastSavedRoom;
                }
            });
        }

        function createNewRoom() {
            roomID = Math.floor(1000 + Math.random() * 9000).toString();
            db.ref('users/' + auth.currentUser.uid + '/lastRoom').set(roomID);
            launchDashboard(roomID);
        }

        function resumeRoom() { launchDashboard(lastSavedRoom); }

        function launchDashboard(id) {
            roomID = id;
            document.getElementById('screen-choice').style.display = "none";
            document.getElementById('screen-dashboard').style.display = "block";
            document.getElementById('display-room').innerText = roomID;
            db.ref('activeRooms/' + roomID).set({ status: 'open' });
            roomRef = db.ref('roomsData/' + id);
            roomRef.child('isGuestRoom').set(mjProfileData.isGuest === true);
            initMJLogic();
            loadCrestGrid();
        }

        function initMJLogic() {
            roomRef.child('buzzers').on('value', snap => {
                const b = snap.val();
                const box = document.getElementById('player-box');
                if(b) {
                    currentPlayer = b;
                    document.getElementById('p-name').innerText = b.pseudo;
                    document.getElementById('p-avatar').innerHTML = (b.avatar && b.avatar.length > 20) ? `<img src="${b.avatar}" style="width:70px; height:70px; border-radius:50%; object-fit:cover;">` : b.avatar;
                    box.style.display = "block";
                } else box.style.display = "none";
            });
            roomRef.child('teams').on('value', snap => { globalTeams = snap.val() || {}; renderLobby(); });
            roomRef.child('scores').on('value', snap => { allPlayersData = snap.val() || {}; renderLobby(); });
            roomRef.child('blockedPlayers').on('value', snap => { currentBlocked = snap.val() || {}; renderLobby(); });
        }

        function renderLobby() {
            const l = document.getElementById('score-list'); l.innerHTML = "";
            const bList = document.getElementById('banned-list'); bList.innerHTML = "";
            let hasBanned = false;

            Object.keys(allPlayersData).forEach(pseudo => {
                const d = allPlayersData[pseudo];
                if(d.kicked === true) {
                    hasBanned = true;
                    bList.innerHTML += `<div class="team-item"><span>${pseudo}</span><button style="background:var(--mj-color); width:auto; padding:5px 10px;" onclick="unkickPlayer('${pseudo}')">R√©habiliter</button></div>`;
                    return;
                }
                if(d.active === false) return;

                const isBlocked = currentBlocked[pseudo];
                l.innerHTML += `<div class="score-row">
                    <span><b>${pseudo}</b> (${d.pts || 0} pts)</span>
                    <div class="player-controls">
                        <button class="lobby-btn" style="background:${isBlocked ? 'var(--danger)' : 'gray'}" onclick="toggleBlockPlayer('${pseudo}')">üõë</button>
                        <button class="lobby-btn" style="background:var(--mj-color)" onclick="adj('${pseudo}',1)">+</button>
                        <button class="lobby-btn" style="background:var(--danger)" onclick="kickPlayer('${pseudo}')">‚úñ</button>
                    </div>
                </div>`;
            });
            document.getElementById('banned-section').style.display = hasBanned ? "block" : "none";
        }

        // --- FONCTIONS ACTIONS MJ ---

        function kickPlayer(p) {
            if(confirm("Expulser " + p + " ? Le joueur devra valider le message pour quitter.")) {
                // 1. On active le drapeau kicked
                roomRef.child('scores/' + p).update({ kicked: true }).then(() => {
                    // 2. On laisse le temps √† l'alerte de s'afficher avant de marquer inactif
                    setTimeout(() => { roomRef.child('scores/' + p).update({ active: false }); }, 1500);
                });
            }
        }

        function unkickPlayer(p) { roomRef.child('scores/' + p).update({ kicked: false, active: false }); }

        function statusUpdate(st) { 
            roomRef.child('gameState').set({ status: st }); 
            if(st === 'ready') roomRef.child('buzzers').remove(); 
        }

        function fullReset() { 
            roomRef.child('blockedPlayers').remove(); 
            roomRef.child('buzzers').remove(); 
            statusUpdate('waiting'); 
        }

        function adj(p, v) { roomRef.child('scores/'+p+'/pts').transaction(x => (x||0)+v); }

        function handleReward(pts, mode) {
            roomRef.child('scores/' + currentPlayer.pseudo + '/pts').transaction(x => (x||0)+pts);
            if(mode === 'partial') {
                roomRef.child('blockedPlayers/' + currentPlayer.pseudo).set(true);
                statusUpdate('ready');
            } else fullReset();
        }

        function handleError() {
            roomRef.child('blockedPlayers/' + currentPlayer.pseudo).set(true);
            statusUpdate('ready');
        }

        function toggleBlockPlayer(p) {
            if(currentBlocked[p]) roomRef.child('blockedPlayers/' + p).remove();
            else roomRef.child('blockedPlayers/' + p).set(true);
        }

        function triggerEndGame() {
            if(confirm("Fin de partie ? Les scores seront fig√©s.")) {
                roomRef.child('gameState').set({ status: 'endGame' });
                roomRef.child('buzzers').remove();
            }
        }

        function resetFullGame() {
            if(confirm("‚ö†Ô∏è Supprimer d√©finitivement cette salle ?")) {
                roomRef.remove();
                db.ref('activeRooms/' + roomID).remove();
                db.ref('users/' + auth.currentUser.uid + '/lastRoom').remove().then(() => location.reload());
            }
        }

        function quitRoom() {
            if(confirm("Quitter la console ? (La salle reste active)")) {
                location.reload();
            }
        }

        function loadCrestGrid() {
            const grid = document.getElementById('crest-grid');
            grid.innerHTML = "";
            defaultCrests.forEach(url => {
                const wrap = document.createElement('div');
                wrap.className = 'crest-wrapper';
                wrap.innerHTML = `<img src="${url}" class="crest-opt">`;
                wrap.onclick = () => {
                    document.querySelectorAll('.crest-wrapper').forEach(w => w.classList.remove('crest-selected'));
                    wrap.classList.add('crest-selected');
                    selCrest = url;
                    checkTeamForm();
                };
                grid.appendChild(wrap);
            });
        }

        function checkTeamForm() {
            document.getElementById('btn-add-team').disabled = !document.getElementById('t-name').value.trim() || !selCrest;
        }

        function addTeam() {
            const n = document.getElementById('t-name').value.trim();
            roomRef.child('teams/' + n).set({ icon: selCrest });
            document.getElementById('t-name').value = "";
            selCrest = "";
            loadCrestGrid();
        }
    </script>
</body>
</html>
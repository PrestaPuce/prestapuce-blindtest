<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Console MJ - Presta'Puce</title>
    <link rel="icon" type="image/png" href="https://static.wixstatic.com/media/eda9e4_e7ab6af2d5a7428f9bc7e4af454e20ef~mv2.png">
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
    <style>
        :root { --mj-color: #2ecc71; --bg-color: #1a1a1a; --card-bg: #2c3e50; --text-color: #ffffff; --danger: #e74c3c; --accent: #f1c40f; }
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background-color: var(--bg-color); color: var(--text-color); padding: 15px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #444; padding-bottom: 10px; }
        .btn-mj { padding: 15px; border-radius: 12px; border: none; font-weight: 900; text-transform: uppercase; cursor: pointer; color: white; width: 100%; box-shadow: 0 5px 0 rgba(0,0,0,0.3); margin-bottom: 10px; }
        .btn-start { background: var(--mj-color); } .btn-reset { background: var(--danger); }
        .current-player { background: var(--card-bg); border-radius: 15px; padding: 20px; text-align: center; border: 4px solid var(--accent); margin: 20px 0; display: none; }
        .section-title { font-size: 0.8rem; color: var(--accent); text-transform: uppercase; margin: 25px 0 10px; letter-spacing: 1px; }
        .crest-picker { display: grid; grid-template-columns: repeat(10, 1fr); gap: 5px; margin-bottom: 10px; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 10px; }
        .crest-opt { width: 100%; max-width: 24px; cursor: pointer; border: 2px solid transparent; border-radius: 4px; }
        .crest-opt.selected { border-color: var(--accent); background: rgba(255,255,15,0.2); transform: scale(1.2); }
        .score-row { display: flex; align-items: center; justify-content: space-between; background: rgba(0,0,0,0.2); margin-bottom: 5px; padding: 8px; border-radius: 8px; font-size: 0.9rem; }
        .crest-mini { width: 18px; height: 18px; vertical-align: middle; object-fit: contain; }
        .team-tag { background:#000; padding:6px; border-radius:8px; display:flex; align-items:center; gap:8px; border:1px solid #444; margin-bottom:5px; }
    </style>
</head>
<body>
    <div class="header"><h1>Console MJ</h1><img src="https://static.wixstatic.com/media/eda9e4_e7ab6af2d5a7428f9bc7e4af454e20ef~mv2.png" style="width:40px"></div>
    <button class="btn-mj btn-start" onclick="statusUpdate('ready')">START (Ouvrir Buzzers)</button>
    <button class="btn-mj btn-reset" onclick="fullReset()">RESET (Nouveau Titre)</button>
    
    <div id="player-box" class="current-player">
        <div id="p-avatar" style="font-size:3rem"></div><h2 id="p-name" style="margin: 5px 0;"></h2>
        <div id="p-team" style="margin-bottom: 15px; font-size: 0.9rem;"></div>
        <div style="display: grid; gap: 8px;">
            <button class="btn-mj" style="background:#2980b9" onclick="reward(1, true)">+1 PT (Partiel)</button>
            <button class="btn-mj" style="background:#8e44ad" onclick="reward(3, false)">+3 PTS (Complet)</button>
            <button class="btn-mj" style="background:#7f8c8d" onclick="errorBlock()">ERREUR (Bloquer)</button>
        </div>
    </div>

    <div class="section-title">Gestion des Équipes</div>
    <div style="background:var(--card-bg); padding:12px; border-radius:12px;">
        <input type="text" id="t-name" placeholder="Nom de l'équipe..." style="width:100%; padding:10px; border-radius:8px; border:none; margin-bottom:10px; color:black;">
        <div class="crest-picker" id="crest-grid"></div>
        <button class="btn-mj" style="background:#3498db; font-size: 0.8rem;" onclick="addTeam()">Ajouter l'Équipe</button>
    </div>
    <div id="team-list" style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap; font-size: 0.8rem;"></div>

    <div class="section-title">Lobby & Scores</div>
    <div id="score-list"></div>
    <button class="btn-mj" style="background:#000; color:var(--danger); border:1px solid var(--danger); margin-top:30px; font-size: 0.7rem;" onclick="resetFullGame()">⚠️ RESET TOTAL PARTIE</button>

    <script>
        const firebaseConfig = { databaseURL: "https://prestapuce-buzz-default-rtdb.europe-west1.firebasedatabase.app/" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        let currentPlayer = null, selCrest = "";
        const crests = ["https://cdn-icons-png.flaticon.com/512/744/744922.png","https://cdn-icons-png.flaticon.com/512/744/744921.png","https://cdn-icons-png.flaticon.com/512/744/744849.png","https://cdn-icons-png.flaticon.com/512/744/744905.png","https://cdn-icons-png.flaticon.com/512/1065/1065545.png","https://cdn-icons-png.flaticon.com/512/1065/1065549.png","https://cdn-icons-png.flaticon.com/512/1065/1065551.png","https://cdn-icons-png.flaticon.com/512/1065/1065553.png","https://cdn-icons-png.flaticon.com/512/1152/1152912.png","https://cdn-icons-png.flaticon.com/512/1152/1152918.png","https://cdn-icons-png.flaticon.com/512/2583/2583344.png","https://cdn-icons-png.flaticon.com/512/2583/2583319.png","https://cdn-icons-png.flaticon.com/512/2583/2583434.png","https://cdn-icons-png.flaticon.com/512/2583/2583351.png","https://cdn-icons-png.flaticon.com/512/1037/1037953.png","https://cdn-icons-png.flaticon.com/512/1037/1037959.png","https://cdn-icons-png.flaticon.com/512/1037/1037974.png","https://cdn-icons-png.flaticon.com/512/1037/1038002.png","https://cdn-icons-png.flaticon.com/512/1037/1037984.png","https://cdn-icons-png.flaticon.com/512/1037/1038018.png"];
        
        window.onload = () => {
            const grid = document.getElementById('crest-grid');
            crests.forEach(c => {
                const img = document.createElement('img'); img.src = c; img.className = 'crest-opt';
                img.onclick = () => { document.querySelectorAll('.crest-opt').forEach(i=>i.classList.remove('selected')); img.classList.add('selected'); selCrest = c; };
                grid.appendChild(img);
            });
        };

        function addTeam() { 
            const n = document.getElementById('t-name').value.trim(); 
            if(n && selCrest) { db.ref('teams/' + n).set({ icon: selCrest }); document.getElementById('t-name').value = ""; } 
        }

        function editTeamName(oldName) {
            const newName = prompt("Nouveau nom pour l'équipe " + oldName + " :", oldName);
            if (newName && newName !== oldName) {
                db.ref('teams/' + oldName).once('value', snap => {
                    const data = snap.val();
                    db.ref('teams/' + newName).set(data);
                    db.ref('teams/' + oldName).remove();
                    db.ref('teamRenamed').set({ old: oldName, new: newName, icon: data.icon });
                });
            }
        }

        function statusUpdate(st) { db.ref('gameState').set({ status: st }); if(st === 'ready') db.ref('buzzers').remove(); }
        function fullReset() { db.ref('blockedPlayers').remove(); db.ref('buzzers').remove(); statusUpdate('waiting'); }
        
        function resetFullGame() { 
            const keepTeams = confirm("Voulez-vous GARDER les équipes existantes ?\n\nOK = Garder\nAnnuler = Supprimer tout");
            if(confirm("Confirmer la remise à zéro des scores ?")) {
                db.ref('scores').remove(); 
                if(!keepTeams) db.ref('teams').remove();
                fullReset();
            }
        }

        function errorBlock() { if(!currentPlayer) return; db.ref('blockedPlayers/' + currentPlayer.pseudo).set(true); statusUpdate('ready'); }
        function reward(pts, keep) {
            db.ref('scores/' + currentPlayer.pseudo).transaction(c => { return { pts: (c ? c.pts : 0) + pts, avatar: currentPlayer.avatar, teamName: currentPlayer.teamName, teamIcon: currentPlayer.teamIcon }; });
            if(keep) { db.ref('blockedPlayers/' + currentPlayer.pseudo).set(true); statusUpdate('ready'); } else { fullReset(); }
        }

        db.ref('teams').on('value', snap => {
            const list = document.getElementById('team-list'); list.innerHTML = "";
            snap.forEach(c => { 
                list.innerHTML += `<div class="team-tag"><img src="${c.val().icon}" class="crest-mini"> ${c.key} <span onclick="editTeamName('${c.key}')" style="cursor:pointer; margin-left:5px;">✏️</span><span onclick="db.ref('teams/${c.key}').remove()" style="color:red; cursor:pointer; margin-left:5px">×</span></div>`; 
            });
        });

        db.ref('buzzers').on('value', snap => {
            const p = snap.val(); const b = document.getElementById('player-box');
            if(p) { currentPlayer = p; document.getElementById('p-avatar').innerText = p.avatar; document.getElementById('p-name').innerText = p.pseudo; document.getElementById('p-team').innerHTML = `<img src="${p.teamIcon}" class="crest-mini"> (${p.teamName})`; b.style.display = "block"; } else { b.style.display = "none"; }
        });

        db.ref('scores').on('value', snap => {
            const l = document.getElementById('score-list'); l.innerHTML = "";
            snap.forEach(c => { 
                const d = c.val();
                const teamDisplay = d.teamIcon ? `<img src="${d.teamIcon}" class="crest-mini"> (${d.teamName})` : `(${d.teamName})`;
                l.innerHTML += `<div class="score-row"><span><b>${d.avatar} ${c.key}</b> ${teamDisplay} : ${d.pts} pts</span><div><button style="background:red; color:white; border:none; padding:4px; border-radius:4px" onclick="db.ref('scores/${c.key}/pts').transaction(v=>(v||0)-1)">-1</button><button style="background:green; color:white; border:none; padding:4px; border-radius:4px; margin-left:5px" onclick="db.ref('scores/${c.key}/pts').transaction(v=>(v||0)+1)">+1</button></div></div>`; 
            });
        });
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Console MJ Pro - Presta'Puce</title>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <style>
        :root { --mj-color: #2ecc71; --bg-color: #1a1a1a; --card-bg: #2c3e50; --accent: #f1c40f; --danger: #e74c3c; --blue: #3498db; }
        body { background: var(--bg-color); color: white; font-family: sans-serif; padding: 20px; }
        .box { max-width: 400px; margin: 50px auto; background: var(--card-bg); padding: 30px; border-radius: 15px; text-align: center; }
        .dashboard { display: none; max-width: 800px; margin: auto; }
        input { width: 100%; padding: 10px; margin-bottom: 10px; border-radius: 5px; border: none; }
        button { width: 100%; padding: 12px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; margin-bottom: 10px; }
        .current-player { background: var(--card-bg); border: 4px solid var(--accent); border-radius: 15px; padding: 20px; text-align: center; margin-bottom: 20px; }
        .avatar-img { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; background: #333; display: inline-block; }
        .score-row { display: flex; align-items: center; justify-content: space-between; background: rgba(255,255,255,0.05); padding: 10px; border-radius: 8px; margin-bottom: 5px; }
        .mini-avatar { width: 30px; height: 30px; border-radius: 50%; object-fit: cover; vertical-align: middle; margin-right: 10px; }
    </style>
</head>
<body>
    <div id="screen-login" class="box">
        <h2>Connexion MJ</h2>
        <input type="email" id="mj-email" placeholder="Email">
        <input type="password" id="mj-pass" placeholder="Mot de passe">
        <button style="background:var(--mj-color); color:white" onclick="login()">Se Connecter</button>
    </div>

    <div id="screen-dashboard" class="dashboard">
        <h2 style="text-align:center">SALLE : <span id="display-room">----</span></h2>
        
        <div id="player-box" class="current-player" style="display:none">
            <div id="p-avatar-box"></div>
            <h2 id="p-name"></h2>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <button style="background:var(--accent)" onclick="handleReward(3, 'finish')">+3 Termin√©</button>
                <button style="background:var(--mj-color)" onclick="handleReward(1, 'finish')">+1 Termin√©</button>
                <button style="background:var(--blue); color:white" onclick="handleReward(1, 'partial')">+1 Suite</button>
                <button style="background:var(--danger); color:white" onclick="handleError()">Erreur</button>
            </div>
        </div>

        <div style="display:flex; gap:10px; margin-bottom:20px;">
            <button style="background:var(--blue); color:white" onclick="statusUpdate('ready')">Ouvrir Buzzers</button>
            <button style="background:var(--danger); color:white" onclick="fullReset()">Reset Titre</button>
        </div>

        <h3>Joueurs connect√©s</h3>
        <div id="score-list"></div>
        <button style="background:var(--accent); margin-top:20px;" onclick="triggerEndGame()">üèÅ Fin de partie</button>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAf1Vl_O8SHJeFjHavKBJgUFGGy73I8t-o",
            authDomain: "prestapuce-buzz.firebaseapp.com",
            databaseURL: "https://prestapuce-buzz-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "prestapuce-buzz"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();
        let roomID = "", roomRef = null, currentPlayer = null, allPlayersData = {}, currentBlocked = {};

        function login() {
            auth.signInWithEmailAndPassword(document.getElementById('mj-email').value, document.getElementById('mj-pass').value)
                .then(res => {
                    db.ref('users/' + res.user.uid + '/lastRoom').once('value', snap => {
                        roomID = snap.val() || "1234";
                        document.getElementById('screen-login').style.display = "none";
                        document.getElementById('screen-dashboard').style.display = "block";
                        document.getElementById('display-room').innerText = roomID;
                        roomRef = db.ref('roomsData/' + roomID);
                        initMJLogic();
                    });
                });
        }

        function initMJLogic() {
            roomRef.child('buzzers').on('value', snap => {
                const val = snap.val();
                if(val) {
                    currentPlayer = val;
                    document.getElementById('p-name').innerText = val.pseudo;
                    const avatarBox = document.getElementById('p-avatar-box');
                    if(val.avatar && val.avatar.startsWith('data:image')) avatarBox.innerHTML = `<img src="${val.avatar}" class="avatar-img">`;
                    else avatarBox.innerHTML = `<div style="font-size:3rem">${val.avatar || 'üë§'}</div>`;
                    document.getElementById('player-box').style.display = "block";
                } else document.getElementById('player-box').style.display = "none";
            });
            roomRef.child('scores').on('value', snap => { allPlayersData = snap.val() || {}; renderLobby(); });
            roomRef.child('blockedPlayers').on('value', snap => { currentBlocked = snap.val() || {}; renderLobby(); });
        }

        function renderLobby() {
            const list = document.getElementById('score-list'); list.innerHTML = "";
            Object.keys(allPlayersData).forEach(p => {
                const d = allPlayersData[p]; if(!d.active) return;
                const isBlocked = currentBlocked[p];
                let av = d.avatar && d.avatar.startsWith('data:image') ? `<img src="${d.avatar}" class="mini-avatar">` : `<span>${d.avatar || 'üë§'}</span> `;
                list.innerHTML += `<div class="score-row">
                    <div>${av} <b>${p}</b></div>
                    <div>
                        <button style="width:30px; background:var(--accent)" onclick="forceBuzzer('${p}')">‚ö°</button>
                        <button style="width:30px; background:${isBlocked ? 'red' : 'none'}; border:1px solid red" onclick="toggleBlock('${p}')">üõë</button>
                        <b>${d.pts} pts</b>
                    </div>
                </div>`;
            });
        }

        function forceBuzzer(p) { roomRef.child('gameState').update({ status: 'taken' }); roomRef.child('buzzers').set({ pseudo: p, avatar: allPlayersData[p].avatar }); }
        function toggleBlock(p) { if(currentBlocked[p]) roomRef.child('blockedPlayers/' + p).remove(); else roomRef.child('blockedPlayers/' + p).set(true); }
        function statusUpdate(st) { roomRef.child('gameState').set({ status: st }); if(st === 'ready') roomRef.child('buzzers').remove(); }
        function fullReset() { roomRef.child('blockedPlayers').remove(); roomRef.child('buzzers').remove(); statusUpdate('waiting'); }
        function handleReward(pts, mode) { db.ref('roomsData/'+roomID+'/scores/'+currentPlayer.pseudo+'/pts').transaction(x => (x||0)+pts); if(mode === 'finish') fullReset(); else { roomRef.child('blockedPlayers/'+currentPlayer.pseudo).set(true); statusUpdate('ready'); } }
        function handleError() { roomRef.child('blockedPlayers/'+currentPlayer.pseudo).set(true); statusUpdate('ready'); }
        function triggerEndGame() { roomRef.child('gameState').set({ status: 'endGame' }); }
    </script>
</body>
</html>
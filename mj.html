<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Console MJ - Presta'Puce</title>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
    <style>
        :root { --mj-color: #2ecc71; --bg-color: #1a1a1a; --card-bg: #2c3e50; --text-color: #ffffff; --danger: #e74c3c; --accent: #f1c40f; }
        body { background: var(--bg-color); color: white; font-family: 'Segoe UI', sans-serif; margin: 0; padding: 20px; }
        
        /* Écran de Login */
        .login-box { max-width: 400px; margin: 80px auto; background: var(--card-bg); padding: 30px; border-radius: 15px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
        .logo-login { width: 80px; margin-bottom: 20px; }
        .input-group { position: relative; margin-bottom: 15px; text-align: left; }
        input { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1); box-sizing: border-box; background: #1a1a1a; color: white; font-size: 1rem; }
        
        .show-pass-container { display: flex; align-items: center; justify-content: flex-start; margin-top: -5px; margin-bottom: 15px; font-size: 0.9rem; cursor: pointer; color: #bdc3c7; }
        .show-pass-container input { width: auto; margin-right: 8px; }

        button { background: var(--mj-color); color: white; padding: 14px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; width: 100%; font-size: 1rem; transition: 0.2s; }
        button:hover { filter: brightness(1.1); }

        /* Dashboard */
        .dashboard { display: none; }
        .room-header { background: var(--accent); color: black; padding: 15px; border-radius: 12px; font-weight: 900; margin-bottom: 25px; text-align: center; font-size: 1.4rem; box-shadow: 0 4px 15px rgba(241, 196, 15, 0.3); }
        
        .btn-action { margin-bottom: 10px; font-size: 1.1rem; text-transform: uppercase; }
        .current-player { background: var(--card-bg); padding: 25px; border-radius: 15px; border: 4px solid var(--accent); margin: 20px 0; text-align: center; display: none; animation: pulseBorder 1.5s infinite; }
        @keyframes pulseBorder { 0% { border-color: var(--accent); } 50% { border-color: #e67e22; } 100% { border-color: var(--accent); } }
        
        .score-list { margin-top: 30px; }
        .score-row { display: flex; align-items: center; justify-content: space-between; background: rgba(0,0,0,0.3); padding: 12px; border-radius: 10px; margin-bottom: 8px; border-left: 4px solid #3498db; }
        .btn-pts { width: 40px; height: 40px; border-radius: 50%; padding: 0; line-height: 40px; margin-left: 5px; }

        .team-section { background: rgba(255,255,255,0.05); padding: 15px; border-radius: 12px; margin-top: 20px; }
        .crest-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin: 10px 0; max-height: 120px; overflow-y: auto; padding: 5px; }
        .crest-opt { width: 100%; border-radius: 8px; cursor: pointer; border: 2px solid transparent; transition: 0.2s; }
        .crest-selected { border-color: var(--accent); transform: scale(1.1); background: rgba(241,196,15,0.2); }
    </style>
</head>
<body>

    <div id="screen-login" class="login-box">
        <img src="https://static.wixstatic.com/media/eda9e4_e7ab6af2d5a7428f9bc7e4af454e20ef~mv2.png" class="logo-login">
        <h2 style="margin-top:0;">Accès MJ</h2>
        
        <div class="input-group">
            <input type="text" id="mj-user" placeholder="Identifiant MJ">
        </div>
        
        <div class="input-group">
            <input type="password" id="mj-pass" placeholder="Mot de passe">
        </div>

        <label class="show-pass-container">
            <input type="checkbox" onclick="togglePassword()"> Afficher le mot de passe
        </label>
        
        <button onclick="login()">SE CONNECTER</button>
    </div>

    <div id="screen-dashboard" class="dashboard">
        <div class="room-header">SALLE ACTIVE : <span id="display-room">----</span></div>
        
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
            <button class="btn-action" style="background:#3498db" onclick="statusUpdate('ready')">Ouvrir Buzzers</button>
            <button class="btn-action" style="background:var(--danger)" onclick="fullReset()">Bloquer / Reset</button>
        </div>

        <div id="player-box" class="current-player">
            <div id="p-avatar" style="font-size:4rem"></div>
            <h2 id="p-name" style="margin:10px 0; font-size:2rem;"></h2>
            <div id="p-team" style="color:var(--accent); font-weight:bold; margin-bottom:15px;"></div>
            
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <button style="background:var(--mj-color)" onclick="reward(1, true)">+1 PT (Partiel)</button>
                <button style="background:#8e44ad" onclick="reward(3, false)">+3 PTS (Complet)</button>
            </div>
            <button style="background:#7f8c8d; margin-top:10px;" onclick="errorBlock()">ERREUR / PASSER</button>
        </div>

        <div class="team-section">
            <h3 style="margin-top:0;">Créer une Équipe</h3>
            <input type="text" id="t-name" placeholder="Nom de l'équipe...">
            <div class="crest-grid" id="crest-grid"></div>
            <button style="background:#9b59b6" onclick="addTeam()">Ajouter l'équipe</button>
        </div>

        <div class="score-list">
            <h3>Classement en direct</h3>
            <div id="score-list-content"></div>
        </div>

        <button style="background:black; border:1px solid red; color:red; margin-top:50px;" onclick="resetFullGame()">RESET TOTAL DE LA PARTIE</button>
    </div>

    <script>
        const firebaseConfig = { databaseURL: "https://prestapuce-buzz-default-rtdb.europe-west1.firebasedatabase.app/" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // TES COMPTES MJ
        const mjAccounts = { 
            "prestapuce": "Prest@Puce06", 
            "museikevents": "@Lex1977" 
        };

        let roomID = "", roomRef = null, currentPlayer = null, selCrest = "";
        const crests = ["https://cdn-icons-png.flaticon.com/512/744/744922.png","https://cdn-icons-png.flaticon.com/512/744/744921.png","https://cdn-icons-png.flaticon.com/512/744/744849.png","https://cdn-icons-png.flaticon.com/512/744/744905.png","https://cdn-icons-png.flaticon.com/512/1065/1065545.png","https://cdn-icons-png.flaticon.com/512/1065/1065549.png","https://cdn-icons-png.flaticon.com/512/1065/1065551.png","https://cdn-icons-png.flaticon.com/512/1065/1065553.png","https://cdn-icons-png.flaticon.com/512/1152/1152912.png","https://cdn-icons-png.flaticon.com/512/1152/1152918.png","https://cdn-icons-png.flaticon.com/512/2583/2583344.png","https://cdn-icons-png.flaticon.com/512/2583/2583319.png","https://cdn-icons-png.flaticon.com/512/2583/2583434.png","https://cdn-icons-png.flaticon.com/512/2583/2583351.png"];

        function togglePassword() {
            const p = document.getElementById("mj-pass");
            p.type = p.type === "password" ? "text" : "password";
        }

        function login() {
            const u = document.getElementById('mj-user').value.toLowerCase();
            const p = document.getElementById('mj-pass').value;
            if(mjAccounts[u] === p) { startRoom(); } else { alert("Accès refusé : Identifiants incorrects."); }
        }

        function startRoom() {
            roomID = Math.floor(1000 + Math.random() * 9000).toString();
            document.getElementById('screen-login').style.display = "none";
            document.getElementById('screen-dashboard').style.display = "block";
            document.getElementById('display-room').innerText = roomID;
            
            db.ref('activeRooms/' + roomID).set({ status: 'open', created: Date.now() });
            roomRef = db.ref('roomsData/' + roomID);
            
            initMJLogic();
            initCrestGrid();
        }

        function initMJLogic() {
            roomRef.child('buzzers').on('value', snap => {
                const p = snap.val(); const box = document.getElementById('player-box');
                if(p) { 
                    currentPlayer = p; 
                    document.getElementById('p-avatar').innerText = p.avatar; 
                    document.getElementById('p-name').innerText = p.pseudo; 
                    document.getElementById('p-team').innerText = p.teamName !== "Solo" ? "Équipe : " + p.teamName : "Joueur Solo";
                    box.style.display = "block"; 
                } else { box.style.display = "none"; }
            });
            
            roomRef.child('scores').on('value', snap => {
                const l = document.getElementById('score-list-content'); l.innerHTML = "";
                const players = [];
                snap.forEach(c => { players.push({ name: c.key, ...c.val() }); });
                players.sort((a,b) => b.pts - a.pts).forEach(p => {
                    l.innerHTML += `<div class="score-row">
                        <span>${p.avatar} <b>${p.name}</b> : ${p.pts} pts</span>
                        <div>
                            <button class="btn-pts" style="background:#e67e22" onclick="adj('${p.name}',-1)">-</button>
                            <button class="btn-pts" style="background:#2ecc71" onclick="adj('${p.name}',1)">+</button>
                        </div>
                    </div>`;
                });
            });
        }

        function initCrestGrid() {
            const grid = document.getElementById('crest-grid');
            crests.forEach(c => {
                const img = document.createElement('img'); img.src = c; img.className = 'crest-opt';
                img.onclick = () => { document.querySelectorAll('.crest-opt').forEach(i=>i.classList.remove('crest-selected')); img.classList.add('crest-selected'); selCrest = c; };
                grid.appendChild(img);
            });
        }

        function addTeam() { 
            const n = document.getElementById('t-name').value.trim(); 
            if(n && selCrest) { 
                roomRef.child('teams/' + n).set({ icon: selCrest }); 
                document.getElementById('t-name').value = "";
                alert("Équipe '" + n + "' créée !");
            } else { alert("Donnez un nom et choisissez un logo !"); }
        }

        function statusUpdate(st) { roomRef.child('gameState').set({ status: st }); if(st === 'ready') roomRef.child('buzzers').remove(); }
        function fullReset() { roomRef.child('blockedPlayers').remove(); roomRef.child('buzzers').remove(); statusUpdate('waiting'); }
        
        function reward(pts, keep) { 
            roomRef.child('scores/' + currentPlayer.pseudo).transaction(c => { 
                return { pts: (c ? c.pts : 0) + pts, avatar: currentPlayer.avatar, teamName: currentPlayer.teamName, teamIcon: currentPlayer.teamIcon }; 
            });
            if(keep) { roomRef.child('blockedPlayers/' + currentPlayer.pseudo).set(true); statusUpdate('ready'); } else { fullReset(); }
        }

        function errorBlock() { roomRef.child('blockedPlayers/' + currentPlayer.pseudo).set(true); statusUpdate('ready'); }
        function adj(p, v) { roomRef.child('scores/'+p+'/pts').transaction(x => (x||0)+v); }
        function resetFullGame() { if(confirm("Voulez-vous vraiment tout supprimer et changer de salle ?")) { roomRef.remove(); location.reload(); } }
    </script>
</body>
</html>
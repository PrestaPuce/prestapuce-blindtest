<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Scores - Presta'Puce</title>
    <link rel="icon" id="page-favicon" type="image/png" href="https://static.wixstatic.com/media/eda9e4_e7ab6af2d5a7428f9bc7e4af454e20ef~mv2.png">
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root { --bg-color: #1a1a1a; --accent: #f1c40f; --card-bg: rgba(44, 62, 80, 0.7); --gold: #f1c40f; }
        body { margin: 0; padding: 20px; font-family: 'Segoe UI', sans-serif; background: radial-gradient(circle at center, #2c3e50 0%, #1a1a1a 100%); color: white; height: 100vh; overflow: hidden; box-sizing: border-box; }
        .header-scores { display: flex; align-items: center; justify-content: center; margin-bottom: 20px; gap: 20px; }
        .main-container { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; height: calc(100vh - 150px); }
        .column-title { text-align: center; font-size: 1.8rem; color: var(--accent); text-transform: uppercase; margin-bottom: 15px; border-bottom: 2px solid var(--accent); }
        
        .card { background: var(--card-bg); display: flex; align-items: center; padding: 10px 20px; border-radius: 12px; margin-bottom: 10px; border-left: 5px solid var(--accent); height: 70px; transition: all 0.3s ease; }
        .avatar, .crest { font-size: 2.2rem; width: 65px; display: flex; justify-content: center; align-items: center; }
        .crest-bg { background: white; padding: 4px; border-radius: 8px; display: flex; }
        .crest img { width: 45px; height: 45px; object-fit: contain; }
        .info { flex: 1; margin-left: 15px; }
        .pts { font-size: 2rem; font-weight: 900; background: rgba(0,0,0,0.4); padding: 5px 15px; border-radius: 10px; color: var(--accent); }
        
        #qr-box { position: fixed; bottom: 20px; right: 20px; background: white; padding: 10px; border-radius: 10px; text-align: center; color: black; z-index: 100; }
        .last-buzzed { border: 5px solid #2ecc71 !important; transform: scale(1.02); background: rgba(46, 204, 113, 0.4); box-shadow: 0 0 20px #2ecc71; }
        .inactive-card { opacity: 0.4; filter: grayscale(1); border-left-color: #7f8c8d; }

        /* Hall of Fame Style */
        #hof-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1000; flex-direction: column; align-items: center; justify-content: center; }
        .hof-content { width: 500px; background: #2c3e50; padding: 30px; border-radius: 20px; border: 3px solid var(--accent); }
        .hof-item { display: flex; align-items: center; justify-content: space-between; padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.1); font-size: 1.2rem; }
        
        #btn-hof { position: fixed; bottom: 20px; left: 20px; background: var(--card-bg); border: 1px solid var(--accent); color: white; padding: 10px 20px; border-radius: 20px; cursor: pointer; z-index: 100; font-size: 0.8rem; }
    </style>
</head>
<body>

    <div class="header-scores">
        <a id="mj-logo-link" href="#" target="_blank" style="pointer-events: none;">
            <img id="display-mj-logo" src="https://static.wixstatic.com/media/eda9e4_e7ab6af2d5a7428f9bc7e4af454e20ef~mv2.png" style="width:70px; height:70px; object-fit:contain; border-radius:8px;">
        </a>
        <h1 style="margin:0;">SALLE : <span id="room-title" style="color:var(--accent)">----</span></h1>
    </div>

    <div class="main-container">
        <div>
            <div class="column-title">Joueurs</div>
            <div id="player-list"></div>
        </div>
        <div>
            <div class="column-title">Classement G√©n√©ral</div>
            <div id="global-list"></div>
        </div>
    </div>

    <div id="qr-box">
        <div id="qrcode"></div>
        <div style="font-size: 0.7rem; font-weight: bold; margin-top: 5px;">REJOINDRE</div>
    </div>

    <button id="btn-hof" onclick="toggleHOF()">üèÜ Hall of Fame</button>

    <div id="hof-overlay" onclick="toggleHOF()">
        <div class="hof-content" onclick="event.stopPropagation()">
            <h1 style="color:var(--accent); margin-top:0;">üèÜ TOP 10 MONDIAL</h1>
            <div id="hof-list"></div>
            <button onclick="toggleHOF()" style="margin-top:20px; width:100%; padding:10px; border-radius:10px; border:none; background:var(--accent); font-weight:bold; cursor:pointer;">RETOUR AU JEU</button>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAf1Vl_O8SHJeFjHavKBJgUFGGy73I8t-o",
            authDomain: "prestapuce-buzz.firebaseapp.com",
            databaseURL: "https://prestapuce-buzz-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "prestapuce-buzz",
            storageBucket: "prestapuce-buzz.firebasestorage.app",
            messagingSenderId: "907270883505",
            appId: "1:907270883505:web:197efec0b99db28180ba90",
            measurementId: "G-J04SC2DFFF"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        
        // --- GESTION DE LA SALLE ---
        const urlParams = new URLSearchParams(window.location.search);
        let roomID = urlParams.get('room');
        
        if (!roomID) {
            roomID = prompt("Entrez le nom de la salle :");
            if (roomID) {
                window.location.search = "?room=" + roomID;
            }
        }
        
        document.getElementById('room-title').innerText = roomID;
        const roomRef = db.ref('roomsData/' + roomID);
        
        // URL dynamique pour le QR Code (pointe vers ton dossier actuel)
        const currentPath = window.location.href.split('?')[0].replace('scores', 'index');
        const playURL = currentPath + "?room=" + roomID;
        new QRCode(document.getElementById("qrcode"), { text: playURL, width: 110, height: 110 });

        let scoresData = {}, teamsData = {}, currentBuzzer = null;

        let buzzHistory = []; // Pour m√©moriser l'ordre de la pile

        // --- ECOUTEUR LOGO MJ ---
        roomRef.child('mjLogo').on('value', snap => {
            if(snap.exists()) {
                document.getElementById('display-mj-logo').src = snap.val();
                document.getElementById('page-favicon').href = snap.val(); // Change l'ic√¥ne de l'onglet
            }
        });
        
        roomRef.child('mjLink').on('value', snap => {
            const linkElement = document.getElementById('mj-logo-link');
            if(snap.exists() && snap.val() !== "") {
                linkElement.href = snap.val();
                linkElement.style.pointerEvents = "auto";
                document.getElementById('display-mj-logo').style.cursor = "pointer";
            } else {
                linkElement.href = "#";
                linkElement.style.pointerEvents = "none";
                document.getElementById('display-mj-logo').style.cursor = "default";
            }
        });

        function updateDisplay() {
            const pList = document.getElementById('player-list'); pList.innerHTML = "";
            const gList = document.getElementById('global-list'); gList.innerHTML = "";
            
            const listEquipes = Object.keys(teamsData);
            const allPlayers = Object.entries(scoresData).map(([k,v]) => ({name: k, ...v}));

            // 1. Liste de GAUCHE (Joueurs) - Tri avec Inactifs en bas et Buzzer en haut
            allPlayers.sort((a, b) => {
                // Priorit√© 1 : Les joueurs inactifs vont en bas de la liste
                if (a.active === false && b.active !== false) return 1;
                if (a.active !== false && b.active === false) return -1;

                // Priorit√© 2 : Le joueur qui buzz actuellement va tout en haut
                if (a.name === currentBuzzer) return -1;
                if (b.name === currentBuzzer) return 1;

                // Priorit√© 3 : Utilisation de l'historique des buzz
                let indexA = buzzHistory.indexOf(a.name);
                let indexB = buzzHistory.indexOf(b.name);

                if (indexA !== -1 && indexB !== -1) return indexB - indexA; // Le plus r√©cent (dernier) monte
                if (indexA !== -1) return -1;
                if (indexB !== -1) return 1;

                // Sinon, ordre d'arriv√©e
                return 0;
            }).forEach(p => {
                const isInactive = p.active === false;
                const buzzedClass = (p.name === currentBuzzer) ? "last-buzzed" : "";
                const inactiveClass = isInactive ? "inactive-card" : "";
                
                const enEquipe = p.teamName && listEquipes.includes(p.teamName);
                const labelSub = enEquipe ? p.teamName : "Solo";
                
                // MODIFICATION 1 : G√©rer l'image Base64 pour les joueurs
                let avatarHtml = p.avatar || 'üë§';
                if(p.avatar && p.avatar.startsWith('data:image')) {
                    avatarHtml = `<img src="${p.avatar}" style="width:45px; height:45px; border-radius:50%; object-fit:cover;">`;
                }

                pList.innerHTML += `
                    <div class="card ${buzzedClass} ${inactiveClass}">
                        <div class="avatar">${avatarHtml}</div>
                        <div class="info"><b>${p.name}</b><br><small>${labelSub}</small></div>
                        <div class="pts">${p.pts || 0}</div>
                    </div>`;
            });

            // 2. Liste de DROITE (Classement G√©n√©ral)
            let rankingMap = new Map();

            // Initialisation des √©quipes
            listEquipes.forEach(tName => {
                rankingMap.set("TEAM_" + tName, { name: tName, pts: 0, icon: teamsData[tName].icon, isTeam: true, count: 0 });
            });

            allPlayers.forEach(p => {
                const statutEquipe = (p.teamName && p.teamName !== "Solo") ? p.teamName : "Solo";

                if (statutEquipe !== "Solo") {
                    let team = rankingMap.get("TEAM_" + statutEquipe);
                    if (team) {
                        team.pts += (p.pts || 0);
                        if (p.active !== false) team.count++;
                    }
                } else {
                    rankingMap.set("SOLO_" + p.name, { 
                        name: p.name, 
                        pts: (p.pts || 0), 
                        avatar: p.avatar, 
                        isTeam: false 
                    });
                }
            });

            // Tri final par points et affichage
            Array.from(rankingMap.values()).sort((a,b) => b.pts - a.pts).forEach(item => {
                
                // MODIFICATION 2 : G√©rer l'image Base64 pour les joueurs Solo
                let avatarHtmlGlobal = item.avatar || 'üë§';
                if(item.avatar && item.avatar.startsWith('data:image')) {
                    avatarHtmlGlobal = `<img src="${item.avatar}" style="width:45px; height:45px; border-radius:50%; object-fit:cover;">`;
                }

                const iconHtml = item.isTeam 
                    ? `<div class="crest-bg"><img src="${item.icon}"></div>` 
                    : `<span>${avatarHtmlGlobal}</span>`;
                
                const labelJoueur = (item.count === 1) ? "joueur" : "joueurs";
                const finalName = item.isTeam ? `${item.name} (${item.count} ${labelJoueur})` : `${item.name} (Solo)`;

                gList.innerHTML += `
                    <div class="card">
                        <div class="crest">${iconHtml}</div>
                        <div class="info"><b>${finalName}</b></div>
                        <div class="pts">${item.pts}</div>
                    </div>`;
            });
        }
        
        // Mise √† jour de l'√©couteur de buzz pour g√©rer l'historique
        roomRef.child('buzzers').on('value', snap => {
            const val = snap.val();
            currentBuzzer = val ? val.pseudo : null;
            
            if (currentBuzzer) {
                // Si le joueur n'est pas d√©j√† dans l'historique, on l'ajoute √† la fin (sommet de pile)
                if (!buzzHistory.includes(currentBuzzer)) {
                    buzzHistory.push(currentBuzzer);
                } else {
                    // S'il y √©tait d√©j√†, on le d√©place √† la fin pour qu'il redevienne le "plus r√©cent"
                    buzzHistory = buzzHistory.filter(name => name !== currentBuzzer);
                    buzzHistory.push(currentBuzzer);
                }
            }
            updateDisplay();
        });

        roomRef.child('scores').on('value', snap => { scoresData = snap.val() || {}; updateDisplay(); });
        roomRef.child('teams').on('value', snap => { teamsData = snap.val() || {}; updateDisplay(); });

        function toggleHOF() {
            const overlay = document.getElementById('hof-overlay');
            if(overlay.style.display === "flex") {
                overlay.style.display = "none";
            } else {
                overlay.style.display = "flex";
                db.ref('players').orderByChild('stats/totalScore').limitToLast(10).once('value', snap => {
                    const list = document.getElementById('hof-list');
                    list.innerHTML = "";
                    let pArr = [];
                    snap.forEach(c => { pArr.push({p:c.val().pseudo, a:c.val().avatar, s:c.val().stats.totalScore}); });
                    pArr.reverse().forEach((player, i) => {
                        
                        // MODIFICATION 3 : G√©rer l'image Base64 dans le Hall of Fame
                        let hofAv = player.a || 'üë§';
                        if(player.a && player.a.startsWith('data:image')) {
                            hofAv = `<img src="${player.a}" style="width:30px; height:30px; border-radius:50%; object-fit:cover; vertical-align:middle;">`;
                        }

                        list.innerHTML += `<div class="hof-item"><span>${i+1}. ${hofAv} <b>${player.p}</b></span><b style="color:var(--accent)">${player.s} pts</b></div>`;
                    });
                });
            }
        }
    </script>
</body>
</html>
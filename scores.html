<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Scores - Presta'Puce</title>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root { --bg-color: #1a1a1a; --accent: #f1c40f; --card-bg: rgba(44, 62, 80, 0.7); }
        body { margin: 0; padding: 20px; font-family: 'Segoe UI', sans-serif; background: radial-gradient(circle at center, #2c3e50 0%, #1a1a1a 100%); color: white; height: 100vh; overflow: hidden; box-sizing: border-box; }
        .main-container { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; height: calc(100vh - 120px); }
        .column-title { text-align: center; font-size: 1.8rem; color: var(--accent); text-transform: uppercase; margin-bottom: 15px; border-bottom: 2px solid var(--accent); }
        .card { background: var(--card-bg); display: flex; align-items: center; padding: 10px 20px; border-radius: 12px; margin-bottom: 10px; border-left: 5px solid var(--accent); transition: 0.3s; }
        .avatar, .crest { font-size: 2.2rem; width: 60px; text-align: center; display: flex; justify-content: center; }
        .crest img { width: 45px; height: 45px; object-fit: contain; }
        .info { flex: 1; margin-left: 15px; }
        .pts { font-size: 1.8rem; font-weight: 900; background: rgba(0,0,0,0.3); padding: 5px 15px; border-radius: 8px; }
        #qr-box { position: fixed; bottom: 20px; right: 20px; background: white; padding: 12px; border-radius: 12px; text-align: center; color: black; font-weight: bold; font-size: 0.8rem; }
        .last-buzzed { border: 4px solid var(--accent) !important; transform: scale(1.02); background: rgba(241, 196, 15, 0.2); }
    </style>
</head>
<body>
    <div style="text-align:center; margin-bottom:15px;"><h1 style="margin:0;">SALLE : <span id="room-title">----</span></h1></div>
    <div class="main-container">
        <div><div class="column-title">Joueurs</div><div id="player-list"></div></div>
        <div><div class="column-title">GÃ©nÃ©ral</div><div id="global-list"></div></div>
    </div>
    <div id="qr-box"><div id="qrcode"></div><div style="margin-top:5px;">SCANNEZ POUR JOUER</div></div>

    <script>
        const firebaseConfig = { databaseURL: "https://prestapuce-buzz-default-rtdb.europe-west1.firebasedatabase.app/" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const roomID = prompt("Code de la salle ?");
        document.getElementById('room-title').innerText = roomID;
        const roomRef = db.ref('roomsData/' + roomID);

        const playURL = "https://prestapuce.github.io/prestapuce-blindtest/?room=" + roomID;
        new QRCode(document.getElementById("qrcode"), { text: playURL, width: 110, height: 110 });

        roomRef.child('scores').on('value', snap => {
            const players = []; snap.forEach(c => { players.push({ name: c.key, ...c.val() }); });
            players.sort((a,b) => b.pts - a.pts);
            
            const pList = document.getElementById('player-list'); pList.innerHTML = "";
            players.forEach(p => {
                pList.innerHTML += `<div class="card" id="card-${p.name}"><div class="avatar">${p.avatar}</div><div class="info"><b>${p.name}</b><br><small>${p.teamName}</small></div><div class="pts">${p.pts}</div></div>`;
            });

            const teamScores = {};
            players.forEach(p => {
                const tKey = (p.teamName === "Solo") ? p.name : p.teamName;
                const tIcon = (p.teamName === "Solo") ? null : p.teamIcon;
                if(!teamScores[tKey]) teamScores[tKey] = { pts: 0, icon: tIcon, type: p.teamName };
                teamScores[tKey].pts += p.pts;
            });

            const gList = document.getElementById('global-list'); gList.innerHTML = "";
            Object.entries(teamScores).sort((a,b)=>b[1].pts - a[1].pts).forEach(([name, d]) => {
                const icon = d.icon ? `<img src="${d.icon}">` : `<span style="font-size:1.5rem">ðŸ‘¤</span>`;
                gList.innerHTML += `<div class="card"><div class="crest">${icon}</div><div class="info"><b>${name}</b></div><div class="pts">${d.pts}</div></div>`;
            });
        });

        roomRef.child('buzzers').on('value', snap => {
            document.querySelectorAll('.card').forEach(c => c.classList.remove('last-buzzed'));
            if(snap.exists()) { const c = document.getElementById('card-' + snap.val().pseudo); if(c) c.classList.add('last-buzzed'); }
        });
    </script>
</body>
</html>
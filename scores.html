<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Scores - Presta'Puce</title>
    <link rel="icon" id="page-favicon" type="image/png" href="https://static.wixstatic.com/media/eda9e4_e7ab6af2d5a7428f9bc7e4af454e20ef~mv2.png">
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root { --bg-color: #1a1a1a; --accent: #f1c40f; --card-bg: rgba(44, 62, 80, 0.7); --gold: #f1c40f; }
        body { margin: 0; padding: 20px; font-family: 'Segoe UI', sans-serif; background: radial-gradient(circle at center, #2c3e50 0%, #1a1a1a 100%); color: white; height: 100vh; overflow: hidden; box-sizing: border-box; }
        
        .header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
        .mj-logo-display { width: 60px; height: 60px; object-fit: contain; border-radius: 10px; background: rgba(0,0,0,0.5); padding: 5px; }
        .room-badge { background: var(--accent); color: black; padding: 10px 20px; border-radius: 20px; font-weight: bold; font-size: 1.5rem; letter-spacing: 2px; box-shadow: 0 4px 15px rgba(241, 196, 15, 0.3); }
        
        .layout { display: flex; gap: 20px; height: calc(100vh - 100px); }
        
        .left-panel { flex: 1; display: flex; flex-direction: column; background: rgba(0,0,0,0.3); border-radius: 20px; padding: 20px; border: 1px solid rgba(255,255,255,0.1); }
        .buzz-zone { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
        .buzz-avatar { font-size: 8rem; margin-bottom: 20px; filter: drop-shadow(0 0 20px rgba(241,196,15,0.5)); animation: pulse 1s infinite alternate; }
        .buzz-img { width: 150px; height: 150px; border-radius: 50%; object-fit: cover; border: 5px solid var(--accent); margin-bottom: 20px; box-shadow: 0 0 30px rgba(241,196,15,0.6); animation: pulse 1s infinite alternate; }
        .buzz-name { font-size: 3rem; font-weight: 900; color: white; text-transform: uppercase; letter-spacing: 2px; margin: 0; }
        .buzz-team { font-size: 1.5rem; color: var(--accent); margin-top: 10px; }
        
        @keyframes pulse { from { transform: scale(1); } to { transform: scale(1.1); } }
        
        .right-panel { width: 400px; background: rgba(0,0,0,0.4); border-radius: 20px; padding: 20px; display: flex; flex-direction: column; border: 1px solid rgba(255,255,255,0.1); }
        .leaderboard-title { text-align: center; color: var(--accent); font-size: 1.5rem; margin-top: 0; margin-bottom: 20px; text-transform: uppercase; letter-spacing: 2px; border-bottom: 2px solid rgba(255,255,255,0.1); padding-bottom: 10px; }
        
        .list-container { flex: 1; overflow-y: auto; padding-right: 10px; }
        .list-container::-webkit-scrollbar { width: 8px; }
        .list-container::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 4px; }
        
        .score-card { background: var(--card-bg); padding: 15px; border-radius: 12px; margin-bottom: 10px; display: flex; align-items: center; justify-content: space-between; transition: 0.3s; border-left: 5px solid transparent; }
        .winner-card { border-left-color: var(--gold); background: rgba(241, 196, 15, 0.1); }
        .buzzing-card { border-left-color: #e74c3c; background: rgba(231, 76, 60, 0.2); transform: translateX(-10px); }
        
        .rank { font-size: 1.5rem; font-weight: bold; color: rgba(255,255,255,0.5); width: 40px; }
        .avatar-circle { width: 45px; height: 45px; border-radius: 50%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; font-size: 1.5rem; margin-right: 15px; overflow: hidden; }
        .avatar-circle img { width: 100%; height: 100%; object-fit: cover; }
        .player-info { flex: 1; text-align: left; overflow: hidden; }
        .p-name { font-size: 1.2rem; font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .p-team { font-size: 0.8rem; color: #aaa; }
        .p-score { font-size: 1.8rem; font-weight: 900; color: var(--accent); }
        .p-score span { font-size: 0.8rem; color: white; font-weight: normal; }

        .qr-container { position: absolute; bottom: 20px; left: 20px; background: white; padding: 10px; border-radius: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        
        #hof-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10000; align-items: center; justify-content: center; flex-direction: column; }
        .hof-box { background: var(--card-bg); padding: 40px; border-radius: 20px; width: 80%; max-width: 600px; text-align: center; border: 2px solid var(--accent); }
        .hof-title { color: var(--accent); font-size: 2.5rem; margin-top: 0; }
        .hof-item { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.1); font-size: 1.2rem; }
    </style>
</head>
<body>
    <div class="header">
        <img id="mj-logo" src="https://static.wixstatic.com/media/eda9e4_e7ab6af2d5a7428f9bc7e4af454e20ef~mv2.png" class="mj-logo-display">
        <div class="room-badge">SALLE : <span id="room-id-display">----</span></div>
        <button onclick="toggleHOF()" style="background:var(--accent); border:none; padding:10px 20px; border-radius:8px; font-weight:bold; cursor:pointer;">üèÜ Hall of Fame</button>
    </div>

    <div class="layout">
        <div class="left-panel">
            <h2 style="margin:0; color:rgba(255,255,255,0.5); text-align:center;">BUZZER ACTUEL</h2>
            <div class="buzz-zone" id="current-buzz-display">
                <div style="color:rgba(255,255,255,0.2); font-size:2rem; font-style:italic;">En attente...</div>
            </div>
            
            <div style="margin-top:20px; border-top:1px solid rgba(255,255,255,0.1); padding-top:15px;">
                <h4 style="margin:0 0 10px 0; color:#aaa;">Ordre de buzz :</h4>
                <div id="buzz-history" style="display:flex; gap:10px; overflow-x:auto;"></div>
            </div>
        </div>

        <div class="right-panel">
            <h2 class="leaderboard-title">CLASSEMENT</h2>
            <div class="list-container" id="leaderboard">
                </div>
        </div>
    </div>

    <div class="qr-container" id="qrcode"></div>

    <div id="hof-overlay">
        <div class="hof-box">
            <h2 class="hof-title">üèÜ HALL OF FAME üèÜ</h2>
            <p style="color:#aaa; margin-bottom:20px;">Les meilleurs joueurs de tous les temps (Total des points cumul√©s)</p>
            <div id="hof-list"></div>
            <button onclick="toggleHOF()" style="margin-top:30px; background:var(--danger); color:white; border:none; padding:10px 20px; border-radius:8px; font-weight:bold; cursor:pointer;">Fermer</button>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAf1Vl_O8SHJeFjHavKBJgUFGGy73I8t-o",
            databaseURL: "https://prestapuce-buzz-default-rtdb.europe-west1.firebasedatabase.app"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        const urlParams = new URLSearchParams(window.location.search);
        const roomID = urlParams.get('room');
        
        let scoresData = {};
        let teamsData = {};
        let currentBuzzer = null;
        let buzzHistory = [];
        let currentGameState = 'waiting';

        if(roomID) {
            document.getElementById('room-id-display').innerText = roomID;
            
            // G√©n√©ration QR Code
            const joinUrl = window.location.origin + window.location.pathname.replace('scores', 'index') + "?room=" + roomID;
            new QRCode(document.getElementById("qrcode"), { text: joinUrl, width: 100, height: 100 });

            // Logo personnalis√© du MJ
            db.ref('roomsData/' + roomID + '/mjLogo').on('value', snap => {
                if(snap.exists()) document.getElementById('mj-logo').src = snap.val();
            });

            // √âcoute de l'√©tat global du jeu pour r√©initialiser l'historique des buzzs
            db.ref('roomsData/' + roomID + '/gameState').on('value', snap => {
                const val = snap.val();
                const status = val ? val.status : 'waiting';
                
                if(status === 'waiting' || status === 'ready') {
                    if(currentGameState !== 'waiting' && currentGameState !== 'ready') {
                        buzzHistory = []; // Reset √† la nouvelle manche
                    }
                }
                currentGameState = status;
                updateDisplay();
            });

            db.ref('roomsData/' + roomID + '/buzzers').on('value', snap => {
                const val = snap.val();
                if(val && val.pseudo) {
                    currentBuzzer = val.pseudo;
                    if(!buzzHistory.includes(currentBuzzer)) {
                        buzzHistory.push(currentBuzzer);
                    }
                } else {
                    currentBuzzer = null;
                }
                updateDisplay();
            });

            db.ref('roomsData/' + roomID + '/scores').on('value', snap => { scoresData = snap.val() || {}; updateDisplay(); });
            db.ref('roomsData/' + roomID + '/teams').on('value', snap => { teamsData = snap.val() || {}; updateDisplay(); });
        }

        function updateDisplay() {
            // 1. MISE √Ä JOUR DU LEADERBOARD
            const players = Object.keys(scoresData)
                .map(p => ({ name: p, ...scoresData[p] }))
                .filter(p => p.active !== false)
                .sort((a, b) => b.pts - a.pts);

            const container = document.getElementById('leaderboard');
            container.innerHTML = "";
            
            players.forEach((p, i) => {
                const isWinner = i === 0 && p.pts > 0;
                const isBuzzing = p.name === currentBuzzer;

                // LOGIQUE D'AFFICHAGE DE L'IMAGE BASE64
                let avatarHtml = p.avatar;
                if(p.avatar && p.avatar.startsWith('data:image')) {
                    avatarHtml = `<img src="${p.avatar}" style="width:100%; height:100%; object-fit:cover;">`;
                }

                container.innerHTML += `
                    <div class="score-card ${isWinner ? 'winner-card' : ''} ${isBuzzing ? 'buzzing-card' : ''}">
                        <div class="rank">#${i + 1}</div>
                        <div class="avatar-circle">${avatarHtml}</div>
                        <div class="player-info">
                            <div class="p-name">${p.name}</div>
                            <div class="p-team">${p.teamName || 'Ind√©pendant'}</div>
                        </div>
                        <div class="p-score">${p.pts} <span>pts</span></div>
                    </div>`;
            });

            // 2. MISE √Ä JOUR DU BUZZER CENTRAL
            const buzzZone = document.getElementById('current-buzz-display');
            if(currentBuzzer && scoresData[currentBuzzer]) {
                const d = scoresData[currentBuzzer];
                
                let bigAvatarHtml = `<div class="buzz-avatar">${d.avatar || 'üë§'}</div>`;
                if(d.avatar && d.avatar.startsWith('data:image')) {
                    bigAvatarHtml = `<img src="${d.avatar}" class="buzz-img">`;
                }

                buzzZone.innerHTML = `
                    ${bigAvatarHtml}
                    <h2 class="buzz-name">${currentBuzzer}</h2>
                    <div class="buzz-team">${d.teamName || 'Solo'}</div>
                `;
            } else {
                buzzZone.innerHTML = `<div style="color:rgba(255,255,255,0.2); font-size:2rem; font-style:italic;">En attente...</div>`;
            }

            // 3. MISE √Ä JOUR DE L'HISTORIQUE DE BUZZ
            const histZone = document.getElementById('buzz-history');
            histZone.innerHTML = "";
            buzzHistory.forEach((pName, index) => {
                const d = scoresData[pName];
                if(d) {
                    let smallAvHtml = `<div style="width:40px; height:40px; border-radius:50%; background:rgba(0,0,0,0.5); display:flex; align-items:center; justify-content:center; font-size:1.2rem;">${d.avatar || 'üë§'}</div>`;
                    if(d.avatar && d.avatar.startsWith('data:image')) {
                        smallAvHtml = `<img src="${d.avatar}" style="width:40px; height:40px; border-radius:50%; object-fit:cover;">`;
                    }

                    histZone.innerHTML += `
                        <div style="display:flex; flex-direction:column; align-items:center; opacity:${index === buzzHistory.length-1 ? '1' : '0.5'};">
                            <div style="font-size:0.7rem; color:#aaa; margin-bottom:2px;">${index+1}</div>
                            ${smallAvHtml}
                            <div style="font-size:0.8rem; margin-top:2px;">${pName}</div>
                        </div>
                    `;
                }
            });
        }

        function toggleHOF() {
            const overlay = document.getElementById('hof-overlay');
            if(overlay.style.display === "flex") {
                overlay.style.display = "none";
            } else {
                overlay.style.display = "flex";
                db.ref('players').orderByChild('stats/totalScore').limitToLast(10).once('value', snap => {
                    const list = document.getElementById('hof-list');
                    list.innerHTML = "";
                    let pArr = [];
                    snap.forEach(c => { pArr.push({p:c.val().pseudo, a:c.val().avatar, s:c.val().stats.totalScore}); });
                    pArr.reverse().forEach((player, i) => {
                        let hofAv = player.a;
                        if(player.a && player.a.startsWith('data:image')) {
                            hofAv = `<img src="${player.a}" style="width:30px; height:30px; border-radius:50%; object-fit:cover; vertical-align:middle;">`;
                        }

                        list.innerHTML += `<div class="hof-item"><span>${i+1}. ${hofAv} <b>${player.p}</b></span><b style="color:var(--accent)">${player.s} pts</b></div>`;
                    });
                });
            }
        }
    </script>
</body>
</html>
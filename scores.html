<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Scores - Presta'Puce</title>
    <link rel="icon" type="image/png" href="https://static.wixstatic.com/media/eda9e4_e7ab6af2d5a7428f9bc7e4af454e20ef~mv2.png">
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root { --bg-color: #1a1a1a; --accent: #f1c40f; --card-bg: rgba(44, 62, 80, 0.7); }
        body { margin: 0; padding: 20px; font-family: 'Segoe UI', sans-serif; background: radial-gradient(circle at center, #2c3e50 0%, #1a1a1a 100%); color: white; height: 100vh; overflow: hidden; box-sizing: border-box; }
        .header-scores { display: flex; align-items: center; justify-content: center; margin-bottom: 20px; gap: 20px; }
        .main-container { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; height: calc(100vh - 150px); }
        .column-title { text-align: center; font-size: 1.8rem; color: var(--accent); text-transform: uppercase; margin-bottom: 15px; border-bottom: 2px solid var(--accent); }
        .card { background: var(--card-bg); display: flex; align-items: center; padding: 10px 20px; border-radius: 12px; margin-bottom: 10px; border-left: 5px solid var(--accent); height: 70px; }
        .avatar, .crest { font-size: 2.2rem; width: 65px; display: flex; justify-content: center; align-items: center; }
        .crest-bg { background: white; padding: 4px; border-radius: 8px; display: flex; }
        .crest img { width: 45px; height: 45px; object-fit: contain; }
        .info { flex: 1; margin-left: 15px; }
        .pts { font-size: 2rem; font-weight: 900; background: rgba(0,0,0,0.4); padding: 5px 15px; border-radius: 10px; color: var(--accent); }
        #qr-box { position: fixed; bottom: 20px; right: 20px; background: white; padding: 10px; border-radius: 10px; text-align: center; color: black; }
        .last-buzzed { border: 5px solid #2ecc71 !important; transform: scale(1.02); background: rgba(46, 204, 113, 0.2); }
    </style>
</head>
<body>
    <div class="header-scores">
        <img src="https://static.wixstatic.com/media/eda9e4_e7ab6af2d5a7428f9bc7e4af454e20ef~mv2.png" style="width:70px;">
        <h1 style="margin:0;">SALLE : <span id="room-title" style="color:var(--accent)">----</span></h1>
    </div>
    <div class="main-container">
        <div><div class="column-title">Joueurs</div><div id="player-list"></div></div>
        <div><div class="column-title">Classement Général</div><div id="global-list"></div></div>
    </div>
    <div id="qr-box"><div id="qrcode"></div><div style="font-size:0.7rem; font-weight:bold; margin-top:5px;">REJOINDRE</div></div>
    <script>
        const firebaseConfig = { databaseURL: "https://prestapuce-buzz-default-rtdb.europe-west1.firebasedatabase.app/" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const roomID = prompt("Code de la salle ?");
        document.getElementById('room-title').innerText = roomID;
        const roomRef = db.ref('roomsData/' + roomID);
        const playURL = "https://prestapuce.github.io/prestapuce-blindtest/index.html?room=" + roomID;
        new QRCode(document.getElementById("qrcode"), { text: playURL, width: 110, height: 110, correctLevel : QRCode.CorrectLevel.H });

        let scoresData = {}, teamsData = {};

        function updateDisplay() {
            const pList = document.getElementById('player-list'); pList.innerHTML = "";
            const gList = document.getElementById('global-list'); gList.innerHTML = "";
            
            // 1. Joueurs Actifs (Colonne de gauche)
            const activePlayers = []; 
            Object.entries(scoresData).forEach(([k,v]) => { if(v.active !== false) activePlayers.push({name: k, ...v}); });
            activePlayers.sort((a,b) => b.pts - a.pts).forEach(p => {
                const teamLabel = (p.teamName && p.teamName !== "Solo") ? p.teamName : "Solo";
                pList.innerHTML += `<div class="card" id="card-${p.name}"><div class="avatar">${p.avatar}</div><div class="info"><b>${p.name}</b><br><small>${teamLabel}</small></div><div class="pts">${p.pts}</div></div>`;
            });

            // 2. Classement Général (Colonne de droite)
            let global = [];

            // ÉQUIPES
            Object.entries(teamsData).forEach(([tName, tInfo]) => {
                let count = 0; let totalPts = 0;
                Object.values(scoresData).forEach(p => { 
                    // Un joueur est dans cette équipe si c'est son teamName actuel OU son lastTeam (si inactif)
                    const currentTeam = p.teamName;
                    const lastTeam = p.lastTeam;
                    
                    if (p.active !== false) {
                        if (currentTeam === tName) { totalPts += p.pts; count++; }
                    } else {
                        if (lastTeam === tName) { totalPts += p.pts; }
                    }
                });
                if (totalPts > 0 || count > 0) global.push({ name: `${tName} (${count} joueurs)`, pts: totalPts, icon: tInfo.icon, isTeam: true });
            });

            // SOLOS
            Object.entries(scoresData).forEach(([pName, pData]) => {
                const isSoloNow = (!pData.teamName || pData.teamName === "Solo" || pData.teamName === "");
                const wasSoloBefore = (!pData.lastTeam || pData.lastTeam === "Solo" || pData.lastTeam === "");

                // On affiche en Solo SEULEMENT si son dernier état connu est Solo
                if ((pData.active !== false && isSoloNow) || (pData.active === false && wasSoloBefore)) {
                    // Petite sécurité supplémentaire pour éviter les doublons si lastTeam est mal rempli
                    if (pData.active === false && !wasSoloBefore) return; 

                    global.push({ name: `${pName} (Solo)`, pts: pData.pts, icon: pData.avatar, isTeam: false });
                }
            });

            global.sort((a,b) => b.pts - a.pts).forEach(item => {
                const iconContent = item.isTeam ? `<div class="crest-bg"><img src="${item.icon}"></div>` : `<span>${item.icon}</span>`;
                gList.innerHTML += `<div class="card"><div class="crest">${iconContent}</div><div class="info"><b>${item.name}</b></div><div class="pts">${item.pts}</div></div>`;
            });
        }
        roomRef.child('scores').on('value', snap => { scoresData = snap.val() || {}; updateDisplay(); });
        roomRef.child('teams').on('value', snap => { teamsData = snap.val() || {}; updateDisplay(); });
        roomRef.child('buzzers').on('value', snap => {
            document.querySelectorAll('.card').forEach(c => c.classList.remove('last-buzzed'));
            if(snap.exists()) { const card = document.getElementById('card-' + snap.val().pseudo); if(card) card.classList.add('last-buzzed'); }
        });
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Scores - Presta'Puce</title>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root { --bg-color: #1a1a1a; --accent: #f1c40f; --card-bg: rgba(44, 62, 80, 0.7); }
        body { margin: 0; padding: 20px; font-family: 'Segoe UI', sans-serif; background: radial-gradient(circle at center, #2c3e50 0%, #1a1a1a 100%); color: white; height: 100vh; overflow: hidden; box-sizing: border-box; }
        .main-container { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; height: calc(100vh - 120px); }
        .column-title { text-align: center; font-size: 1.8rem; color: var(--accent); text-transform: uppercase; margin-bottom: 15px; border-bottom: 2px solid var(--accent); }
        .card { background: var(--card-bg); display: flex; align-items: center; padding: 10px 20px; border-radius: 12px; margin-bottom: 10px; border-left: 5px solid var(--accent); }
        .avatar, .crest { font-size: 2rem; width: 50px; text-align: center; }
        .crest img { width: 40px; height: 40px; }
        .info { flex: 1; margin-left: 15px; }
        .pts { font-size: 1.6rem; font-weight: 900; background: rgba(0,0,0,0.3); padding: 5px 15px; border-radius: 8px; }
        #qr-box { position: fixed; bottom: 20px; right: 20px; background: white; padding: 15px; border-radius: 15px; text-align: center; color: black; font-weight: bold; }
        .last-buzzed { border: 4px solid var(--accent) !important; transform: scale(1.02); animation: flash 0.5s infinite; }
        @keyframes flash { from { opacity: 1; } to { opacity: 0.7; } }
    </style>
</head>
<body>
    <div style="text-align:center; margin-bottom:20px;">
        <h1 style="margin:0;">SALLE : <span id="room-code-title">----</span></h1>
    </div>

    <div class="main-container">
        <div><div class="column-title">Joueurs</div><div id="player-list"></div></div>
        <div><div class="column-title">GÃ©nÃ©ral</div><div id="global-list"></div></div>
    </div>

    <div id="qr-box">
        <div id="qrcode"></div>
        <div style="margin-top:10px;">SCANNEZ POUR JOUER</div>
        <div id="qr-url" style="font-size: 0.7rem; color: #666;"></div>
    </div>

    <script>
        const firebaseConfig = { databaseURL: "https://prestapuce-buzz-default-rtdb.europe-west1.firebasedatabase.app/" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let roomID = prompt("Entrez le code de la salle gÃ©nÃ©rÃ© par le MJ :");
        document.getElementById('room-code-title').innerText = roomID;
        const roomRef = db.ref('roomsData/' + roomID);

        // QR Code
        const playURL = "https://prestapuce.github.io/prestapuce-blindtest/?room=" + roomID;
        document.getElementById('qr-url').innerText = playURL;
        new QRCode(document.getElementById("qrcode"), { text: playURL, width: 120, height: 120 });

        roomRef.child('scores').on('value', snap => {
            const scores = snap.val() || {};
            const pList = document.getElementById('player-list');
            const gList = document.getElementById('global-list');
            pList.innerHTML = ""; gList.innerHTML = "";

            const players = Object.entries(scores).sort((a,b) => b[1].pts - a[1].pts);
            
            // Joueurs
            players.forEach(([pseudo, data]) => {
                pList.innerHTML += `<div class="card" id="card-${pseudo}"><div class="avatar">${data.avatar}</div><div class="info"><b>${pseudo}</b><br><small>${data.teamName}</small></div><div class="pts">${data.pts}</div></div>`;
            });

            // GÃ©nÃ©ral (SimplifiÃ© pour l'exemple)
            const teamScores = {};
            players.forEach(([pseudo, data]) => {
                const t = data.teamName || "Solo";
                if(!teamScores[t]) teamScores[t] = { pts: 0, icon: data.teamIcon };
                teamScores[t].pts += data.pts;
            });
            Object.entries(teamScores).sort((a,b)=>b[1].pts - a[1].pts).forEach(([name, d]) => {
                const icon = d.icon ? `<img src="${d.icon}">` : "ðŸ‘¤";
                gList.innerHTML += `<div class="card"><div class="crest">${icon}</div><div class="info"><b>${name}</b></div><div class="pts">${d.pts}</div></div>`;
            });
        });

        roomRef.child('buzzers').on('value', snap => {
            document.querySelectorAll('.card').forEach(c => c.classList.remove('last-buzzed'));
            if(snap.exists()) {
                const c = document.getElementById('card-' + snap.val().pseudo);
                if(c) c.classList.add('last-buzzed');
            }
        });
    </script>
</body>
</html>
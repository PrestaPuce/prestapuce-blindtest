<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Live Scores - Presta'Puce</title>
    <link rel="icon" type="image/png" href="https://static.wixstatic.com/media/eda9e4_e7ab6af2d5a7428f9bc7e4af454e20ef~mv2.png">
    
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        :root { --gold: #f1c40f; --silver: #bdc3c7; --bronze: #cd7f32; --bg: #1a1a1a; --card: #2c3e50; }
        body { 
            background: var(--bg); 
            color: white; 
            font-family: 'Segoe UI', sans-serif; 
            margin: 0; 
            overflow-y: auto; 
            text-align: center; 
        }
        body::-webkit-scrollbar { display: none; } /* Cache la barre de scroll */

        .page { 
            display: none; 
            min-height: 100vh; 
            flex-direction: column; 
            align-items: center; 
            justify-content: flex-start; 
            padding: 100px 50px; 
            box-sizing: border-box; 
        }
        .active { display: flex; }

        h1 { font-size: 3rem; margin-bottom: 30px; text-transform: uppercase; color: var(--gold); text-shadow: 0 0 20px rgba(241,196,15,0.5); }

        /* Grille des scores en direct */
        .scores-container { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); 
            gap: 20px; 
            width: 100%; 
            max-width: 1400px; 
        }

        .score-card { 
            background: var(--card); 
            padding: 20px; 
            border-radius: 20px; 
            border: 2px solid rgba(255,255,255,0.1); 
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            position: relative;
        }
        
        /* Style sp√©cial Buzzer */
        .score-card.buzzed { 
            border-color: var(--gold); 
            box-shadow: 0 0 40px var(--gold); 
            transform: scale(1.1); 
            z-index: 10;
            background: #34495e;
        }

        /* Style Joueur ayant quitt√© */
        .score-card.inactive { 
            opacity: 0.4; 
            filter: grayscale(1); 
            transform: scale(0.9);
        }

        .avatar { font-size: 3.5rem; display: block; margin-bottom: 10px; }
        .pseudo { font-size: 1.5rem; font-weight: bold; display: block; overflow: hidden; text-overflow: ellipsis; }
        .points { font-size: 2rem; color: var(--gold); font-weight: bold; }

        /* Hall of Fame Style */
        .hof-list { width: 100%; max-width: 700px; background: rgba(0,0,0,0.3); padding: 20px; border-radius: 20px; }
        .hof-item { display: flex; align-items: center; justify-content: space-between; padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); font-size: 1.5rem; }
        .rank { width: 50px; font-weight: bold; font-size: 2rem; }
        .rank-1 { color: var(--gold); }

        /* √âl√©ments fixes */
        #qr-box { 
            position: fixed; top: 20px; right: 20px; 
            background: white; padding: 10px; border-radius: 10px; 
            border: 5px solid var(--gold); z-index: 100; 
        }
        #toggle-btn { 
            position: fixed; bottom: 20px; left: 20px; 
            background: var(--card); border: 2px solid var(--gold); 
            color: white; padding: 12px 25px; border-radius: 30px; 
            cursor: pointer; font-weight: bold; z-index: 100;
        }
    </style>
</head>
<body>

    <button id="toggle-btn" onclick="toggleView()">üèÜ Voir Hall of Fame</button>

    <div id="qr-box">
        <div id="qrcode"></div>
        <p style="color:black; margin:5px 0 0 0; font-weight:bold; font-size:0.7rem;">SCANNE POUR JOUER</p>
    </div>

    <div id="page-live" class="page active">
        <h1 id="room-title">LIVE SCORES</h1>
        <div id="live-list" class="scores-container"></div>
    </div>

    <div id="page-hof" class="page">
        <h1>üèÜ CLASSEMENT MONDIAL üèÜ</h1>
        <div id="hof-display" class="hof-list"></div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAf1Vl_O8SHJeFjHavKBJgUFGGy73I8t-o",
            authDomain: "prestapuce-buzz.firebaseapp.com",
            databaseURL: "https://prestapuce-buzz-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "prestapuce-buzz",
            storageBucket: "prestapuce-buzz.firebasestorage.app",
            messagingSenderId: "907270883505",
            appId: "1:907270883505:web:197efec0b99db28180ba90"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let roomID = new URLSearchParams(window.location.search).get('room');
        let currentView = "live";

        if(roomID) {
            document.getElementById('room-title').innerText = "SALLE " + roomID;
            new QRCode(document.getElementById("qrcode"), {
                text: "https://prestapuce.github.io/prestapuce-blindtest/index.html?room=" + roomID,
                width: 130, height: 130
            });
            initLiveScores(roomID);
        }

        function initLiveScores(id) {
            db.ref('roomsData/' + id).on('value', snap => {
                const data = snap.val();
                if(!data || !data.scores) return;

                const list = document.getElementById('live-list');
                const buzzedPlayer = data.buzzers ? data.buzzers.pseudo : null;
                
                // Conversion en tableau pour le tri personnalis√©
                const players = Object.entries(data.scores);

                players.sort((a, b) => {
                    const nameA = a[0], infoA = a[1];
                    const nameB = b[0], infoB = b[1];

                    // 1. LE BUZZER : Priorit√© n¬∞1 (Toujours en haut)
                    if (nameA === buzzedPlayer) return -1;
                    if (nameB === buzzedPlayer) return 1;

                    // 2. LES SORTANTS : Priorit√© de fin (Toujours en bas)
                    if (infoA.active === false && infoB.active !== false) return 1;
                    if (infoA.active !== false && infoB.active === false) return -1;

                    // 3. LE SCORE : Tri classique pour les autres
                    return infoB.pts - infoA.pts;
                });

                list.innerHTML = "";
                players.forEach(([pseudo, info]) => {
                    const isBuzzed = (pseudo === buzzedPlayer);
                    const isInactive = (info.active === false);
                    
                    list.innerHTML += `
                        <div class="score-card ${isBuzzed ? 'buzzed' : ''} ${isInactive ? 'inactive' : ''}">
                            <span class="avatar">${info.avatar}</span>
                            <span class="pseudo">${pseudo}</span>
                            <span class="points">${info.pts} pts</span>
                        </div>
                    `;
                });
            });
        }

        function loadHallOfFame() {
            db.ref('players').orderByChild('stats/totalScore').limitToLast(10).once('value', snap => {
                const hofList = document.getElementById('hof-display');
                hofList.innerHTML = "";
                let players = [];
                snap.forEach(c => { players.push({p: c.val().pseudo, a: c.val().avatar, s: c.val().stats.totalScore}); });
                
                players.reverse().forEach((p, i) => {
                    hofList.innerHTML += `
                        <div class="hof-item">
                            <span class="rank ${i===0?'rank-1':''}">${i+1}</span>
                            <span>${p.a} <b>${p.p}</b></span>
                            <span style="color:var(--gold)">${p.s} pts</span>
                        </div>`;
                });
            });
        }

        function toggleView() {
            const btn = document.getElementById('toggle-btn');
            if(currentView === "live") {
                loadHallOfFame();
                document.getElementById('page-live').classList.remove('active');
                document.getElementById('page-hof').classList.add('active');
                btn.innerText = "üéÆ Retour au Jeu";
                currentView = "hof";
            } else {
                document.getElementById('page-hof').classList.remove('active');
                document.getElementById('page-live').classList.add('active');
                btn.innerText = "üèÜ Voir Hall of Fame";
                currentView = "live";
            }
        }
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Live Scores - Presta'Puce</title>
    <link rel="icon" type="image/png" href="https://static.wixstatic.com/media/eda9e4_e7ab6af2d5a7428f9bc7e4af454e20ef~mv2.png">
    
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        /* RETOUR AUX COULEURS D'ORIGINE */
        :root { 
            --gold: #f1c40f; 
            --bg-color: #1a1a1a; 
            --card-bg: #2c3e50; 
            --text-color: #ffffff; 
        }
        
        body { 
            background: var(--bg-color); 
            color: var(--text-color); 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 0; 
            padding: 20px;
            overflow-y: auto;
        }

        h1 { 
            font-size: 3rem; 
            text-transform: uppercase; 
            color: var(--gold); 
            margin-bottom: 30px;
            text-align: center;
        }

        /* GRILLE DE CARTES (Style original) */
        .scores-container { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
            gap: 20px; 
            width: 100%; 
            max-width: 1400px; 
            margin: 0 auto;
            padding: 20px;
            box-sizing: border-box;
        }

        .score-card { 
            background: var(--card-bg); 
            padding: 30px; 
            border-radius: 15px; 
            text-align: center; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            border: 4px solid transparent;
            transition: all 0.3s ease;
        }

        /* MISE EN AVANT DU BUZZER */
        .score-card.buzzed { 
            border-color: var(--gold); 
            transform: scale(1.1); 
            box-shadow: 0 0 40px rgba(241, 196, 15, 0.4);
            z-index: 10;
        }

        /* JOUEUR INACTIF */
        .score-card.inactive { 
            opacity: 0.3; 
            filter: grayscale(1);
        }

        .avatar { font-size: 4rem; display: block; margin-bottom: 10px; }
        .pseudo { font-size: 1.8rem; font-weight: bold; display: block; margin-bottom: 5px; }
        .points { font-size: 2.5rem; color: var(--gold); font-weight: bold; }

        /* QR CODE (En haut √† droite comme demand√©) */
        #qr-box { 
            position: fixed; 
            top: 20px; 
            right: 20px; 
            background: white; 
            padding: 10px; 
            border-radius: 10px; 
            border: 5px solid var(--gold); 
            z-index: 100;
            text-align: center;
        }
        #qr-box p { color: black; margin: 5px 0 0 0; font-weight: bold; font-size: 0.7rem; }

        /* BOUTON MJ (En bas √† gauche comme demand√©) */
        #toggle-btn { 
            position: fixed; 
            bottom: 20px; 
            left: 20px; 
            background: var(--card-bg); 
            border: 2px solid var(--gold); 
            color: white; 
            padding: 12px 25px; 
            border-radius: 30px; 
            cursor: pointer; 
            font-weight: bold; 
            z-index: 100;
        }

        /* HALL OF FAME */
        .page { display: none; flex-direction: column; align-items: center; width: 100%; }
        .active { display: flex; }
        .hof-list { width: 100%; max-width: 600px; background: rgba(0,0,0,0.3); padding: 20px; border-radius: 20px; }
        .hof-item { display: flex; align-items: center; justify-content: space-between; padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); font-size: 1.5rem; }
    </style>
</head>
<body>

    <button id="toggle-btn" onclick="toggleView()">üèÜ Voir Hall of Fame</button>

    <div id="qr-box">
        <div id="qrcode"></div>
        <p>SCANNE POUR JOUER</p>
    </div>

    <div id="page-live" class="page active">
        <h1 id="room-title">LIVE SCORES</h1>
        <div id="live-list" class="scores-container"></div>
    </div>

    <div id="page-hof" class="page">
        <h1>üèÜ HALL OF FAME üèÜ</h1>
        <div id="hof-display" class="hof-list"></div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAf1Vl_O8SHJeFjHavKBJgUFGGy73I8t-o",
            authDomain: "prestapuce-buzz.firebaseapp.com",
            databaseURL: "https://prestapuce-buzz-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "prestapuce-buzz",
            storageBucket: "prestapuce-buzz.firebasestorage.app",
            messagingSenderId: "907270883505",
            appId: "1:907270883505:web:197efec0b99db28180ba90"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let roomID = new URLSearchParams(window.location.search).get('room');
        let currentView = "live";

        if(roomID) {
            document.getElementById('room-title').innerText = "SALLE " + roomID;
            new QRCode(document.getElementById("qrcode"), {
                text: "https://prestapuce.github.io/prestapuce-blindtest/index.html?room=" + roomID,
                width: 120, height: 120
            });
            initLiveScores(roomID);
        }

        function initLiveScores(id) {
            db.ref('roomsData/' + id).on('value', snap => {
                const data = snap.val();
                if(!data || !data.scores) return;

                const list = document.getElementById('live-list');
                const buzzedPlayer = data.buzzers ? data.buzzers.pseudo : null;
                
                const players = Object.entries(data.scores);

                // TRI LOGIQUE
                players.sort((a, b) => {
                    if (a[0] === buzzedPlayer) return -1;
                    if (b[0] === buzzedPlayer) return 1;
                    if (a[1].active === false && b[1].active !== false) return 1;
                    if (a[1].active !== false && b[1].active === false) return -1;
                    return b[1].pts - a[1].pts;
                });

                list.innerHTML = "";
                players.forEach(([pseudo, info]) => {
                    const isBuzzed = (pseudo === buzzedPlayer);
                    const isInactive = (info.active === false);
                    list.innerHTML += `
                        <div class="score-card ${isBuzzed ? 'buzzed' : ''} ${isInactive ? 'inactive' : ''}">
                            <span class="avatar">${info.avatar}</span>
                            <span class="pseudo">${pseudo}</span>
                            <span class="points">${info.pts} pts</span>
                        </div>`;
                });
            });
        }

        function loadHallOfFame() {
            db.ref('players').orderByChild('stats/totalScore').limitToLast(10).once('value', snap => {
                const hofList = document.getElementById('hof-display');
                hofList.innerHTML = "";
                let players = [];
                snap.forEach(c => { players.push({p: c.val().pseudo, a: c.val().avatar, s: c.val().stats.totalScore}); });
                players.reverse().forEach((p, i) => {
                    hofList.innerHTML += `<div class="hof-item"><span>${i+1}. ${p.a} <b>${p.p}</b></span><span style="color:var(--gold)">${p.s} pts</span></div>`;
                });
            });
        }

        function toggleView() {
            const btn = document.getElementById('toggle-btn');
            if(currentView === "live") {
                loadHallOfFame();
                document.getElementById('page-live').classList.remove('active');
                document.getElementById('page-hof').classList.add('active');
                btn.innerText = "üéÆ Retour au Jeu";
                currentView = "hof";
            } else {
                document.getElementById('page-hof').classList.remove('active');
                document.getElementById('page-live').classList.add('active');
                btn.innerText = "üèÜ Voir Hall of Fame";
                currentView = "live";
            }
        }
    </script>
</body>
</html>
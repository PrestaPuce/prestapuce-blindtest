<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Presta'Puce - Blind Test</title>
    <link rel="icon" id="page-favicon" type="image/png" href="https://static.wixstatic.com/media/eda9e4_e7ab6af2d5a7428f9bc7e4af454e20ef~mv2.png">
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
    <style>
        :root { --primary-color: #3498db; --bg-color: #1a1a1a; --card-bg: #2c3e50; --text-color: #ffffff; --accent-color: #f1c40f; }
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Segoe UI', sans-serif; background-color: var(--bg-color); color: var(--text-color); overflow: hidden; touch-action: manipulation; }
        .header-bar { position: absolute; top: 0; left: 0; width: 100%; height: 95px; background: rgba(0,0,0,0.85); display: flex; align-items: center; justify-content: space-between; padding: 0 15px; box-sizing: border-box; border-bottom: 2px solid rgba(255,255,255,0.1); z-index: 1000; }
        .logo-presta { width: 45px; height: auto; border-radius: 5px; }
        .screen { display: none; height: 100%; width: 100%; flex-direction: column; justify-content: center; align-items: center; padding: 20px; padding-top: 100px; box-sizing: border-box; }
        .active-screen { display: flex !important; }
        input, select { width: 100%; max-width: 280px; padding: 15px; margin-bottom: 20px; border-radius: 12px; border: 2px solid rgba(255,255,255,0.1); font-size: 1.1rem; background: var(--card-bg); color: white; text-align: center; outline: none; }
        .btn-ui { width: 100%; max-width: 280px; padding: 18px; border-radius: 15px; border: none; font-size: 1.2rem; font-weight: 900; cursor: pointer; background-color: var(--primary-color); color: white; box-shadow: 0 8px 0 #2980b9; text-transform: uppercase; margin-bottom: 10px; }
        .btn-disabled { background-color: #7f8c8d !important; box-shadow: 0 8px 0 #636e72 !important; cursor: not-allowed; opacity: 0.6; }
        .avatar-scroll { width: 100%; max-width: 320px; max-height: 200px; overflow-y: auto; margin-bottom: 20px; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 20px; }
        .avatar-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .avatar-item { width: 60px; height: 60px; background: var(--card-bg); border-radius: 15px; cursor: pointer; border: 3px solid transparent; display: flex; align-items: center; justify-content: center; overflow: hidden; font-size: 2rem; }
        .avatar-item.selected { border-color: var(--accent-color); transform: scale(1.1); }
        .avatar-item img { width: 100%; height: 100%; object-fit: cover; }
        .buzzer { width: 65vw; height: 65vw; max-width: 250px; max-height: 250px; border-radius: 50%; border: none; cursor: pointer; background: #e74c3c; box-shadow: 0 15px 0 #c0392b; position: relative; outline: none; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .ready .buzzer { background: #2ecc71; box-shadow: 0 15px 0 #27ae60; }
        .main-prise .buzzer { background: #3498db !important; box-shadow: 0 15px 0 #2980b9 !important; }
        .blocked .buzzer { background: #555 !important; box-shadow: 0 15px 0 #333 !important; opacity: 0.6; pointer-events: none; }
        .buzzer-img { width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; opacity: 0.4; }
        .buzzer-label { position: relative; z-index: 2; color: white; font-size: 1.4rem; font-weight: bold; text-shadow: 0 2px 4px rgba(0,0,0,0.8); }
        #podium-zone { display: none; flex-direction: column; align-items: center; justify-content: center; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #1a1a1a; z-index: 9999; }
        @keyframes trophyZoom { 0% { transform: scale(0) rotate(-45deg); opacity: 0; } 70% { transform: scale(1.4) rotate(10deg); opacity: 1; } 100% { transform: scale(1) rotate(0deg); } }
        .animate-zoom { animation: trophyZoom 1s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
</head>
<body>
    <div id="podium-zone"></div>
    <div class="header-bar">
        <div style="flex:1; line-height: 1.2; display: flex; align-items: center; gap: 10px;">
            <div id="display-avatar-container" style="display:none; width:40px; height:40px; border-radius:50%; overflow:hidden; background: #333; align-items: center; justify-content: center; font-size: 1.2rem;"></div>
            <div>
                <span id="display-pseudo" style="font-weight: bold;"></span><br>
                <span id="display-team-label" style="font-size: 0.7rem; color: var(--accent-color); font-style: italic;"></span>
            </div>
        </div>
        <div style="flex:0; padding: 0 10px;">
            <img id="display-mj-logo" src="https://static.wixstatic.com/media/eda9e4_e7ab6af2d5a7428f9bc7e4af454e20ef~mv2.png" class="logo-presta">
        </div>
        <div style="flex:1; text-align:right; font-size: 0.8rem;" id="display-room-info"></div>
    </div>

    <div id="screen-room" class="screen active-screen">
        <h2 style="color:var(--accent-color)">CODE SALLE</h2>
        <input type="number" id="room-code-input" placeholder="CODE SALLE">
        <button class="btn-ui" onclick="validateRoom()">Rejoindre</button>
    </div>

    <div id="screen-login" class="screen">
        <h2 style="color:var(--accent-color)">TON PSEUDO</h2>
        <input type="text" id="input-pseudo" placeholder="Pseudo..." maxlength="12">
        <button class="btn-ui" onclick="checkPseudo()">Suivant</button>
    </div>

    <div id="screen-setup" class="screen">
        <h3 style="margin:0 0 10px 0;">AVATAR</h3>
        <div class="avatar-scroll">
            <div class="avatar-grid" id="avatar-grid">
                <div class="avatar-item" style="background:var(--primary-color); color:white; font-weight:bold; display:flex; align-items:center; justify-content:center;" onclick="document.getElementById('file-input').click()"><span style="font-size:2rem;">+</span><input type="file" id="file-input" accept="image/*" style="display:none" onchange="handleFileUpload(this)"></div>
            </div>
        </div>
        <h3 style="margin:0 0 10px 0;">Ã‰QUIPE</h3>
        <select id="select-team"><option value="Solo|">Mode Solo</option></select>
        <button id="btn-final" class="btn-ui btn-disabled" onclick="finalizeSetup()">C'est parti !</button>
    </div>

    <div id="screen-buzzer" class="screen">
        <div style="flex:1; display:flex; align-items:center;">
            <button class="buzzer" id="btn-buzz" onpointerdown="onBuzzerClick(event)">
                <div id="buzzer-img-placeholder"></div>
                <span id="label" class="buzzer-label">ATTENDEZ</span>
            </button>
        </div>
        <div style="font-weight: bold;">Score : <span id="score" style="color:var(--accent-color)">0</span> pts</div>
        <button class="btn-exit" style="width:40px; height:40px; border-radius:50%; background:red; color:white; border:none; margin-top:10px;" onclick="leaveGame()">Ã—</button>
    </div>

    <audio id="sound-click" src="https://actions.google.com/sounds/v1/ui/pop.ogg" preload="auto"></audio>
    <audio id="sound-win" src="https://assets.mixkit.co/active_storage/sfx/2831/2831-preview.mp3" preload="auto"></audio>
    <audio id="sound-applause" src="https://firebasestorage.googleapis.com/v0/b/prestapuce-buzz.firebasestorage.app/o/Bruitage%20-%20Ambiance%20Et%20Applaudissement.mp3?alt=media&token=4a653c7f-67c2-4cc8-b53c-c58c2dda3bbd" preload="auto"></audio>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAf1Vl_O8SHJeFjHavKBJgUFGGy73I8t-o",
            authDomain: "prestapuce-buzz.firebaseapp.com",
            databaseURL: "https://prestapuce-buzz-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "prestapuce-buzz",
            storageBucket: "prestapuce-buzz.firebasestorage.app"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let roomID = "", roomRef = null, userPseudo = "", userTeamName = "Solo", userTeamIcon = "", selectedAvatar = null;
        let gameState = "waiting", currentWinner = null, isBlocked = false;
        const avatars = ["ðŸ¦","ðŸ¯","ðŸ¼","ðŸ¦Š","ðŸµ","ðŸ¶","ðŸ±","ðŸ¦„","ðŸ˜Ž","ðŸ¤–","ðŸ‘½","ðŸ‘¾","ðŸ‘»","ðŸ¤¡","ðŸ™","ðŸ¦‰","ðŸ¸","ðŸ¹","ðŸ°","ðŸ¥³"];

        window.onload = () => {
            const urlParams = new URLSearchParams(window.location.search);
            const r = urlParams.get('room');
            if(r) { document.getElementById('room-code-input').value = r; validateRoom(); }
            renderAvatarGrid();
        };

        function validateRoom() {
            unlockAudio();
            roomID = document.getElementById('room-code-input').value.trim();
            if(!roomID) return;
            db.ref('activeRooms/' + roomID).once('value', snap => {
                if(snap.exists()) {
                    roomRef = db.ref('roomsData/' + roomID);
                    showScreen('screen-login');
                    document.getElementById('display-room-info').innerText = "SALLE " + roomID;
                    listenToTeams();
                } else alert("Salle introuvable !");
            });
        }

        function checkPseudo() {
            unlockAudio();
            userPseudo = document.getElementById('input-pseudo').value.trim();
            if(userPseudo.length < 2) return;
            
            // On vÃ©rifie si le joueur existe dÃ©jÃ  pour le reconnecter correctement avec ses infos
            roomRef.child('scores/' + userPseudo).once('value', snap => {
                if(snap.exists()) {
                    if(confirm("Reprendre votre partie ?")) {
                        const data = snap.val();
                        selectedAvatar = data.avatar;
                        userTeamName = data.teamName || "Solo";
                        userTeamIcon = data.teamIcon || "";
                        
                        roomRef.child('scores/' + userPseudo).update({ 
                            active: true,
                            teamName: userTeamName,
                            teamIcon: userTeamIcon 
                        }).then(() => { startBuzzer(); });
                    } else {
                        showScreen('screen-setup');
                    }
                } else {
                    showScreen('screen-setup');
                }
            });
        }

        function handleFileUpload(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        canvas.width = 120; canvas.height = 120;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, 120, 120);
                        selectedAvatar = canvas.toDataURL('image/jpeg', 0.6);
                        renderAvatarGrid(selectedAvatar);
                        document.getElementById('btn-final').classList.remove('btn-disabled');
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function renderAvatarGrid(customImg = null) {
            const grid = document.getElementById('avatar-grid');
            grid.innerHTML = `<div class="avatar-item" style="background:var(--primary-color); color:white; font-weight:bold; display:flex; align-items:center; justify-content:center;" onclick="document.getElementById('file-input').click()"><span style="font-size:2rem;">+</span><input type="file" id="file-input" accept="image/*" style="display:none" onchange="handleFileUpload(this)"></div>`;
            if(customImg) {
                const div = document.createElement('div');
                div.className = 'avatar-item selected';
                div.innerHTML = `<img src="${customImg}">`;
                div.onclick = () => { selectedAvatar = customImg; renderAvatarGrid(customImg); };
                grid.appendChild(div);
            }
            avatars.forEach(a => {
                const div = document.createElement('div');
                div.className = 'avatar-item' + (selectedAvatar === a ? ' selected' : '');
                div.innerText = a;
                div.onclick = () => { selectedAvatar = a; renderAvatarGrid(customImg); document.getElementById('btn-final').classList.remove('btn-disabled'); };
                grid.appendChild(div);
            });
        }

        function finalizeSetup() {
            unlockAudio();
            const val = document.getElementById('select-team').value.split('|');
            userTeamName = val[0];
            userTeamIcon = val[1] || "";
            
            roomRef.child('scores/' + userPseudo).set({ 
                pts: 0, 
                avatar: selectedAvatar, 
                teamName: userTeamName, 
                teamIcon: userTeamIcon, 
                active: true 
            });
            startBuzzer();
        }

        const updateTeamDisplay = (name, icon) => {
            const teamLabel = document.getElementById('display-team-label');
            if (name && name !== "Solo" && name !== "") {
                const iconHtml = icon ? `<img src="${icon}" style="height:15px; vertical-align:middle; margin-right:5px;">` : "";
                teamLabel.innerHTML = `${iconHtml}${name}`;
            } else {
                teamLabel.innerText = "Mode Solo";
            }
        };

        function startBuzzer() {
            const container = document.getElementById('display-avatar-container');
            container.style.display = "flex";
            if(selectedAvatar && selectedAvatar.startsWith('data:image')) container.innerHTML = `<img src="${selectedAvatar}" style="width:100%; height:100%; object-fit:cover;">`;
            else container.innerText = selectedAvatar || "ðŸ‘¤";
            
            document.getElementById('display-pseudo').innerText = userPseudo;
            updateTeamDisplay(userTeamName, userTeamIcon);
            
            if(selectedAvatar && selectedAvatar.startsWith('data:image')) document.getElementById('buzzer-img-placeholder').innerHTML = `<img src="${selectedAvatar}" class="buzzer-img">`;
            
            showScreen('screen-buzzer');
            
            roomRef.child('scores/' + userPseudo + '/pts').on('value', snap => { document.getElementById('score').innerText = snap.val() || 0; });
            
            roomRef.child('scores/' + userPseudo).on('value', snap => {
                const d = snap.val();
                if(d) {
                    userTeamName = d.teamName || "Solo";
                    userTeamIcon = d.teamIcon || "";
                    updateTeamDisplay(userTeamName, userTeamIcon);
                }
            });

            roomRef.child('gameState').on('value', snap => {
                if(snap.val() && snap.val().status === 'endGame') handleEndGame();
                else { gameState = snap.val() ? snap.val().status : 'waiting'; updateUI(); }
            });
            
            roomRef.child('buzzers').on('value', snap => { 
                const val = snap.val();
                if (val && val.pseudo === userPseudo && currentWinner !== userPseudo) document.getElementById('sound-win').play().catch(()=>{});
                currentWinner = val ? val.pseudo : null; updateUI(); 
            });

            roomRef.child('scores/' + userPseudo + '/active').on('value', snap => {
                if(snap.exists() && snap.val() === false) {
                    alert("Vous avez Ã©tÃ© expulsÃ© de la partie par le MJ.");
                    location.reload();
                }
            });

            roomRef.child('blockedPlayers/' + userPseudo).on('value', snap => {
                isBlocked = snap.exists(); 
                updateUI();
            });
        }

        function onBuzzerClick(event) {
            if(event) event.preventDefault();
            document.getElementById('sound-click').play().catch(()=>{});
            
            if(gameState === "ready" && !currentWinner && !isBlocked) {
                roomRef.child('gameState').update({ status: 'taken' });
                roomRef.child('buzzers').set({ pseudo: userPseudo, avatar: selectedAvatar, teamName: userTeamName, teamIcon: userTeamIcon });
            }
        }

        function updateUI() {
            const c = document.getElementById('screen-buzzer'); const l = document.getElementById('label');
            c.classList.remove('ready', 'main-prise', 'blocked');
            
            if (currentWinner) {
                if(currentWinner === userPseudo) { c.classList.add('main-prise'); l.innerText = "C'EST Ã€ TOI !"; }
                else { l.innerText = "OCCUPÃ‰"; }
            } 
            else if (isBlocked) { 
                c.classList.add('blocked'); l.innerText = "BLOQUÃ‰"; 
            } 
            else if (gameState === 'ready') { 
                c.classList.add('ready'); l.innerText = "BUZZEZ !"; 
            }
            else { 
                l.innerText = "ATTENDEZ"; 
            }
        }

        function handleEndGame() {
            const pZone = document.getElementById('podium-zone');
            pZone.style.display = "flex";
            roomRef.child('scores').once('value', snap => {
                const scores = snap.val() || {};
                const leaderboard = Object.keys(scores).map(p => ({ name: p, pts: scores[p].pts })).sort((a, b) => b.pts - a.pts);
                const rank = leaderboard.findIndex(e => e.name === userPseudo) + 1;
                
                if(rank === 1) {
                    pZone.innerHTML = `<img src="https://cdn-icons-png.flaticon.com/512/2583/2583344.png" class="trophy-img animate-zoom"><h1 style="color:gold; font-size:2.5rem;">CHAMPION !</h1><button onclick="location.reload()" class="btn-ui" style="margin-top:20px;">RETOUR</button>`;
                    document.getElementById('sound-applause').play().catch(()=>{});
                    
                    var duration = 8 * 1000;
                    var animationEnd = Date.now() + duration;
                    var interval = setInterval(function() {
                        var timeLeft = animationEnd - Date.now();
                        if (timeLeft <= 0) return clearInterval(interval);
                        confetti({ particleCount: 40, spread: 70, origin: { x: Math.random(), y: Math.random() - 0.2 }, zIndex: 10000 });
                    }, 250);
                } else {
                    pZone.innerHTML = `<h1 style="color:white; font-size:2rem;">${rank}Ã¨me PLACE</h1><button onclick="location.reload()" class="btn-ui" style="margin-top:20px;">RETOUR</button>`;
                }
            });
        }

        function leaveGame() {
            if(confirm("Voulez-vous vraiment quitter la partie ?")) {
                if(roomRef && userPseudo) {
                    // MODIFICATION : On arrÃªte d'Ã©couter le changement de statut pour Ã©viter l'alerte d'expulsion
                    roomRef.child('scores/' + userPseudo + '/active').off();
                    
                    roomRef.child('scores/' + userPseudo).update({ active: false }).then(() => {
                        // MODIFICATION : Message informatif personnalisÃ© pour un dÃ©part volontaire
                        alert("Vous avez quittÃ© la partie.\n\nSachez que vous pourrez revenir avec le mÃªme pseudo pour rÃ©cupÃ©rer votre score !");
                        location.reload();
                    });
                } else {
                    location.reload();
                }
            }
        }

        function unlockAudio() { ['sound-click', 'sound-win', 'sound-applause'].forEach(id => { const el = document.getElementById(id); el.play().then(() => { el.pause(); el.currentTime = 0; }).catch(()=>{}); }); }
        function showScreen(id) { document.querySelectorAll('.screen').forEach(s => s.classList.remove('active-screen')); document.getElementById(id).classList.add('active-screen'); }
        function listenToTeams() {
            roomRef.child('teams').on('value', snap => {
                const select = document.getElementById('select-team');
                select.innerHTML = '<option value="Solo|">Mode Solo</option>';
                snap.forEach(child => {
                    const opt = document.createElement('option');
                    opt.value = child.key + "|" + child.val().icon;
                    opt.innerText = child.key;
                    select.appendChild(opt);
                });
            });
        }
    </script>
</body>
</html>
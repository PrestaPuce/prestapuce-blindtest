<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Presta'Puce - Blind Test</title>
    <link rel="icon" type="image/png" href="https://static.wixstatic.com/media/eda9e4_e7ab6af2d5a7428f9bc7e4af454e20ef~mv2.png">
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
    <style>
        :root { --primary-color: #3498db; --bg-color: #1a1a1a; --card-bg: #2c3e50; --text-color: #ffffff; --accent-color: #f1c40f; }
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Segoe UI', sans-serif; background-color: var(--bg-color); color: var(--text-color); overflow: hidden; }
        .header-bar { position: absolute; top: 0; left: 0; width: 100%; height: 60px; background: rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: space-between; padding: 0 15px; box-sizing: border-box; z-index: 10; }
        .screen { display: none; height: 100vh; width: 100vw; flex-direction: column; align-items: center; justify-content: center; padding: 20px; box-sizing: border-box; }
        .active-screen { display: flex; }
        .box { background: var(--card-bg); padding: 25px; border-radius: 15px; width: 100%; max-width: 320px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
        input { width: 100%; padding: 12px; margin: 10px 0; border-radius: 8px; border: none; font-size: 1rem; box-sizing: border-box; }
        button { width: 100%; padding: 12px; border-radius: 8px; border: none; background: var(--primary-color); color: white; font-weight: bold; font-size: 1rem; cursor: pointer; margin-top: 10px; }
        .buzzer-container { width: 280px; height: 280px; border-radius: 50%; background: #444; display: flex; align-items: center; justify-content: center; cursor: pointer; border: 10px solid #333; box-shadow: 0 15px 0 #222, 0 20px 30px rgba(0,0,0,0.5); transition: 0.1s; -webkit-tap-highlight-color: transparent; }
        .buzzer-container.ready { background: #e74c3c; border-color: #c0392b; box-shadow: 0 15px 0 #962d22, 0 20px 30px rgba(231, 76, 60, 0.3); }
        .buzzer-container.ready:active { transform: translateY(10px); box-shadow: 0 5px 0 #962d22, 0 10px 20px rgba(0,0,0,0.3); }
        .buzzer-container.main-prise { background: #2ecc71 !important; border-color: #27ae60 !important; box-shadow: 0 15px 0 #1e8449 !important; }
        .buzzer-container.blocked { background: #7f8c8d !important; border-color: #95a5a6 !important; opacity: 0.6; pointer-events: none; box-shadow: 0 15px 0 #5f6a6a !important; }
        .buzzer-label { font-size: 2rem; font-weight: 900; text-transform: uppercase; user-select: none; }
        .avatar-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin: 15px 0; max-height: 120px; overflow-y: auto; padding: 5px; }
        .avatar-item { font-size: 1.8rem; cursor: pointer; padding: 5px; border-radius: 8px; transition: 0.2s; background: rgba(255,255,255,0.05); }
        .avatar-item.selected { background: var(--accent-color); transform: scale(1.1); }
        #room-id-display { font-weight: bold; color: var(--accent-color); }
        #exit-btn { background: none; border: 1px solid rgba(255,255,255,0.3); padding: 5px 10px; font-size: 0.8rem; width: auto; margin: 0; }
        
        /* Styles pour l'√©cran de fin */
        #end-message { height: 100vh; display: none; flex-direction: column; align-items: center; justify-content: center; text-align: center; background: #1a1a1a; padding: 20px; }
        .end-title { color: var(--accent-color); font-size: 2rem; font-weight: bold; margin-bottom: 15px; }
    </style>
</head>
<body>

    <div id="screen-join" class="screen active-screen">
        <div class="box">
            <img src="https://static.wixstatic.com/media/eda9e4_e7ab6af2d5a7428f9bc7e4af454e20ef~mv2.png" style="width:80px; margin-bottom:15px;">
            <h2>Rejoindre une salle</h2>
            <input type="tel" id="room-input" placeholder="Code Salle (ex: 1234)" maxlength="4">
            <button onclick="checkRoom()">Continuer</button>
        </div>
    </div>

    <div id="screen-profile" class="screen">
        <div class="box">
            <h3>Ton Profil</h3>
            <input type="text" id="pseudo-input" placeholder="Ton Pseudo" maxlength="15">
            <div class="avatar-grid" id="avatar-grid"></div>
            <button onclick="joinGame()">C'est parti !</button>
            <p onclick="showScreen('screen-join')" style="font-size:0.8rem; margin-top:15px; text-decoration:underline; cursor:pointer;">Retour</p>
        </div>
    </div>

    <div id="screen-game" class="screen">
        <div class="header-bar">
            <div style="font-size:0.9rem;">SALLE <span id="room-id-display"></span></div>
            <button id="exit-btn" onclick="leaveGame()">Quitter</button>
        </div>
        <div id="screen-buzzer" class="buzzer-container" onpointerdown="triggerBuzz(event)">
            <div id="label" class="buzzer-label">ATTENDEZ</div>
        </div>
        <div id="status-sub" style="margin-top:30px; font-weight:bold; font-size:1.2rem; color:var(--accent-color);"></div>
    </div>

    <div id="end-message">
        <img src="https://static.wixstatic.com/media/eda9e4_e7ab6af2d5a7428f9bc7e4af454e20ef~mv2.png" style="width:100px; margin-bottom:20px;">
        <div class="end-title">PARTIE TERMIN√âE</div>
        <p style="font-size: 1.2rem;">L'animateur a cl√¥tur√© la salle.</p>
        <p>Merci d'avoir jou√© avec Presta'Puce !</p>
        <button onclick="location.reload()" style="max-width:200px; background: var(--accent-color); color:black;">RETOUR √Ä L'ACCUEIL</button>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAf1Vl_O8SHJeFjHavKBJgUFGGy73I8t-o",
            authDomain: "prestapuce-buzz.firebaseapp.com",
            databaseURL: "https://prestapuce-buzz-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "prestapuce-buzz",
            storageBucket: "prestapuce-buzz.firebasestorage.app",
            messagingSenderId: "907270883505",
            appId: "1:907270883505:web:197efec0b99db28180ba90"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let roomID = "", roomRef = null, userPseudo = "", selectedAvatar = "üë§", gameState = "waiting", currentWinner = null, isBlockedLocally = false;
        let userTeamName = "Solo", userTeamIcon = "";

        const avatars = ["üê∂","üê±","üê≠","üêπ","üê∞","ü¶ä","üêª","üêº","üê®","üêØ","ü¶Å","üêÆ","üê∑","üê∏","üêµ","ü¶Ñ","üêù","üé®","üöÄ","üé∏","üçï","üéÆ","‚öΩ","üíé"];
        const grid = document.getElementById('avatar-grid');
        avatars.forEach(a => {
            const span = document.createElement('span'); span.className = 'avatar-item'; span.innerText = a;
            span.onclick = () => { document.querySelectorAll('.avatar-item').forEach(i=>i.classList.remove('selected')); span.classList.add('selected'); selectedAvatar = a; };
            grid.appendChild(span);
        });

        const urlParams = new URLSearchParams(window.location.search);
        if(urlParams.get('room')) { document.getElementById('room-input').value = urlParams.get('room'); }

        function checkRoom() {
            const val = document.getElementById('room-input').value.trim();
            if(!val) return;
            db.ref('activeRooms/' + val).once('value', snap => {
                if(snap.exists()) { roomID = val; showScreen('screen-profile'); }
                else { alert("Salle introuvable."); }
            });
        }

        function joinGame() {
            const p = document.getElementById('pseudo-input').value.trim();
            if(!p) return alert("Choisis un pseudo");
            userPseudo = p; roomRef = db.ref('roomsData/' + roomID);
            
            roomRef.child('scores/' + userPseudo).set({ avatar: selectedAvatar, pts: 0, teamName: "Solo", teamIcon: "", active: true });
            document.getElementById('room-id-display').innerText = roomID;
            showScreen('screen-game');
            initGameLogic();
        }

        function initGameLogic() {
            // √âcoute du statut de la salle (AJOUT√â : D√©tection fermeture)
            roomRef.child('gameState/status').on('value', snap => {
                gameState = snap.val();
                if(gameState === 'closed') {
                    handleEndGame();
                    return;
                }
                updateUI();
            });

            // √âcoute du buzzer gagnant
            roomRef.child('buzzers').on('value', snap => {
                currentWinner = snap.exists() ? snap.val().pseudo : null;
                updateUI();
            });

            // √âcoute si on est bloqu√©
            roomRef.child('blockedPlayers/' + userPseudo).on('value', snap => {
                isBlockedLocally = snap.exists();
                updateUI();
            });

            // R√©cup√©ration des infos d'√©quipe si le MJ nous change
            roomRef.child('scores/' + userPseudo).on('value', snap => {
                const data = snap.val();
                if(data) {
                    userTeamName = data.teamName || "Solo";
                    userTeamIcon = data.teamIcon || "";
                    document.getElementById('status-sub').innerText = (userTeamName !== "Solo") ? "√âquipe : " + userTeamName : "";
                    
                    // Si le MJ nous marque inactif (kick), on recharge
                    if(data.active === false && !localStorage.getItem('leaving')) {
                        alert("Tu as √©t√© retir√© de la partie.");
                        location.reload();
                    }
                }
            });
        }

        function handleEndGame() {
            // Coupe les √©coutes Firebase et affiche l'√©cran de fin
            if(roomRef) roomRef.off();
            document.querySelectorAll('.screen').forEach(s => s.style.display = 'none');
            document.getElementById('end-message').style.display = 'flex';
        }

        function triggerBuzz(e) {
            e.preventDefault();
            if(gameState === 'ready' && !currentWinner && !isBlockedLocally) {
                roomRef.child('buzzers').set({ 
                    pseudo: userPseudo, 
                    avatar: selectedAvatar, 
                    teamName: userTeamName, 
                    teamIcon: userTeamIcon 
                });
            }
        }

        function leaveGame() {
            if(confirm("Quitter la partie ?")) {
                localStorage.setItem('leaving', 'true');
                if(roomRef && userPseudo) {
                    roomRef.child('scores/' + userPseudo).update({ active: false }).then(() => {
                        localStorage.removeItem('leaving'); location.reload();
                    });
                } else { location.reload(); }
            }
        }

        function updateUI() {
            const c = document.getElementById('screen-buzzer'); 
            const l = document.getElementById('label');
            c.classList.remove('ready', 'main-prise', 'blocked');
            
            if(isBlockedLocally) { 
                c.classList.add('blocked'); 
                l.innerText = "BLOQU√â"; 
            }
            else if (currentWinner) {
                if(currentWinner === userPseudo) { 
                    c.classList.add('main-prise'); 
                    l.innerText = "C'EST √Ä TOI !"; 
                } else { 
                    l.innerText = "OCCUP√â"; 
                }
            } else if(gameState === 'ready') { 
                c.classList.add('ready'); 
                l.innerText = "BUZZEZ !"; 
            }
            else { 
                l.innerText = "ATTENDEZ"; 
            }
        }

        function showScreen(id) { 
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active-screen')); 
            document.getElementById(id).classList.add('active-screen'); 
        }
    </script>
</body>
</html>
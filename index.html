<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Presta'Puce - Blind Test</title>
    <link rel="icon" id="page-favicon" type="image/png" href="https://static.wixstatic.com/media/eda9e4_e7ab6af2d5a7428f9bc7e4af454e20ef~mv2.png">
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
    <style>
        :root { --primary-color: #3498db; --bg-color: #1a1a1a; --card-bg: #2c3e50; --text-color: #ffffff; --accent-color: #f1c40f; --success: #27ae60; }
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Segoe UI', sans-serif; background-color: var(--bg-color); color: var(--text-color); overflow: hidden; touch-action: manipulation; }
        
        /* HEADER */
        .header-bar { position: absolute; top: 0; left: 0; width: 100%; height: 95px; background: rgba(0,0,0,0.85); display: flex; align-items: center; justify-content: space-between; padding: 0 15px; box-sizing: border-box; border-bottom: 2px solid rgba(255,255,255,0.1); z-index: 1000; }
        .logo-presta { width: 45px; height: auto; border-radius: 5px; }
        
        .screen { display: none; height: 100%; width: 100%; flex-direction: column; justify-content: center; align-items: center; padding: 20px; padding-top: 100px; box-sizing: border-box; overflow-y: auto; }
        .active-screen { display: flex !important; }
        
        input, select { width: 100%; max-width: 280px; padding: 15px; margin-bottom: 20px; border-radius: 12px; border: 2px solid rgba(255,255,255,0.1); font-size: 1.1rem; background: var(--card-bg); color: white; text-align: center; outline: none; }
        
        .btn-ui { width: 100%; max-width: 280px; padding: 18px; border-radius: 15px; border: none; font-size: 1.2rem; font-weight: 900; cursor: pointer; background-color: var(--primary-color); color: white; box-shadow: 0 8px 0 #2980b9; text-transform: uppercase; margin-bottom: 10px; transition: 0.2s; }
        .btn-ui:active { transform: translateY(4px); box-shadow: 0 4px 0 #2980b9; }
        .btn-disabled { background-color: #7f8c8d !important; box-shadow: none !important; cursor: not-allowed; opacity: 0.5; }
        
        .avatar-scroll { width: 100%; max-width: 320px; max-height: 180px; overflow-y: auto; margin-bottom: 20px; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 20px; }
        .avatar-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .avatar-item { width: 60px; height: 60px; background: var(--card-bg); border-radius: 15px; cursor: pointer; border: 3px solid transparent; display: flex; align-items: center; justify-content: center; overflow: hidden; font-size: 2rem; }
        .avatar-item.selected { border-color: var(--accent-color); transform: scale(1.1); background: var(--accent-color); }
        .avatar-item img { width: 100%; height: 100%; object-fit: cover; }
        
        /* SECTION EQUIPE */
        .team-tabs { display: flex; gap: 10px; margin-bottom: 15px; width: 100%; max-width: 280px; }
        .tab-btn { flex: 1; padding: 10px; border: 1px solid rgba(255,255,255,0.2); background: transparent; color: #aaa; border-radius: 8px; cursor: pointer; font-size: 0.9rem; }
        .tab-btn.active { background: var(--primary-color); color: white; border-color: var(--primary-color); font-weight: bold; }
        .team-panel { display: none; width: 100%; flex-direction: column; align-items: center; }
        .team-panel.active { display: flex; }

        /* CREATION EQUIPE */
        .team-icon-picker { display: flex; gap: 10px; overflow-x: auto; width: 100%; max-width: 300px; padding-bottom: 10px; margin-bottom: 15px; }
        .team-icon-opt { width: 50px; height: 50px; flex-shrink: 0; background: white; border-radius: 8px; padding: 2px; cursor: pointer; border: 3px solid transparent; }
        .team-icon-opt.selected { border-color: var(--success); transform: scale(1.1); }
        .team-icon-opt img { width: 100%; height: 100%; object-fit: contain; }
        .upload-team-btn { width: 100%; max-width: 280px; padding: 10px; border: 2px dashed #aaa; border-radius: 10px; text-align: center; color: #aaa; cursor: pointer; margin-bottom: 15px; font-size: 0.9rem; }
        
        .buzzer { width: 65vw; height: 65vw; max-width: 250px; max-height: 250px; border-radius: 50%; border: none; cursor: pointer; background: #e74c3c; box-shadow: 0 15px 0 #c0392b; position: relative; outline: none; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .ready .buzzer { background: #2ecc71; box-shadow: 0 15px 0 #27ae60; }
        .main-prise .buzzer { background: #3498db !important; box-shadow: 0 15px 0 #2980b9 !important; }
        .blocked .buzzer { background: #555 !important; box-shadow: 0 15px 0 #333 !important; opacity: 0.6; pointer-events: none; }
        .buzzer-img { width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; opacity: 0.4; }
        .buzzer-label { position: relative; z-index: 2; color: white; font-size: 1.4rem; font-weight: bold; text-shadow: 0 2px 4px rgba(0,0,0,0.8); }

        #podium-zone { display: none; flex-direction: column; align-items: center; justify-content: center; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(26, 26, 26, 0.98); z-index: 10000; padding: 20px; box-sizing: border-box; }
        .trophy-img { width: 150px; height: 150px; object-fit: contain; margin-bottom: 15px; }
        @keyframes trophyZoom { 0% { transform: scale(0) rotate(-45deg); opacity: 0; } 70% { transform: scale(1.4) rotate(10deg); opacity: 1; } 100% { transform: scale(1) rotate(0deg); } }
        .animate-zoom { animation: trophyZoom 1s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }

        #btn-edit-container { display: none; margin-left: 8px; vertical-align: middle; }
        .btn-edit-icon { background: none; border: 1px solid rgba(255,255,255,0.2); border-radius: 50%; width: 24px; height: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; padding: 4px; }
        .btn-edit-icon svg { fill: #bdc3c7; width: 14px; height: 14px; }
        .btn-edit-icon:hover { border-color: var(--accent-color); background: rgba(241, 196, 15, 0.1); }
        .btn-edit-icon:hover svg { fill: var(--accent-color); }

        .version-tag { position: fixed; bottom: 5px; right: 10px; color: rgba(255, 255, 255, 0.2); font-size: 0.7rem; font-family: monospace; pointer-events: none; z-index: 50; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
</head>
<body>
    
    <div class="version-tag">v1.032</div>

    <div id="podium-zone"></div>
    
    <div class="header-bar">
        <div style="flex:1; line-height: 1.2; display: flex; align-items: center; gap: 10px;">
            <div id="display-avatar-container" style="display:none; width:40px; height:40px; border-radius:50%; overflow:hidden; background: #333; align-items: center; justify-content: center; font-size: 1.2rem;"></div>
            <div style="display:flex; align-items:center;">
                <div>
                    <span id="display-pseudo" style="font-weight: bold;"></span><br>
                    <span id="display-team-label" style="font-size: 0.7rem; color: var(--accent-color); font-style: italic;"></span>
                </div>
                <div id="btn-edit-container">
                    <button class="btn-edit-icon" onclick="editProfile()" title="Modifier mon profil">
                        <svg viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
                    </button>
                </div>
            </div>
        </div>
        <div style="flex:0; padding: 0 10px;">
            <img id="display-mj-logo" src="https://static.wixstatic.com/media/eda9e4_e7ab6af2d5a7428f9bc7e4af454e20ef~mv2.png" class="logo-presta">
        </div>
        <div style="flex:1; text-align:right; font-size: 0.8rem;" id="display-room-info"></div>
    </div>

    <div id="screen-room" class="screen active-screen">
        <h2 style="color:var(--accent-color)">CODE SALLE</h2>
        <input type="number" id="room-code-input" placeholder="CODE SALLE">
        <button class="btn-ui" onclick="validateRoom()">Rejoindre</button>
    </div>

    <div id="screen-login" class="screen">
        <h2 style="color:var(--accent-color)">TON PSEUDO</h2>
        <input type="text" id="input-pseudo" placeholder="Pseudo..." maxlength="12">
        <button class="btn-ui" onclick="checkPseudo()">Suivant</button>
    </div>

    <div id="screen-setup" class="screen">
        <h3 style="margin:0 0 10px 0;">CHOISIS TON AVATAR</h3>
        <div class="avatar-scroll">
            <div class="avatar-grid" id="avatar-grid">
                <div class="avatar-item" style="background:var(--primary-color); color:white; font-weight:bold; display:flex; align-items:center; justify-content:center;" onclick="document.getElementById('file-input').click()">
                    <span style="font-size:2rem;">+</span>
                    <input type="file" id="file-input" accept=".jpg,.jpeg,.png,.webp,image/*,application/octet-stream" style="display:none" onchange="handleFileUpload(this)">
                </div>
            </div>
        </div>
        
        <h3 style="margin:0 0 10px 0;">TON Ã‰QUIPE</h3>
        
        <div class="team-tabs">
            <button class="tab-btn active" id="tab-join" onclick="switchTeamTab('join')">Rejoindre</button>
            <button class="tab-btn" id="tab-create" onclick="switchTeamTab('create')">CrÃ©er</button>
        </div>

        <div id="panel-join" class="team-panel active">
            <select id="select-team" onchange="onTeamSelectChange()"><option value="Solo|">Mode Solo</option></select>
        </div>

        <div id="panel-create" class="team-panel">
            <input type="text" id="new-team-name" placeholder="Nom de l'Ã©quipe" maxlength="15">
            <p style="margin:0 0 5px 0; font-size:0.8rem; color:#aaa;">Choisir un blason :</p>
            <div class="team-icon-picker" id="team-crest-list"></div>
            <div class="upload-team-btn" onclick="document.getElementById('team-icon-input').click()">
                ðŸ“¤ Ou uploader une image perso
                <input type="file" id="team-icon-input" accept="image/*" style="display:none" onchange="handleTeamIconUpload(this)">
            </div>
            <button class="btn-ui" style="background:var(--success); font-size:1rem; padding:12px;" onclick="createNewTeam()">âœ… Valider CrÃ©ation</button>
        </div>

        <button id="btn-final" class="btn-ui btn-disabled" onclick="finalizeSetup()">C'est parti !</button>
    </div>

    <div id="screen-buzzer" class="screen">
        <div style="flex:1; display:flex; align-items:center;">
            <button class="buzzer" id="btn-buzz" onpointerdown="onBuzzerClick(event)">
                <div id="buzzer-img-placeholder"></div>
                <span id="label" class="buzzer-label">ATTENDEZ</span>
            </button>
        </div>
        <div style="font-weight: bold;">Score : <span id="score" style="color:var(--accent-color)">0</span> pts</div>
        <button class="btn-exit" style="width:40px; height:40px; border-radius:50%; background:red; color:white; border:none; margin-top:10px;" onclick="leaveGame()">Ã—</button>
    </div>

    <audio id="sound-click" src="https://actions.google.com/sounds/v1/ui/pop.ogg" preload="auto"></audio>
    <audio id="sound-win" src="https://assets.mixkit.co/active_storage/sfx/2831/2831-preview.mp3" preload="auto"></audio>
    <audio id="sound-applause" src="https://firebasestorage.googleapis.com/v0/b/prestapuce-buzz.firebasestorage.app/o/Bruitage%20-%20Ambiance%20Et%20Applaudissement.mp3?alt=media&token=4a653c7f-67c2-4cc8-b53c-c58c2dda3bbd" preload="auto"></audio>

    <script>
        // VARIABLES GLOBALES (DÃ©finies en premier pour Ã©viter les erreurs)
        const avatars = ["ðŸ¦","ðŸ¯","ðŸ¼","ðŸ¦Š","ðŸµ","ðŸ¶","ðŸ±","ðŸ¦„","ðŸ˜Ž","ðŸ¤–","ðŸ‘½","ðŸ‘¾","ðŸ‘»","ðŸ¤¡","ðŸ™","ðŸ¦‰","ðŸ¸","ðŸ¹","ðŸ°","ðŸ¥³"];
        const defaultTeamCrests = ["https://cdn-icons-png.flaticon.com/512/1165/1165187.png", "https://cdn-icons-png.flaticon.com/512/1165/1165220.png", "https://cdn-icons-png.flaticon.com/512/1165/1165191.png", "https://cdn-icons-png.flaticon.com/512/1165/1165207.png", "https://cdn-icons-png.flaticon.com/512/1065/1065545.png", "https://cdn-icons-png.flaticon.com/512/1065/1065549.png", "https://cdn-icons-png.flaticon.com/512/1065/1065553.png"];
        
        const firebaseConfig = {
            apiKey: "AIzaSyAf1Vl_O8SHJeFjHavKBJgUFGGy73I8t-o",
            authDomain: "prestapuce-buzz.firebaseapp.com",
            databaseURL: "https://prestapuce-buzz-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "prestapuce-buzz",
            storageBucket: "prestapuce-buzz.firebasestorage.app"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let roomID = "", roomRef = null, userPseudo = "", activePseudo = "", userTeamName = "Solo", userTeamIcon = "", selectedAvatar = null;
        let gameState = "waiting", currentWinner = null, isBlocked = false;
        let mjRedirectUrl = window.location.origin + window.location.pathname;
        let isEditing = false;
        let selectedTeamCrest = "";

        window.onload = () => {
            const urlParams = new URLSearchParams(window.location.search);
            const r = urlParams.get('room');
            if(r) { document.getElementById('room-code-input').value = r; validateRoom(); }
            renderAvatarGrid();
            renderTeamCrestPicker();
        };

        function validateRoom() {
            unlockAudio();
            roomID = document.getElementById('room-code-input').value.trim();
            if(!roomID) return;
            db.ref('activeRooms/' + roomID).once('value', snap => {
                if(snap.exists()) {
                    roomRef = db.ref('roomsData/' + roomID);
                    showScreen('screen-login');
                    document.getElementById('display-room-info').innerText = "SALLE " + roomID;
                    listenToTeams();
                } else alert("Salle introuvable !");
            });
        }

        function switchTeamTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.team-panel').forEach(p => p.classList.remove('active'));
            document.getElementById('tab-' + tab).classList.add('active');
            document.getElementById('panel-' + tab).classList.add('active');
        }

        function renderTeamCrestPicker() {
            const container = document.getElementById('team-crest-list');
            container.innerHTML = "";
            defaultTeamCrests.forEach(url => {
                const img = document.createElement('img');
                img.className = "team-icon-opt";
                img.src = url;
                img.onclick = () => {
                    document.querySelectorAll('.team-icon-opt').forEach(i => i.classList.remove('selected'));
                    img.classList.add('selected');
                    selectedTeamCrest = url;
                };
                if(container.children.length === 0) { img.classList.add('selected'); selectedTeamCrest = url; }
                const wrap = document.createElement('div');
                wrap.appendChild(img);
                container.appendChild(wrap);
            });
        }

        function handleTeamIconUpload(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        const canvas = document.createElement('canvas'); canvas.width = 150; canvas.height = 150;
                        const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, 150, 150);
                        selectedTeamCrest = canvas.toDataURL('image/jpeg', 0.7);
                        document.querySelectorAll('.team-icon-opt').forEach(i => i.classList.remove('selected'));
                        alert("Image chargÃ©e !");
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        }

        function createNewTeam() {
            if (!roomRef) return alert("Erreur : Vous n'Ãªtes pas connectÃ© Ã  la salle.");
            const teamName = document.getElementById('new-team-name').value.trim();
            if(teamName.length < 2) return alert("Nom d'Ã©quipe trop court !");
            
            roomRef.child('teams/' + teamName).once('value', snap => {
                if(snap.exists()) {
                    alert("Ce nom d'Ã©quipe existe dÃ©jÃ  !");
                } else {
                    const icon = selectedTeamCrest || defaultTeamCrests[0];
                    roomRef.child('teams/' + teamName).set({ icon: icon }).then(() => {
                        alert("Ã‰quipe crÃ©Ã©e !");
                        
                        // MISE A JOUR IMMEDIATE VARIABLES LOCALES
                        userTeamName = teamName;
                        userTeamIcon = icon;
                        updateTeamDisplay(userTeamName, userTeamIcon);

                        // UI RESET
                        document.getElementById('new-team-name').value = "";
                        switchTeamTab('join');
                        
                        // SÃ©lectionner automatiquement dans le drop down
                        setTimeout(() => {
                            const select = document.getElementById('select-team');
                            for (let i = 0; i < select.options.length; i++) {
                                if (select.options[i].text === teamName) { select.selectedIndex = i; break; }
                            }
                        }, 500);
                    });
                }
            });
        }

        function editProfile() {
            isEditing = true;
            document.getElementById('input-pseudo').value = activePseudo; 
            document.getElementById('btn-edit-container').style.display = 'none';
            showScreen('screen-login');
        }

        function checkPseudo() {
            unlockAudio();
            userPseudo = document.getElementById('input-pseudo').value.trim();
            if(userPseudo.length < 2) return;
            if(isEditing && userPseudo === activePseudo) { showScreen('screen-setup'); return; }

            roomRef.child('isGuestRoom').once('value', guestSnap => {
                const isGuestRoom = guestSnap.val() === true;
                roomRef.child('scores/' + userPseudo).once('value', snap => {
                    const data = snap.val();
                    if(data) {
                        if(data.kicked === true) { alert("Ce pseudo est banni."); return; }
                        if(!isEditing) {
                            if(confirm("Reprendre votre partie ?")) {
                                selectedAvatar = data.avatar;
                                userTeamName = data.teamName || "Solo";
                                userTeamIcon = data.teamIcon || "";
                                activePseudo = userPseudo; 
                                roomRef.child('scores/' + userPseudo).update({ active: true }).then(() => { startBuzzer(); });
                            } else showScreen('screen-setup');
                        } else { alert("Ce pseudo est dÃ©jÃ  pris."); }
                    } else {
                        roomRef.child('scores').once('value', scoresSnap => {
                            if(isGuestRoom && scoresSnap.numChildren() >= 10 && !isEditing) { alert("ðŸ”’ Mode DÃ©couverte : Limite atteinte."); return; }
                            showScreen('screen-setup');
                        });
                    }
                });
            });
        }

        function handleFileUpload(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                const validImageTypes = ['image/jpeg', 'image/png', 'image/webp', 'image/jpg'];
                if (!validImageTypes.includes(file.type)) { alert("Image invalide."); input.value = ""; return; }
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        const canvas = document.createElement('canvas'); canvas.width = 150; canvas.height = 150;
                        const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, 150, 150);
                        selectedAvatar = canvas.toDataURL('image/jpeg', 0.7);
                        renderAvatarGrid(selectedAvatar);
                        checkFinalBtn();
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        }

        function renderAvatarGrid(customImg = null) {
            const grid = document.getElementById('avatar-grid');
            grid.innerHTML = `<div class="avatar-item" style="background:var(--primary-color); color:white; font-weight:bold; display:flex; align-items:center; justify-content:center;" onclick="document.getElementById('file-input').click()"><span style="font-size:2rem;">+</span><input type="file" id="file-input" accept=".jpg,.jpeg,.png,.webp,image/*,application/octet-stream" style="display:none" onchange="handleFileUpload(this)"></div>`;
            if(customImg) {
                const div = document.createElement('div'); div.className = 'avatar-item selected'; div.innerHTML = `<img src="${customImg}">`;
                div.onclick = () => { selectedAvatar = customImg; renderAvatarGrid(customImg); checkFinalBtn(); };
                grid.appendChild(div);
            }
            avatars.forEach(a => {
                const div = document.createElement('div'); div.className = 'avatar-item' + (selectedAvatar === a ? ' selected' : ''); div.innerText = a;
                div.onclick = () => { selectedAvatar = a; renderAvatarGrid(customImg); checkFinalBtn(); };
                grid.appendChild(div);
            });
        }

        function checkFinalBtn() {
            const btn = document.getElementById('btn-final');
            if(selectedAvatar) btn.classList.remove('btn-disabled');
            else btn.classList.add('btn-disabled');
        }

        function onTeamSelectChange() {
            const val = document.getElementById('select-team').value.split('|');
            userTeamName = val[0]; userTeamIcon = val[1] || "";
            updateTeamDisplay(userTeamName, userTeamIcon);
        }

        function finalizeSetup() {
            if(!selectedAvatar) return alert("Choisis ton avatar d'abord !");
            unlockAudio();
            
            const val = document.getElementById('select-team').value.split('|');
            // Si on vient de crÃ©er une Ã©quipe, userTeamName est dÃ©jÃ  set correctement via createNewTeam
            // Sinon on prend la valeur du select
            if(!userTeamName || userTeamName === "Solo") {
                userTeamName = val[0]; userTeamIcon = val[1] || "";
            }
            
            const newPseudo = document.getElementById('input-pseudo').value.trim();

            if (isEditing && activePseudo && activePseudo !== newPseudo) {
                roomRef.child('scores/' + activePseudo).once('value', snap => {
                    let oldData = snap.val() || {};
                    let currentPts = oldData.pts || 0;
                    roomRef.child('scores/' + newPseudo).set({
                        pts: currentPts, avatar: selectedAvatar, teamName: userTeamName, teamIcon: userTeamIcon, active: true, kicked: false
                    }).then(() => {
                        roomRef.child('scores/' + activePseudo).remove();
                        activePseudo = newPseudo; userPseudo = newPseudo; isEditing = false; startBuzzer();
                    });
                });
            } else {
                roomRef.child('scores/' + newPseudo).once('value', snap => {
                    let currentPts = 0;
                    if(snap.exists()) currentPts = snap.val().pts || 0;
                    roomRef.child('scores/' + newPseudo).set({ 
                        pts: currentPts, avatar: selectedAvatar, teamName: userTeamName, teamIcon: userTeamIcon, active: true, kicked: false
                    }).then(() => {
                        activePseudo = newPseudo; userPseudo = newPseudo; isEditing = false; startBuzzer();
                    });
                });
            }
        }

        const updateTeamDisplay = (name, icon) => {
            const teamLabel = document.getElementById('display-team-label');
            if (name && name !== "Solo" && name !== "") {
                const iconHtml = (icon && icon !== "") ? `<img src="${icon}" style="height:15px; vertical-align:middle; margin-right:5px; background:white; border-radius:3px; padding:1px;">` : "";
                teamLabel.innerHTML = `${iconHtml}${name}`;
            } else teamLabel.innerText = "Mode Solo";
        };

        function startBuzzer() {
            if (roomRef) {
                roomRef.off(); roomRef.child('mjLink').off(); roomRef.child('gameState').off(); roomRef.child('buzzers').off();
                if (activePseudo) {
                    roomRef.child('scores/' + activePseudo + '/pts').off();
                    roomRef.child('scores/' + activePseudo + '/kicked').off();
                    roomRef.child('blockedPlayers/' + activePseudo).off();
                }
            }

            const container = document.getElementById('display-avatar-container');
            container.style.display = "flex";
            if(selectedAvatar && selectedAvatar.startsWith('data:image')) container.innerHTML = `<img src="${selectedAvatar}" style="width:100%; height:100%; object-fit:cover;">`;
            else container.innerText = selectedAvatar || "ðŸ‘¤";
            document.getElementById('display-pseudo').innerText = activePseudo;
            document.getElementById('btn-edit-container').style.display = 'inline-block';

            updateTeamDisplay(userTeamName, userTeamIcon);
            if(selectedAvatar && selectedAvatar.startsWith('data:image')) document.getElementById('buzzer-img-placeholder').innerHTML = `<img src="${selectedAvatar}" class="buzzer-img">`;
            showScreen('screen-buzzer');
            
            roomRef.child('mjLink').on('value', snap => { if(snap.val()) mjRedirectUrl = snap.val(); });
            roomRef.on('value', snap => { if(snap.val() === null) { alert("La session a Ã©tÃ© clÃ´turÃ©e par l'animateur.\nMerci d'avoir jouÃ© !"); window.location.href = mjRedirectUrl; } });
            roomRef.child('scores/' + activePseudo + '/pts').on('value', snap => { document.getElementById('score').innerText = snap.val() || 0; });
            roomRef.child('scores/' + activePseudo).on('value', snap => { const d = snap.val(); if(d) { userTeamName = d.teamName || "Solo"; userTeamIcon = d.teamIcon || ""; updateTeamDisplay(userTeamName, userTeamIcon); } });
            roomRef.child('gameState').on('value', snap => { if(snap.val() && snap.val().status === 'endGame') handleEndGame(); else { gameState = snap.val() ? snap.val().status : 'waiting'; updateUI(); } });
            roomRef.child('buzzers').on('value', snap => { const val = snap.val(); if (val && val.pseudo === activePseudo && currentWinner !== activePseudo) document.getElementById('sound-win').play().catch(()=>{}); currentWinner = val ? val.pseudo : null; updateUI(); });
            roomRef.child('scores/' + activePseudo + '/kicked').on('value', snap => { if(snap.exists() && snap.val() === true) { alert("Vous avez Ã©tÃ© expulsÃ© de la partie par le MJ."); window.location.href = mjRedirectUrl; } });
            roomRef.child('blockedPlayers/' + activePseudo).on('value', snap => { isBlocked = snap.exists(); updateUI(); });
        }

        function onBuzzerClick(event) {
            if(event) event.preventDefault();
            document.getElementById('sound-click').play().catch(()=>{});
            if(gameState === "ready" && !currentWinner && !isBlocked) {
                roomRef.child('gameState').update({ status: 'taken' });
                roomRef.child('buzzers').set({ pseudo: activePseudo, avatar: selectedAvatar, teamName: userTeamName, teamIcon: userTeamIcon });
            }
        }

        function updateUI() {
            const c = document.getElementById('screen-buzzer'); const l = document.getElementById('label');
            c.classList.remove('ready', 'main-prise', 'blocked');
            if (currentWinner) { if(currentWinner === activePseudo) { c.classList.add('main-prise'); l.innerText = "C'EST Ã€ TOI !"; } else { c.classList.add('blocked'); l.innerText = "OCCUPÃ‰"; } } 
            else if (isBlocked) { c.classList.add('blocked'); l.innerText = "BLOQUÃ‰"; }
            else if (gameState === 'ready') { c.classList.add('ready'); l.innerText = "BUZZEZ !"; }
            else { l.innerText = "ATTENDEZ"; }
        }

        function handleEndGame() {
            const pZone = document.getElementById('podium-zone'); pZone.style.display = "flex";
            roomRef.child('scores').once('value', snap => {
                const leaderboard = Object.keys(snap.val() || {}).map(p => ({ name: p, pts: snap.val()[p].pts })).sort((a, b) => b.pts - a.pts);
                const rank = leaderboard.findIndex(e => e.name === activePseudo) + 1;
                let content = "";
                if(rank === 1) { content = `<img src="https://cdn-icons-png.flaticon.com/512/2583/2583344.png" class="trophy-img animate-zoom"><h1 style="color:gold;">CHAMPION !</h1>`; document.getElementById('sound-applause').play().catch(()=>{}); confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 }, zIndex: 20000 }); } 
                else if (rank === 2) { content = `<img src="https://cdn-icons-png.flaticon.com/512/2583/2583319.png" class="trophy-img"><h1 style="color:silver;">2Ã¨me PLACE</h1>`; } 
                else if (rank === 3) { content = `<img src="https://cdn-icons-png.flaticon.com/512/2583/2583434.png" class="trophy-img"><h1 style="color:#cd7f32;">3Ã¨me PLACE</h1>`; } 
                else { content = `<h1 style="color:white;">${rank}Ã¨me PLACE</h1><p>Merci d'avoir jouÃ© !</p>`; }
                pZone.innerHTML = `${content}<button onclick="window.location.href='${mjRedirectUrl}'" class="btn-ui" style="margin-top:20px;">RETOUR</button>`;
            });
        }

        function leaveGame() {
            if(confirm("Quitter la partie ?\n\nSachez que vous pourrez revenir avec le mÃªme appareil et le mÃªme pseudo pour rÃ©cupÃ©rer votre score !")) {
                if(roomRef && activePseudo) { roomRef.child('scores/' + activePseudo).update({ active: false }).then(() => { window.location.href = mjRedirectUrl; }); } else location.reload();
            }
        }

        function unlockAudio() { ['sound-click', 'sound-win', 'sound-applause'].forEach(id => { const el = document.getElementById(id); el.play().then(() => { el.pause(); el.currentTime = 0; }).catch(()=>{}); }); }
        function showScreen(id) { document.querySelectorAll('.screen').forEach(s => s.classList.remove('active-screen')); document.getElementById(id).classList.add('active-screen'); }
        function listenToTeams() {
            roomRef.child('teams').on('value', snap => {
                const select = document.getElementById('select-team');
                const currentVal = select.value;
                select.innerHTML = '<option value="Solo|">Mode Solo</option>';
                snap.forEach(child => {
                    const opt = document.createElement('option');
                    opt.value = child.key + "|" + child.val().icon;
                    opt.innerText = child.key;
                    select.appendChild(opt);
                });
                if(currentVal) {
                    let exists = false;
                    for(let i=0; i<select.options.length; i++) { if(select.options[i].value === currentVal) exists = true; }
                    if(exists) select.value = currentVal;
                }
            });
        }
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Presta'Puce - Blind Test</title>
    <link rel="icon" type="image/png" href="https://static.wixstatic.com/media/eda9e4_e7ab6af2d5a7428f9bc7e4af454e20ef~mv2.png">
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
    <style>
        :root { --primary-color: #3498db; --bg-color: #1a1a1a; --card-bg: #2c3e50; --text-color: #ffffff; --accent-color: #f1c40f; }
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Segoe UI', sans-serif; background-color: var(--bg-color); color: var(--text-color); overflow: hidden; }
        .header-bar { position: absolute; top: 0; left: 0; width: 100%; height: 95px; background: rgba(0,0,0,0.85); display: flex; align-items: center; justify-content: space-between; padding: 0 15px; box-sizing: border-box; border-bottom: 2px solid rgba(255,255,255,0.1); z-index: 1000; }
        .logo-presta { width: 45px; height: auto; -webkit-tap-highlight-color: transparent; }
        .screen { display: none; height: 100%; width: 100%; flex-direction: column; justify-content: center; align-items: center; padding: 20px; padding-top: 100px; box-sizing: border-box; }
        .active-screen { display: flex !important; }
        input, select { width: 100%; max-width: 280px; padding: 15px; margin-bottom: 20px; border-radius: 12px; border: 2px solid rgba(255,255,255,0.1); font-size: 1.1rem; background: var(--card-bg); color: white; text-align: center; outline: none; }
        .btn-ui { width: 100%; max-width: 280px; padding: 18px; border-radius: 15px; border: none; font-size: 1.2rem; font-weight: 900; cursor: pointer; background-color: var(--primary-color); color: white; box-shadow: 0 8px 0 #2980b9; text-transform: uppercase; margin-bottom: 10px; }
        .btn-disabled { background-color: #7f8c8d !important; box-shadow: 0 8px 0 #636e72 !important; cursor: not-allowed; opacity: 0.6; }
        .avatar-scroll { width: 100%; max-width: 320px; max-height: 200px; overflow-y: auto; margin-bottom: 20px; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 20px; }
        .avatar-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .avatar-item { font-size: 2rem; background: var(--card-bg); padding: 10px; border-radius: 15px; cursor: pointer; border: 3px solid transparent; text-align: center; }
        .avatar-item.selected { border-color: var(--accent-color); transform: scale(1.1); background: rgba(241, 196, 15, 0.2); }
        .buzzer { width: 65vw; height: 65vw; max-width: 250px; max-height: 250px; border-radius: 50%; border: none; cursor: pointer; background: #e74c3c; box-shadow: 0 15px 0 #c0392b; position: relative; }
        .ready .buzzer { background: #2ecc71; box-shadow: 0 15px 0 #27ae60; }
        .main-prise .buzzer { background: #3498db !important; box-shadow: 0 15px 0 #2980b9 !important; }
        .blocked .buzzer { background: #555 !important; box-shadow: 0 15px 0 #333 !important; opacity: 0.6; }
        .btn-exit { width: 45px; height: 45px; border-radius: 50%; background: #e74c3c; border: none; color: white; font-size: 1.5rem; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(0,0,0,0.3); margin-top: 15px; }
    </style>
</head>
<body>
    <div class="header-bar">
        <div style="flex:1; line-height: 1.2;">
            <span id="display-avatar" style="font-size:1.5rem"></span> 
            <span id="display-pseudo" style="font-weight: bold;"></span><br>
            <span id="display-team-label" style="font-size: 0.8rem; color: var(--accent-color); font-style: italic;"></span>
        </div>
        <div style="flex:0; padding: 0 10px;">
            <a href="https://tapni.com/app/djcedrik" target="_blank">
                <img src="https://static.wixstatic.com/media/eda9e4_e7ab6af2d5a7428f9bc7e4af454e20ef~mv2.png" class="logo-presta">
            </a>
        </div>
        <div style="flex:1; text-align:right" id="display-room-info"></div>
    </div>

    <div id="screen-room" class="screen active-screen">
        <h2 style="color:var(--accent-color)">CODE SALLE</h2>
        <input type="number" id="room-code-input" placeholder="CODE SALLE" onkeypress="if(event.key === 'Enter') validateRoom()">
        <button class="btn-ui" onclick="validateRoom()">Rejoindre</button>
    </div>

    <div id="screen-login" class="screen">
        <h2 style="color:var(--accent-color)">TON PSEUDO</h2>
        <input type="text" id="input-pseudo" placeholder="Pseudo..." maxlength="12" onkeypress="if(event.key === 'Enter') checkPseudo()">
        <button class="btn-ui" onclick="checkPseudo()">Suivant</button>
    </div>

    <div id="screen-setup" class="screen">
        <h3 style="margin:0 0 10px 0;">CHOISIS TON AVATAR</h3>
        <div class="avatar-scroll"><div class="avatar-grid" id="avatar-grid"></div></div>
        <h3 style="margin:0 0 10px 0;">TON Ã‰QUIPE</h3>
        <select id="select-team"><option value="Solo|">Mode Solo</option></select>
        <button id="btn-final" class="btn-ui btn-disabled" onclick="finalizeSetup()">C'est parti !</button>
    </div>

    <div id="screen-buzzer" class="screen">
        <div style="flex:1; display:flex; align-items:center;">
            <button class="buzzer" id="btn-buzz" onclick="onBuzzerClick()">
                <span id="label" style="color:white; font-size:1.4rem; font-weight:bold;">ATTENDEZ</span>
            </button>
        </div>
        <div style="font-weight: bold;">Score : <span id="score" style="color:var(--accent-color)">0</span> pts</div>
        <button class="btn-exit" onclick="leaveGame()">Ã—</button>
    </div>

    <audio id="buzz-sound" src="https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.mp3" preload="auto"></audio>

    <script>
        const firebaseConfig = { databaseURL: "https://prestapuce-buzz-default-rtdb.europe-west1.firebasedatabase.app/" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let roomID = "", roomRef = null, userPseudo = "", userTeamName = "Solo", userTeamIcon = "", selectedAvatar = null;
        let gameState = "waiting", isBlockedLocally = false, currentWinner = null;
        const avatars = ["ðŸ¦","ðŸ¯","ðŸ¼","ðŸ¦Š","ðŸµ","ðŸ¶","ðŸ±","ðŸ¦„","ðŸ˜Ž","ðŸ¤–","ðŸ‘½","ðŸ‘¾","ðŸ‘»","ðŸ¤¡","ðŸ™","ðŸ¦‰","ðŸ¸","ðŸ¹","ðŸ°","ðŸ¥³"];

        function validateRoom() {
            roomID = document.getElementById('room-code-input').value.trim();
            if(!roomID) return;
            db.ref('activeRooms/' + roomID).once('value', snap => {
                if(snap.exists()) {
                    roomRef = db.ref('roomsData/' + roomID);
                    showScreen('screen-login');
                    document.getElementById('display-room-info').innerText = "SALLE " + roomID;
                    listenToTeams();
                } else { alert("Salle introuvable !"); }
            });
        }

        function checkPseudo() {
            userPseudo = document.getElementById('input-pseudo').value.trim();
            if(userPseudo.length < 2) return alert("Pseudo trop court !");
            roomRef.child('scores/' + userPseudo).once('value', snap => {
                if(snap.exists() && localStorage.getItem('presta_pseudo') !== userPseudo) {
                    alert("Ce pseudo est dÃ©jÃ  utilisÃ© !");
                } else { showScreen('screen-setup'); }
            });
        }

        function listenToTeams() {
            roomRef.child('teams').on('value', snap => {
                const select = document.getElementById('select-team');
                select.innerHTML = '<option value="Solo|">Mode Solo</option>';
                snap.forEach(child => {
                    const opt = document.createElement('option');
                    opt.value = child.key + "|" + child.val().icon;
                    opt.innerText = child.key;
                    select.appendChild(opt);
                });
            });
        }

        function initAvatarGrid() {
            const grid = document.getElementById('avatar-grid');
            avatars.forEach(a => {
                const div = document.createElement('div');
                div.className = 'avatar-item'; div.innerText = a;
                div.onclick = () => {
                    document.querySelectorAll('.avatar-item').forEach(i => i.classList.remove('selected'));
                    div.classList.add('selected'); selectedAvatar = a;
                    document.getElementById('btn-final').classList.remove('btn-disabled');
                };
                grid.appendChild(div);
            });
        }

        function finalizeSetup() {
            if(!selectedAvatar) return;
            const val = document.getElementById('select-team').value.split('|');
            userTeamName = val[0] || "Solo"; userTeamIcon = val[1] || "";
            localStorage.setItem('presta_pseudo', userPseudo);
            roomRef.child('scores/' + userPseudo).set({ 
                pts: 0, avatar: selectedAvatar, teamName: userTeamName, teamIcon: userTeamIcon, active: true 
            });
            startBuzzer();
        }

        function startBuzzer() {
            document.getElementById('display-pseudo').innerText = userPseudo;
            document.getElementById('display-avatar').innerText = selectedAvatar;
            document.getElementById('display-team-label').innerText = (userTeamName === "Solo") ? "Mode Solo" : userTeamName;
            showScreen('screen-buzzer');
            roomRef.child('scores/' + userPseudo).on('value', s => { if(s.exists()) document.getElementById('score').innerText = s.val().pts; });
            roomRef.child('blockedPlayers/' + userPseudo).on('value', snap => { isBlockedLocally = snap.exists(); updateUI(); });
            roomRef.child('gameState').on('value', snap => { gameState = snap.val() ? snap.val().status : 'waiting'; updateUI(); });
            roomRef.child('buzzers').on('value', snap => { currentWinner = snap.val() ? snap.val().pseudo : null; updateUI(); });
        }

        function onBuzzerClick() {
            if(gameState === "ready" && !isBlockedLocally && !currentWinner) {
                if (navigator.vibrate) navigator.vibrate([100, 50, 100]);
                const sound = document.getElementById('buzz-sound');
                sound.currentTime = 0;
                sound.play().catch(e => {});
                roomRef.child('gameState').update({ status: 'taken' });
                roomRef.child('buzzers').set({ pseudo: userPseudo, avatar: selectedAvatar, teamName: userTeamName, teamIcon: userTeamIcon });
            }
        }

        function leaveGame() {
            if(confirm("Quitter la partie ? Vos points seront conservÃ©s.")) {
                roomRef.child('blockedPlayers/' + userPseudo).remove();
                roomRef.child('scores/' + userPseudo).update({ 
                    active: false,
                    lastTeam: userTeamName,
                    teamName: (userTeamName === "Solo") ? "Solo" : "", // On vide l'Ã©quipe pour le compteur MJ
                    teamIcon: (userTeamName === "Solo") ? "" : "",
                    avatar: "ðŸ‘»" 
                });
                localStorage.removeItem('presta_pseudo');
                location.reload();
            }
        }

        function updateUI() {
            const c = document.getElementById('screen-buzzer'); const l = document.getElementById('label');
            c.classList.remove('ready', 'main-prise', 'blocked');
            if(isBlockedLocally) { c.classList.add('blocked'); l.innerText = "BLOQUÃ‰"; }
            else if (currentWinner) {
                if(currentWinner === userPseudo) { c.classList.add('main-prise'); l.innerText = "C'EST Ã€ TOI !"; }
                else { l.innerText = "OCCUPÃ‰"; }
            } else if(gameState === 'ready') { c.classList.add('ready'); l.innerText = "BUZZEZ !"; }
            else { l.innerText = "ATTENDEZ"; }
        }

        function showScreen(id) { document.querySelectorAll('.screen').forEach(s => s.classList.remove('active-screen')); document.getElementById(id).classList.add('active-screen'); }
        initAvatarGrid();
    </script>
</body>
</html>